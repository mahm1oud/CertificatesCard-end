import{r as Q,j as e,C as o,s as m,t as u,v as T,d as x,o as k,a as I,h as U,q as B,b as h,i as H,c as g,B as p,l as v,g as j}from"./index-DoMHCGG2.js";import"./ReactKonvaCore-0IBzjN_D.js";import{T as M,a as O,b as f,c as b}from"./tabs-CKJmMpcu.js";import"./form-DyTRWEbF.js";import"./input-COMsjQRu.js";import"./select-CRu623qS.js";import"./slider-ef3OeGSW.js";import{A as N}from"./arrow-left-BN8mgSLP.js";import{S as R}from"./save-CRRscGsZ.js";import"./label-DSWK9Bhr.js";import"./index-BdQq_4o_.js";import"./chevron-up-DgjV3eGa.js";const V=({templateId:i,readOnly:w=!1})=>{const[a,n]=Q.useState("preview");return e.jsxs("div",{className:"advanced-template-editor p-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("h1",{className:"text-2xl font-bold",children:"محرر القوالب المتقدم"})}),e.jsxs(M,{value:a,onValueChange:n,className:"w-full",children:[e.jsxs(O,{className:"grid grid-cols-3",children:[e.jsx(f,{value:"preview",children:"معاينة القالب"}),e.jsx(f,{value:"fields",children:"الحقول"}),e.jsx(f,{value:"settings",children:"إعدادات القالب"})]}),e.jsx(b,{value:"preview",className:"mt-4",children:e.jsxs(o,{children:[e.jsxs(m,{children:[e.jsx(u,{children:"معاينة القالب"}),e.jsx(T,{children:"انظر إلى النسخة المصلحة في AdvancedTemplateEditor-fixed.tsx"})]}),e.jsx(x,{children:e.jsx("p",{children:"تم نقل هذا المكون إلى مكون آخر لإصلاح المشاكل النحوية"})})]})}),e.jsx(b,{value:"fields",className:"mt-4",children:e.jsxs(o,{children:[e.jsx(m,{children:e.jsx(u,{children:"الحقول"})}),e.jsx(x,{children:e.jsx("p",{children:"تم نقل هذا المكون إلى مكون آخر لإصلاح المشاكل النحوية"})})]})}),e.jsx(b,{value:"settings",className:"mt-4",children:e.jsxs(o,{children:[e.jsx(m,{children:e.jsx(u,{children:"إعدادات القالب"})}),e.jsx(x,{children:e.jsx("p",{children:"تم نقل هذا المكون إلى مكون آخر لإصلاح المشاكل النحوية"})})]})})]})]})},te=()=>{const{id:i}=k(),[w,a]=I(),{toast:n}=U(),d=B(),{data:r,isLoading:C,error:q}=h({queryKey:[i?`/api/templates/${i}`:null],queryFn:j({on401:"redirect-to-login"}),enabled:!!i}),{data:E=[],isLoading:$}=h({queryKey:[i?`/api/templates/${i}/fields`:null],queryFn:j({on401:"redirect-to-login"}),enabled:!!i}),{data:F=[]}=h({queryKey:["/api/categories"],queryFn:j({on401:"returnNull"})}),c=H({mutationFn:async({templateData:s,fieldsData:t})=>{const A=s.id?`/api/templates/${s.id}`:"/api/templates",l=await v(s.id?"PATCH":"POST",A,s);if(l&&l.id){const y=l.id,K=t.map(P=>({...P,templateId:y}));await v("PUT",`/api/templates/${y}/fields`,K)}return l},onSuccess:s=>{s&&s.id&&(d.invalidateQueries({queryKey:[`/api/templates/${s.id}`]}),d.invalidateQueries({queryKey:[`/api/templates/${s.id}/fields`]}),d.invalidateQueries({queryKey:["/api/templates"]})),n({title:"تم الحفظ بنجاح",description:`تم حفظ القالب ${(s==null?void 0:s.title)||""} بنجاح`}),!i&&(s!=null&&s.id)&&a(`/template-editor-unified/${s.id}`)},onError:s=>{n({title:"خطأ في الحفظ",description:(s==null?void 0:s.message)||"حدث خطأ أثناء حفظ القالب",variant:"destructive"})}}),L=(s,t)=>{c.mutate({templateData:s,fieldsData:t})},S=s=>{const t=document.createElement("a");t.download=`template-${(r==null?void 0:r.id)||"new"}.png`,t.href=s,document.body.appendChild(t),t.click(),document.body.removeChild(t),n({title:"تم تصدير الصورة",description:"تم تصدير صورة القالب بنجاح"})};return C||$?e.jsx("div",{className:"container mx-auto py-8 flex items-center justify-center h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx(g,{className:"w-10 h-10 animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"جاري تحميل بيانات القالب..."})]})}):q&&i?e.jsx("div",{className:"container mx-auto py-8",children:e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-md p-4 text-center",children:[e.jsx("p",{className:"text-red-500 mb-2",children:"حدث خطأ أثناء تحميل بيانات القالب"}),e.jsxs(p,{variant:"outline",onClick:()=>a("/templates"),children:[e.jsx(N,{className:"w-4 h-4 ml-2"}),"العودة إلى القوالب"]})]})}):e.jsxs("div",{className:"container mx-auto py-8",children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsxs(p,{variant:"outline",onClick:()=>a("/templates"),children:[e.jsx(N,{className:"w-4 h-4 ml-2"}),"العودة إلى القوالب"]}),e.jsx("h1",{className:"text-2xl font-bold text-center flex-1",children:i?"تحرير القالب":"إنشاء قالب جديد"}),e.jsxs(p,{onClick:()=>{const s=document.querySelector("form");s&&s.dispatchEvent(new Event("submit",{cancelable:!0,bubbles:!0}))},disabled:c.isPending,children:[c.isPending?e.jsx(g,{className:"w-4 h-4 ml-2 animate-spin"}):e.jsx(R,{className:"w-4 h-4 ml-2"}),"حفظ القالب"]})]}),e.jsx("div",{className:"bg-white rounded-lg shadow-md p-4",children:e.jsx(V,{template:r,initialFields:E,onSave:L,onImageExport:S,categories:F})})]})};export{te as default};
