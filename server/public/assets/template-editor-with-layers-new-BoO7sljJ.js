import{n as xe,r as l,j as t,B as w,o as he,a as ue,h as ge,b as Y,R as fe,C as Q,s as J,t as ee,v as te,d as ne,c as ye,e as be,l as U}from"./index-DoMHCGG2.js";import{S as je,L as ve,R as ie,G as V,I as Ie,a as we,b as se,T as ae}from"./ReactKonvaCore-0IBzjN_D.js";import{Z as ze,a as Te}from"./zoom-out-eiDS2u6d.js";import{D as Se}from"./download-CkzZtpS5.js";import{L as Ee}from"./LayersPanelSimple--Odr3nqg.js";import{I as Le}from"./image-CRCqvbIG.js";import{S as ke}from"./save-CRRscGsZ.js";import"./scroll-area-BaWF6YIt.js";import"./index-BdQq_4o_.js";import"./layers-D3_CD2xn.js";import"./type-DWs-uHqd.js";import"./eye-Co1cENxs.js";import"./lock-6HL3vJPU.js";import"./chevron-up-DgjV3eGa.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=xe("Text",[["path",{d:"M17 6.1H3",key:"wptmhv"}],["path",{d:"M21 12.1H3",key:"1j38uz"}],["path",{d:"M15.1 18H3",key:"1nb16a"}]]),Fe=1e3,We=({templateImage:N,fields:d,onFieldsChange:G,editorSettings:x={gridEnabled:!0,snapToGrid:!0,gridSize:50,snapThreshold:10},showControls:z=!0,allowMultipleSelection:P=!0,allowResize:$=!0,onImageExport:S,selectedFieldId:T,onSelectedFieldChange:g,templateImageLayer:R=0,isTemplateImageVisible:D=!0,onTemplateImageLayerChange:K,onTemplateImageVisibilityChange:O})=>{const p=l.useRef(null),E=l.useRef(null),v=l.useRef(null),[I,f]=l.useState([]),[y,_]=l.useState({width:1e3,height:600}),[L,k]=l.useState(1),[s,i]=l.useState({x:0,y:0}),[c,b]=l.useState(null),[C,F]=l.useState(!1),[W,o]=l.useState({width:0,height:0}),[j,B]=l.useState({x:0,y:0});l.useEffect(()=>{if(!N){F(!1),b(null);return}const e=new Image;e.crossOrigin="Anonymous",e.src=N,e.onload=()=>{b(e),F(!0);const a=e.width/e.height,n=Fe,r=n/a;o({width:n,height:r}),B({x:0,y:0}),_({width:n,height:r})},e.onerror=()=>{F(!1),b(null)}},[N]);const Z=l.useMemo(()=>({id:-1,name:"template_image",label:"صورة القالب",type:"template",position:j,zIndex:R,visible:D,rotation:0,size:W}),[j,R,W,D]),oe=l.useMemo(()=>C&&c?[Z,...d]:d,[Z,d,C,c]);l.useEffect(()=>{T!==void 0&&f(T===null?[]:[T])},[T]),l.useEffect(()=>{var a;if(!v.current||!p.current)return;const e=I.map(n=>{var r;return(r=p.current)==null?void 0:r.findOne(`#field-${n}`)}).filter(Boolean);v.current.nodes(e),(a=v.current.getLayer())==null||a.batchDraw()},[I]);const re=()=>{if(!x.gridEnabled)return null;const e=x.gridSize||50,a=[];for(let n=0;n<y.height;n+=e)a.push(t.jsx(se,{points:[0,n,y.width,n],stroke:"#ddd",strokeWidth:1,dash:[4,4],listening:!1},`h-${n}`));for(let n=0;n<y.width;n+=e)a.push(t.jsx(se,{points:[n,0,n,y.height],stroke:"#ddd",strokeWidth:1,dash:[4,4],listening:!1},`v-${n}`));return a},X=(e,a)=>{const{x:n,y:r}=e.target.position(),h=d.map(u=>u.id===a?{...u,position:{x:n,y:r,snapToGrid:u.position.snapToGrid}}:u);G(h)},A=(e,a)=>{a.cancelBubble=!0;let n;if(P&&a.evt.shiftKey){n=[...I];const r=I.indexOf(e);r===-1?n.push(e):n.splice(r,1)}else n=[e];f(n),g&&n.length===1?g(n[0]):g&&n.length===0&&g(null)},H=e=>{const a=e.target,n=parseInt(a.id().split("-")[1]),r=d.find(m=>m.id===n);if(!r)return;const h={...r,position:{x:a.x(),y:a.y(),snapToGrid:r.position.snapToGrid},rotation:a.rotation()},u=d.map(m=>m.id===n?h:m);G(u)},le=(e,a)=>{if(e.visible===!1)return null;const n=e.style||{},r=n.fontSize||24,h=n.fontFamily||"Arial",u=n.fontWeight||"normal",m=n.color||"#000000",q=n.align||"center",me=n.maxWidth||300,pe=e.rotation||0;return t.jsx(V,{id:`field-${e.id}`,x:e.position.x||0,y:e.position.y||0,rotation:pe,draggable:!e.locked,onClick:M=>A(e.id,M),onTap:M=>A(e.id,M),onDragEnd:M=>X(M,e.id),onTransformEnd:H,children:t.jsx(ae,{text:e.defaultValue||e.label||e.name,fontSize:r,fontFamily:h,fontStyle:u,fill:m,align:q,width:me,wrap:"word"})},`field-${e.id}-${a}`)},de=(e,a)=>{if(e.visible===!1)return null;const n=e.style||{},r=n.imageMaxWidth||150,h=n.imageMaxHeight||150,u=e.rotation||0;return t.jsxs(V,{id:`field-${e.id}`,x:e.position.x||0,y:e.position.y||0,rotation:u,draggable:!e.locked,onClick:m=>A(e.id,m),onTap:m=>A(e.id,m),onDragEnd:m=>X(m,e.id),onTransformEnd:H,children:[t.jsx(ie,{width:r,height:h,fill:"#f0f0f0",stroke:"#ddd",strokeWidth:1,dash:[4,4]}),t.jsx(ae,{text:e.label||"صورة",fontSize:14,fill:"#666",align:"center",width:r,y:h/2-7})]},`field-${e.id}-${a}`)},ce=()=>{if(!p.current||!S)return;const e=p.current.toDataURL({pixelRatio:2,mimeType:"image/png"});S(e)};return t.jsxs("div",{className:"draggable-fields-preview",children:[t.jsxs("div",{className:"editor-controls flex justify-between items-center space-x-2 mb-4",dir:"ltr",children:[t.jsxs("div",{className:"zoom-controls flex items-center space-x-2",children:[t.jsxs(w,{variant:"outline",size:"sm",onClick:()=>k(L*1.1),children:[t.jsx(ze,{className:"h-4 w-4 mr-1"}),"تكبير"]}),t.jsxs(w,{variant:"outline",size:"sm",onClick:()=>k(L/1.1),children:[t.jsx(Te,{className:"h-4 w-4 mr-1"}),"تصغير"]}),t.jsx(w,{variant:"outline",size:"sm",onClick:()=>{k(1),i({x:0,y:0})},children:"مناسب للشاشة"})]}),t.jsx("div",{className:"export-controls",children:t.jsxs(w,{variant:"outline",size:"sm",onClick:ce,children:[t.jsx(Se,{className:"h-4 w-4 mr-1"}),"تصدير"]})})]}),t.jsx("div",{className:"editor-stage-container",style:{backgroundColor:"#f0f0f0",border:"1px solid #ddd",borderRadius:"4px",overflow:"hidden",direction:"ltr"},children:t.jsx(je,{width:y.width,height:y.height,scaleX:L,scaleY:L,x:s.x,y:s.y,ref:p,draggable:!0,onMouseDown:e=>{e.target===e.target.getStage()&&(f([]),g&&g(null))},onClick:e=>{e.target===e.currentTarget&&f([])},onWheel:e=>{e.evt.preventDefault();const a=1.05,n=p.current;if(!n)return;const r=n.scaleX(),h=n.getPointerPosition();if(!h)return;const u={x:(h.x-n.x())/r,y:(h.y-n.y())/r},m=e.evt.deltaY<0?r*a:r/a;k(m);const q={x:h.x-u.x*m,y:h.y-u.y*m};i(q)},children:t.jsxs(ve,{ref:E,children:[t.jsx(ie,{x:0,y:0,width:y.width,height:y.height,fill:"white"}),re(),oe.sort((e,a)=>(e.zIndex||0)-(a.zIndex||0)).map((e,a)=>e.type==="text"?le(e,a):e.type==="image"?de(e,a):e.type==="template"&&C&&c&&D?t.jsx(V,{id:`field-${e.id}`,children:t.jsx(Ie,{image:c,width:W.width,height:W.height,x:j.x,y:j.y,listening:!1})},"template-image-group"):null),z&&$&&t.jsx(we,{ref:v,rotateEnabled:!0,resizeEnabled:!1,boundBoxFunc:(e,a)=>a,onTransformEnd:H})]})})})]})},Ne=[{id:1,name:"name_field",label:"الاسم",type:"text",position:{x:400,y:200},style:{fontFamily:"Cairo",fontSize:24,fontWeight:"bold",color:"#000000",align:"center",maxWidth:300},zIndex:2,visible:!0,rotation:0},{id:2,name:"certificate_title",label:"شهادة تقدير",type:"text",position:{x:400,y:100},style:{fontFamily:"Cairo",fontSize:30,fontWeight:"bold",color:"#1e3a8a",align:"center",maxWidth:400},zIndex:3,visible:!0,rotation:0},{id:3,name:"date_field",label:"التاريخ",type:"text",position:{x:400,y:350},style:{fontFamily:"Cairo",fontSize:16,fontWeight:"normal",color:"#666666",align:"center",maxWidth:200},zIndex:1,visible:!0,rotation:0}],$e="https://images.unsplash.com/photo-1579546929518-9e396f3cc809?w=1080&q=80";function Ze(){const N=he(),{templateId:d}=N,[,G]=ue(),[x,z]=l.useState(d?[]:Ne),[P,$]=l.useState(null),[S,T]=l.useState(0),[g,R]=l.useState(!0),[D,K]=l.useState(d?"":$e),{toast:O}=ge(),{data:p,isLoading:E}=Y({queryKey:["template",d],queryFn:async()=>{if(!d)return null;console.log("Fetching template with ID:",d);const s=await U("GET",`/api/templates/${d}`);return console.log("Template data received:",s),s},enabled:!!d}),{data:v,isLoading:I}=Y({queryKey:["template-fields",d],queryFn:async()=>{if(!d)return[];console.log("Fetching template fields for template ID:",d);try{const s=await U("GET",`/api/templates/${d}/fields`);return console.log("Template fields received:",s),s}catch(s){console.error("Error fetching template fields:",s);try{const i=await U("GET",`/api/templates/${d}/public-fields`);return console.log("Template fields received from fallback API:",i),i}catch(i){return console.error("Error fetching template fields from fallback API:",i),[]}}},enabled:!!d});l.useEffect(()=>{if(p&&!E&&(p.imageUrl&&K(p.imageUrl),console.log("تم تحميل القالب:",p)),v&&!I){const s=v.map(i=>({id:i.id,name:i.name,label:i.label||i.name||"",type:i.type||"text",position:i.position||{x:200,y:200},style:i.style||{fontFamily:"Cairo",fontSize:24,fontWeight:"normal",color:"#000000",align:"center",maxWidth:300},zIndex:i.zIndex||1,visible:i.visible!==!1,rotation:i.rotation||0}));z(s),console.log("تم تحميل الحقول:",s)}},[p,v,E,I]);const f=fe.useMemo(()=>[{id:-1,name:"template_image",label:"صورة القالب",type:"template",zIndex:S,visible:g},...x].sort((i,c)=>(i.zIndex||0)-(c.zIndex||0)),[x,S,g]),y=s=>{const i=x.length>0?Math.max(...x.map(b=>b.id)):0,c={id:i+1,name:s==="text"?`text_field_${i+1}`:`image_field_${i+1}`,label:s==="text"?"نص جديد":"صورة جديدة",type:s,position:{x:400,y:200},style:s==="text"?{fontFamily:"Cairo",fontSize:24,fontWeight:"normal",color:"#000000",align:"center",maxWidth:300}:{fontFamily:"Arial",fontSize:0,fontWeight:"normal",color:"#000000",align:"center",maxWidth:300,imageMaxWidth:150,imageMaxHeight:150},zIndex:Math.max(...x.map(b=>b.zIndex||0),0)+1,visible:!0,rotation:0};z([...x,c]),$(c.id),O({title:"تم إضافة حقل جديد",description:`تم إضافة حقل ${s==="text"?"نصي":"صورة"} جديد`})},_=(s,i)=>{const c=[...f],[b]=c.splice(s,1);c.splice(i,0,b);const C=c.map((o,j)=>({...o,zIndex:j})),F=C.find(o=>o.id===-1);F&&T(F.zIndex||0);const W=C.filter(o=>o.id!==-1).map(o=>{const j=x.find(B=>B.id===o.id);return j?{...j,zIndex:o.zIndex}:x[0]?{...x[0],id:o.id,name:o.name||"field",label:o.label||"حقل",type:o.type||"text",position:{x:0,y:0},style:{fontFamily:"Cairo",fontSize:24,fontWeight:"normal",color:"#000000",align:"center",maxWidth:300},zIndex:o.zIndex||0,visible:o.visible!==void 0?o.visible:!0,rotation:0}:{id:o.id||1,name:o.name||"field",label:o.label||"حقل",type:o.type||"text",position:{x:0,y:0},style:{fontFamily:"Cairo",fontSize:24,fontWeight:"normal",color:"#000000",align:"center",maxWidth:300},zIndex:o.zIndex||0,visible:o.visible!==void 0?o.visible:!0,rotation:0}});z(W)},L=s=>{s===-1?R(!g):z(x.map(i=>i.id===s?{...i,visible:i.visible===!1}:i))},k=s=>{const i=document.createElement("a");i.download=`template-${Date.now()}.png`,i.href=s,document.body.appendChild(i),i.click(),document.body.removeChild(i),O({title:"تم تصدير الصورة",description:"تم تصدير الصورة بنجاح"})};return t.jsxs("div",{className:"template-editor-page p-4",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx(w,{variant:"outline",onClick:()=>G("/admin/templates"),children:"الرجوع للقوالب"}),t.jsx("h1",{className:"text-2xl font-bold",children:E?"جاري التحميل...":p?p.titleAr||p.title:"محرر القوالب مع دعم الطبقات"})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsxs(w,{variant:"outline",onClick:()=>y("text"),children:[t.jsx(Ce,{className:"mr-2 h-4 w-4"}),"إضافة نص"]}),t.jsxs(w,{variant:"outline",onClick:()=>y("image"),children:[t.jsx(Le,{className:"mr-2 h-4 w-4"}),"إضافة صورة"]}),t.jsxs(w,{variant:"default",children:[t.jsx(ke,{className:"mr-2 h-4 w-4"}),"حفظ"]})]})]}),t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-4",children:[t.jsx("div",{className:"lg:col-span-1",children:t.jsxs(Q,{children:[t.jsxs(J,{children:[t.jsx(ee,{children:"الطبقات"}),t.jsx(te,{children:"إدارة ترتيب ورؤية الطبقات"})]}),t.jsx(ne,{children:t.jsx(Ee,{layers:f,selectedLayerId:P,onLayerSelect:$,onLayerVisibilityToggle:L,onMoveLayerUp:s=>{const i=f.findIndex(c=>c.id===s);i>0&&_(i,i-1)},onMoveLayerDown:s=>{const i=f.findIndex(c=>c.id===s);i<f.length-1&&_(i,i+1)}})})]})}),t.jsx("div",{className:"lg:col-span-3",children:t.jsxs(Q,{children:[t.jsxs(J,{children:[t.jsx(ee,{children:"معاينة القالب"}),t.jsx(te,{children:"يمكنك سحب العناصر لتغيير مواضعها في القالب"})]}),t.jsx(ne,{children:E||I?t.jsxs("div",{className:"flex flex-col items-center justify-center p-8 space-y-4",children:[t.jsx(ye,{className:"w-8 h-8 animate-spin text-primary"}),t.jsx("p",{children:"جاري تحميل بيانات القالب..."})]}):t.jsx(We,{templateImage:D,fields:x,onFieldsChange:s=>z(s),selectedFieldId:P,onSelectedFieldChange:$,onImageExport:k,templateImageLayer:S,isTemplateImageVisible:g,onTemplateImageLayerChange:T,onTemplateImageVisibilityChange:R,editorSettings:{gridEnabled:!0,snapToGrid:!0,gridSize:50,snapThreshold:10}})}),t.jsx(be,{children:t.jsxs("div",{className:"text-sm text-muted-foreground",children:[t.jsx("strong",{children:"نصيحة:"})," يمكنك تغيير ترتيب الطبقات من اللوحة الجانبية لوضع العناصر أمام أو خلف صورة القالب"]})})]})})]})]})}export{Ze as default};
