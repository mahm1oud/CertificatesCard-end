import{o as D,a as R,h as A,b as N,r as L,j as e,B as f,p as P,l as S,g as C}from"./index-DoMHCGG2.js";import{C as O,W as h,R as T,E as U,G as B,a as G}from"./ramadan-form-BGgFOXsp.js";import"./label-DSWK9Bhr.js";import"./input-COMsjQRu.js";import"./textarea-C01GBzJv.js";import"./select-CRu623qS.js";import"./index-BdQq_4o_.js";import"./chevron-up-DgjV3eGa.js";import"./radio-group-CNTqitTj.js";import"./checkbox-Da8DgAL4.js";const Z=()=>{const{category:s,templateId:t}=D(),[W,g]=R(),{toast:c}=A(),{data:i,isLoading:x}=N({queryKey:[`/api/templates/${s}/${t}`],queryFn:C({on401:"redirect-to-login"}),enabled:!!s&&!!t,retry:3}),{data:n,isLoading:y,error:b}=N({queryKey:[`/api/template-fields/${t}`],queryFn:C(),enabled:!!t});console.log(`[DEBUG] Template ID: ${t}, isLoadingFields: ${y}, 
    fieldsCount: ${n?Array.isArray(n)?n.length:"not array":"null"}`),b&&console.error("[ERROR] Failed to fetch template fields:",b);const[m,E]=L.useState({}),v=r=>{E(r)},$=async r=>{var j,w;r.preventDefault();try{if(console.log("Submitting form data:",{templateId:t,category:s,formData:m}),!t||!s){console.error("Missing required parameters:",{templateId:t,category:s}),c({title:"خطأ",description:"بيانات القالب غير مكتملة",variant:"destructive"});return}c({title:"جاري الإنشاء...",description:"يتم الآن إنشاء صورة المعاينة، يرجى الانتظار"});const u=Object.entries(m).some(([o,a])=>typeof a=="string"&&a.startsWith("data:image/"));try{let o;if(u){const l=new FormData;l.append("templateId",t),l.append("category",s),l.append("quality","preview"),l.append("isPreview","true");for(const[d,p]of Object.entries(m))if(typeof p=="string"&&p.startsWith("data:image/")){const k=await fetch(p).then(q=>q.blob());l.append(d,k,`${d}.jpg`)}else l.append(d,String(p));o=await fetch("/api/cards/generate",{method:"POST",body:l}).then(d=>d.json())}else o=await S("POST","/api/cards/generate",{templateId:t,category:s,formData:m,quality:"preview",isPreview:!0},{timeout:2e4});const a=o;if(console.log("Card preview created successfully:",a),!a.cardId){console.error("API response missing cardId:",a),c({title:"خطأ",description:"تم إنشاء البطاقة ولكن تعذر الانتقال إلى صفحة المعاينة",variant:"destructive"});return}const F=`/preview/${s}/${t}/${a.cardId}`;console.log("Navigating to preview URL:",F),g(F)}catch(o){console.error("API Error:",o);let a="حدث خطأ أثناء إنشاء المعاينة، يرجى المحاولة مرة أخرى";(j=o.message)!=null&&j.includes("timeout")||o.name==="AbortError"?a="استغرق الطلب وقتا طويلا. تحقق من اتصالك بالإنترنت وحاول مرة أخرى.":(w=o.message)!=null&&w.includes("القالب غير موجود")&&(a="القالب المحدد غير متوفر، يرجى اختيار قالب آخر."),c({title:"خطأ",description:a,variant:"destructive"})}}catch(u){console.error("General Error:",u),c({title:"خطأ",description:"حدث خطأ غير متوقع، يرجى المحاولة مرة أخرى",variant:"destructive"})}},I=()=>{if(x||y)return e.jsx("div",{className:"p-6 text-center",children:"جاري تحميل القالب..."});if(!i)return console.error("Template not loaded for category:",s,"templateId:",t),e.jsxs("div",{className:"p-6 text-center bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-500 mb-2",children:"تعذر تحميل القالب"}),e.jsx("p",{className:"text-sm text-gray-600",children:"حدث خطأ أثناء تحميل القالب، الرجاء العودة واختيار قالب آخر."}),e.jsx(f,{variant:"outline",className:"mt-4",onClick:()=>g("/?tab=cards"),children:"العودة إلى القوالب"})]});if(n&&Array.isArray(n)&&n.length>0)return console.log(`Using custom form with ${n.length} template fields for template ${t}`),e.jsx(O,{onChange:v,template:{...i,templateFields:n}});let r;switch(s){case"wedding":r=h;break;case"engagement":r=G;break;case"graduation":r=B;break;case"eid":r=U;break;case"ramadan":r=T;break;case"other":r=h;break;default:r=h}return r?e.jsx(r,{onChange:v,template:i}):e.jsx("div",{className:"p-6 text-center",children:"نوع البطاقة غير مدعوم. الرجاء العودة واختيار قالب آخر."})};return e.jsxs("div",{className:"container mx-auto px-4 py-6",children:[e.jsxs(f,{variant:"ghost",className:"mb-6 flex items-center text-primary hover:text-primary/80 font-medium",onClick:()=>g("/?tab=cards"),children:[e.jsx("i",{className:"fas fa-arrow-right ml-2"}),"العودة إلى القوالب"]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[e.jsx("div",{className:"bg-white p-4 rounded-lg shadow-md",children:e.jsx("div",{className:"relative pb-[140%]",children:x?e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:"جاري التحميل..."}):e.jsx("img",{src:i==null?void 0:i.imageUrl,alt:i==null?void 0:i.title,className:"absolute inset-0 w-full h-full object-contain"})})}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold text-neutral-800 mb-6",children:["تخصيص بطاقة ",P()]}),e.jsxs("form",{onSubmit:$,className:"space-y-6",children:[I(),e.jsx("div",{className:"pt-4",children:e.jsx(f,{type:"submit",className:"w-full px-6 py-3 bg-primary text-white font-medium rounded-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-colors",children:"معاينة البطاقة"})})]})]})]})]})};export{Z as default};
