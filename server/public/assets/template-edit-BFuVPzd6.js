import{o as Ce,a as be,h as Fe,q as Se,r as C,b as le,j as e,c as re,B as N,C as ne,s as ce,t as de,v as oe,d as he,g as me}from"./index-DoMHCGG2.js";import{I as h}from"./input-COMsjQRu.js";import{L as n}from"./label-DSWK9Bhr.js";import{T as we,a as Ae,b as A,c as I}from"./tabs-CKJmMpcu.js";import{S as m,a as g,b as p,c as x,d as a}from"./select-CRu623qS.js";import{S as Ie}from"./switch-DKvoDZdm.js";import{A as Ue}from"./arrow-left-BN8mgSLP.js";import{I as b}from"./image-CRCqvbIG.js";import{S as ke}from"./save-CRRscGsZ.js";import"./index-BdQq_4o_.js";import"./chevron-up-DgjV3eGa.js";function $e(){var q,D,z,H,P,W,E,R,O,$,B,Q,K,G,J,_,M,X,Y;const{templateId:j}=Ce(),[Le,f]=be(),{toast:v}=Fe(),ge=Se(),o=!!j,[i,c]=C.useState({title:"",titleAr:"",slug:"",categoryId:0,imageUrl:"",thumbnailUrl:"",displayOrder:0,fields:[],defaultValues:{},settings:{fontFamily:"Tajawal",fontSize:16,textColor:"#000000",backgroundColor:"#ffffff",orientation:"portrait",quality:"high",compressionLevel:0,format:"png",resolution:300,aspectRatio:"3:4",paperSize:"custom",paperWidth:0,paperHeight:0,paperUnit:"mm"},active:!0}),[S,pe]=C.useState(null),[U,k]=C.useState(""),[L,T]=C.useState(!1),{data:xe,isLoading:ue}=le({queryKey:["/api/categories"],queryFn:me({on401:"redirect-to-login"})}),F=xe||[],{data:r,isLoading:je}=le({queryKey:[`/api/templates/${j}`],queryFn:me({on401:"redirect-to-login"}),enabled:o});C.useEffect(()=>{if(r)try{const t=r.templateFields||[];c({id:r.id,title:r.title||"",titleAr:r.titleAr||"",slug:r.slug||"",categoryId:typeof r.categoryId=="number"?r.categoryId:0,imageUrl:r.imageUrl||"",thumbnailUrl:r.thumbnailUrl||"",displayOrder:typeof r.displayOrder=="number"?r.displayOrder:0,fields:Array.isArray(r.fields)?r.fields:[],defaultValues:r.defaultValues||{},settings:r.settings||{fontFamily:"Tajawal",fontSize:16,textColor:"#000000",backgroundColor:"#ffffff",orientation:"portrait",quality:"high",compressionLevel:0,format:"png",resolution:300,aspectRatio:"3:4"},active:!!r.active,templateFields:t}),r.imageUrl&&k(r.imageUrl)}catch(t){console.error("خطأ في معالجة بيانات القالب:",t),v({title:"خطأ في معالجة بيانات القالب",description:"حدث خطأ أثناء معالجة بيانات القالب",variant:"destructive"})}},[r,v]);const V=t=>{const{name:s,value:l}=t.target;c(d=>({...d,[s]:l}))},fe=(t,s)=>{c(l=>({...l,[s]:t}))},ve=t=>{c(s=>({...s,categoryId:parseInt(t)}))},ye=t=>{if(t.target.files&&t.target.files[0]){const s=t.target.files[0];pe(s);const l=URL.createObjectURL(s);k(l)}},w=t=>{const{name:s,value:l}=t.target;c(d=>({...d,settings:{...d.settings,[s]:l}}))},Ne=async t=>{if(t.preventDefault(),!i.categoryId){v({title:"اختر تصنيف",description:"يجب اختيار تصنيف للقالب",variant:"destructive"});return}if(!i.title){v({title:"أدخل عنوان",description:"يجب إدخال عنوان للقالب",variant:"destructive"});return}if(!S&&!i.imageUrl){v({title:"أضف صورة",description:"يجب إضافة صورة للقالب",variant:"destructive"});return}T(!0);try{const s=new FormData;s.append("templateData",JSON.stringify({title:i.title,titleAr:i.titleAr,categoryId:parseInt(i.categoryId.toString()),active:!!i.active,settings:i.settings||{},fields:Array.isArray(i.fields)?i.fields:[],defaultValues:i.defaultValues||{},templateFields:i.templateFields||[],imageUrl:i.imageUrl||""})),S&&s.append("image",S);const l=o?`/api/admin/templates/${j}`:"/api/admin/templates",u=await fetch(l,{method:o?"PUT":"POST",body:s,credentials:"include"});if(!u.ok)throw new Error(await u.text());const y=await u.json();v({title:o?"تم تحديث القالب بنجاح":"تم إضافة القالب بنجاح"}),ge.invalidateQueries({queryKey:["/api/templates"]}),f(o?"/admin/templates":`/admin/templates/${y.id}/fields`)}catch(s){console.error("Error submitting template:",s),v({title:o?"فشل تحديث القالب":"فشل إضافة القالب",description:s instanceof Error?s.message:"حدث خطأ أثناء معالجة الطلب",variant:"destructive"})}finally{T(!1)}};return o&&je||ue?e.jsx("div",{className:"container py-8 flex justify-center",children:e.jsx(re,{className:"h-8 w-8 animate-spin"})}):e.jsxs("div",{className:"container py-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:o?"تعديل القالب":"إضافة قالب جديد"}),e.jsxs(N,{variant:"outline",onClick:()=>f("/admin/templates"),children:[e.jsx(Ue,{className:"ml-2 h-4 w-4"}),"العودة للقوالب"]})]}),e.jsxs("form",{onSubmit:Ne,children:[e.jsxs("div",{className:"grid gap-6 md:grid-cols-2",children:[e.jsx("div",{children:e.jsxs(ne,{children:[e.jsxs(ce,{children:[e.jsx(de,{children:"بيانات القالب"}),e.jsx(oe,{children:"المعلومات الأساسية للقالب"})]}),e.jsxs(he,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(n,{htmlFor:"title",children:"عنوان القالب"}),e.jsx(h,{id:"title",name:"title",value:i.title,onChange:V,placeholder:"أدخل عنوان القالب",required:!0})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(n,{htmlFor:"titleAr",children:"عنوان القالب (بالعربية)"}),e.jsx(h,{id:"titleAr",name:"titleAr",value:i.titleAr||"",onChange:V,placeholder:"أدخل عنوان القالب بالعربية"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(n,{htmlFor:"category",children:"التصنيف"}),(F==null?void 0:F.length)>0?e.jsxs(m,{value:i.categoryId.toString(),onValueChange:ve,children:[e.jsx(g,{id:"category",children:e.jsx(p,{placeholder:"اختر تصنيف"})}),e.jsx(x,{children:F.map(t=>e.jsx(a,{value:t.id.toString(),children:t.name},t.id))})]}):e.jsx("p",{className:"text-sm text-yellow-600",children:"لا توجد تصنيفات. قم بإضافة تصنيفات أولًا."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ie,{id:"active",checked:i.active,onCheckedChange:t=>fe(t,"active")}),e.jsx(n,{htmlFor:"active",children:"نشط"})]})]})]})}),e.jsx("div",{children:e.jsxs(ne,{children:[e.jsxs(ce,{children:[e.jsx(de,{children:"الصورة والإعدادات"}),e.jsx(oe,{children:"صورة القالب والإعدادات المرئية"})]}),e.jsxs(he,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(n,{htmlFor:"image",children:"صورة القالب"}),e.jsxs("div",{className:"grid gap-4",children:[e.jsx(h,{id:"image",type:"file",accept:"image/*",onChange:ye,className:"hidden"}),e.jsx("div",{className:"border-2 border-dashed rounded-md p-6 flex flex-col items-center cursor-pointer hover:border-primary transition-colors",onClick:()=>{var t;return(t=document.getElementById("image"))==null?void 0:t.click()},children:U?e.jsx("div",{className:"relative w-full aspect-[3/4] max-w-sm mx-auto",children:e.jsx("img",{src:U,alt:"معاينة",className:"rounded-md object-cover w-full h-full"})}):e.jsxs(e.Fragment,{children:[e.jsx(b,{className:"h-12 w-12 text-muted-foreground mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"انقر لاختيار صورة"})]})})]})]}),e.jsx("div",{className:"border-t pt-4",children:e.jsxs(we,{defaultValue:"text",children:[e.jsxs(Ae,{className:"w-full mb-4",children:[e.jsx(A,{value:"text",children:"إعدادات النص"}),e.jsx(A,{value:"image",children:"إعدادات الصورة"}),e.jsx(A,{value:"paper",children:"حجم الورق"})]}),e.jsxs(I,{value:"text",className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(n,{htmlFor:"fontSize",children:"حجم الخط"}),e.jsx(h,{id:"fontSize",name:"fontSize",type:"number",value:((q=i.settings)==null?void 0:q.fontSize)||16,onChange:w,min:"8",max:"72"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(n,{htmlFor:"fontFamily",children:"نوع الخط"}),e.jsxs(m,{value:((D=i.settings)==null?void 0:D.fontFamily)||"Tajawal",onValueChange:t=>{c(s=>({...s,settings:{...s.settings,fontFamily:t}}))},children:[e.jsx(g,{id:"fontFamily",children:e.jsx(p,{placeholder:"اختر نوع الخط"})}),e.jsxs(x,{children:[e.jsx(a,{value:"Tajawal",children:"طجوال"}),e.jsx(a,{value:"Cairo",children:"كايرو"}),e.jsx(a,{value:"Almarai",children:"المراعي"}),e.jsx(a,{value:"Amiri",children:"أميري"}),e.jsx(a,{value:"Arial",children:"Arial"})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(n,{htmlFor:"textColor",children:"لون الخط"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{id:"textColor",name:"textColor",type:"color",value:((z=i.settings)==null?void 0:z.textColor)||"#000000",onChange:w,className:"w-12 h-9 p-1"}),e.jsx(h,{value:((H=i.settings)==null?void 0:H.textColor)||"#000000",onChange:t=>{c(s=>({...s,settings:{...s.settings,textColor:t.target.value}}))},className:"flex-1"})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(n,{htmlFor:"backgroundColor",children:"لون الخلفية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{id:"backgroundColor",name:"backgroundColor",type:"color",value:((P=i.settings)==null?void 0:P.backgroundColor)||"#ffffff",onChange:w,className:"w-12 h-9 p-1"}),e.jsx(h,{value:((W=i.settings)==null?void 0:W.backgroundColor)||"#ffffff",onChange:t=>{c(s=>({...s,settings:{...s.settings,backgroundColor:t.target.value}}))},className:"flex-1"})]})]})]}),e.jsxs(I,{value:"image",className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(n,{htmlFor:"orientation",children:"اتجاه الصورة"}),e.jsxs(m,{value:((E=i.settings)==null?void 0:E.orientation)||"portrait",onValueChange:t=>{c(s=>({...s,settings:{...s.settings,orientation:t}}))},children:[e.jsx(g,{id:"orientation",children:e.jsx(p,{placeholder:"اختر اتجاه الصورة"})}),e.jsxs(x,{children:[e.jsx(a,{value:"portrait",children:"طولي (Portrait)"}),e.jsx(a,{value:"landscape",children:"عرضي (Landscape)"}),e.jsx(a,{value:"square",children:"مربع (Square)"})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(n,{htmlFor:"aspectRatio",children:"نسبة العرض إلى الارتفاع"}),e.jsxs(m,{value:((R=i.settings)==null?void 0:R.aspectRatio)||"3:4",onValueChange:t=>{c(s=>({...s,settings:{...s.settings,aspectRatio:t}}))},children:[e.jsx(g,{id:"aspectRatio",children:e.jsx(p,{placeholder:"اختر نسبة العرض إلى الارتفاع"})}),e.jsxs(x,{children:[e.jsx(a,{value:"3:4",children:"3:4 (بطاقة قياسية)"}),e.jsx(a,{value:"1:1",children:"1:1 (مربع - انستجرام)"}),e.jsx(a,{value:"9:16",children:"9:16 (قصص انستجرام)"}),e.jsx(a,{value:"4:3",children:"4:3 (شاشة عريضة)"}),e.jsx(a,{value:"16:9",children:"16:9 (فيديو HD)"})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(n,{htmlFor:"quality",children:"جودة الصورة"}),e.jsxs(m,{value:((O=i.settings)==null?void 0:O.quality)||"high",onValueChange:t=>{c(s=>({...s,settings:{...s.settings,quality:t}}))},children:[e.jsx(g,{id:"quality",children:e.jsx(p,{placeholder:"اختر جودة الصورة"})}),e.jsxs(x,{children:[e.jsx(a,{value:"high",children:"عالية"}),e.jsx(a,{value:"medium",children:"متوسطة"}),e.jsx(a,{value:"low",children:"منخفضة"})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(n,{htmlFor:"format",children:"صيغة الصورة"}),e.jsxs(m,{value:(($=i.settings)==null?void 0:$.format)||"png",onValueChange:t=>{c(s=>({...s,settings:{...s.settings,format:t}}))},children:[e.jsx(g,{id:"format",children:e.jsx(p,{placeholder:"اختر صيغة الصورة"})}),e.jsxs(x,{children:[e.jsx(a,{value:"png",children:"PNG (جودة عالية للشفافية)"}),e.jsx(a,{value:"jpeg",children:"JPEG (حجم أصغر)"})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(n,{htmlFor:"resolution",children:"دقة الصورة (DPI)"}),e.jsxs(m,{value:((Q=(B=i.settings)==null?void 0:B.resolution)==null?void 0:Q.toString())||"300",onValueChange:t=>{c(s=>({...s,settings:{...s.settings,resolution:parseInt(t)}}))},children:[e.jsx(g,{id:"resolution",children:e.jsx(p,{placeholder:"اختر دقة الصورة"})}),e.jsxs(x,{children:[e.jsx(a,{value:"72",children:"72 DPI (للشاشة)"}),e.jsx(a,{value:"150",children:"150 DPI (للويب)"}),e.jsx(a,{value:"300",children:"300 DPI (للطباعة)"}),e.jsx(a,{value:"600",children:"600 DPI (للطباعة عالية الجودة)"})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(n,{htmlFor:"compressionLevel",children:"مستوى الضغط"}),e.jsxs(m,{value:((G=(K=i.settings)==null?void 0:K.compressionLevel)==null?void 0:G.toString())||"0",onValueChange:t=>{c(s=>({...s,settings:{...s.settings,compressionLevel:parseInt(t)}}))},children:[e.jsx(g,{id:"compressionLevel",children:e.jsx(p,{placeholder:"اختر مستوى الضغط"})}),e.jsxs(x,{children:[e.jsx(a,{value:"0",children:"بدون ضغط (جودة أعلى)"}),e.jsx(a,{value:"3",children:"ضغط منخفض"}),e.jsx(a,{value:"6",children:"ضغط متوسط"}),e.jsx(a,{value:"9",children:"ضغط عالي (حجم أصغر)"})]})]})]})]}),e.jsxs(I,{value:"paper",className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(n,{htmlFor:"paperSize",children:"حجم الورق"}),e.jsxs(m,{value:((J=i.settings)==null?void 0:J.paperSize)||"custom",onValueChange:t=>{var d,u;let s=0,l=0;switch(t){case"A4":s=210,l=297;break;case"A3":s=297,l=420;break;case"A5":s=148,l=210;break;case"letter":s=216,l=279;break;case"legal":s=216,l=356;break;default:s=((d=i.settings)==null?void 0:d.paperWidth)||0,l=((u=i.settings)==null?void 0:u.paperHeight)||0}c(y=>({...y,settings:{...y.settings,paperSize:t,paperWidth:s,paperHeight:l}}))},children:[e.jsx(g,{id:"paperSize",children:e.jsx(p,{placeholder:"اختر حجم الورق"})}),e.jsxs(x,{children:[e.jsx(a,{value:"A4",children:"A4 (210×297 مم)"}),e.jsx(a,{value:"A3",children:"A3 (297×420 مم)"}),e.jsx(a,{value:"A5",children:"A5 (148×210 مم)"}),e.jsx(a,{value:"letter",children:"Letter (8.5×11 إنش)"}),e.jsx(a,{value:"legal",children:"Legal (8.5×14 إنش)"}),e.jsx(a,{value:"custom",children:"مخصص"})]})]})]}),((_=i.settings)==null?void 0:_.paperSize)==="custom"&&e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(n,{htmlFor:"paperWidth",children:"العرض"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(h,{id:"paperWidth",name:"paperWidth",type:"number",value:((M=i.settings)==null?void 0:M.paperWidth)||0,onChange:t=>{c(s=>({...s,settings:{...s.settings,paperWidth:parseFloat(t.target.value)}}))},min:"0",step:"0.1"})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(n,{htmlFor:"paperHeight",children:"الارتفاع"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(h,{id:"paperHeight",name:"paperHeight",type:"number",value:((X=i.settings)==null?void 0:X.paperHeight)||0,onChange:t=>{c(s=>({...s,settings:{...s.settings,paperHeight:parseFloat(t.target.value)}}))},min:"0",step:"0.1"})})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(n,{htmlFor:"paperUnit",children:"وحدة القياس"}),e.jsxs(m,{value:((Y=i.settings)==null?void 0:Y.paperUnit)||"mm",onValueChange:t=>{var d,u,y,Z,ee,se,te,ie;let s=((d=i.settings)==null?void 0:d.paperWidth)||0,l=((u=i.settings)==null?void 0:u.paperHeight)||0;((y=i.settings)==null?void 0:y.paperUnit)==="mm"&&t==="cm"?(s=s/10,l=l/10):((Z=i.settings)==null?void 0:Z.paperUnit)==="mm"&&t==="inch"?(s=s/25.4,l=l/25.4):((ee=i.settings)==null?void 0:ee.paperUnit)==="cm"&&t==="mm"?(s=s*10,l=l*10):((se=i.settings)==null?void 0:se.paperUnit)==="cm"&&t==="inch"?(s=s/2.54,l=l/2.54):((te=i.settings)==null?void 0:te.paperUnit)==="inch"&&t==="mm"?(s=s*25.4,l=l*25.4):((ie=i.settings)==null?void 0:ie.paperUnit)==="inch"&&t==="cm"&&(s=s*2.54,l=l*2.54),c(ae=>({...ae,settings:{...ae.settings,paperUnit:t,paperWidth:parseFloat(s.toFixed(2)),paperHeight:parseFloat(l.toFixed(2))}}))},children:[e.jsx(g,{id:"paperUnit",children:e.jsx(p,{placeholder:"اختر وحدة القياس"})}),e.jsxs(x,{children:[e.jsx(a,{value:"mm",children:"ملليمتر (mm)"}),e.jsx(a,{value:"cm",children:"سنتيمتر (cm)"}),e.jsx(a,{value:"inch",children:"إنش (inch)"})]})]})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"معلومات مفيدة:"}),e.jsxs("ul",{className:"text-sm text-muted-foreground list-disc list-inside space-y-1",children:[e.jsx("li",{children:"A4: الحجم الأكثر شيوعًا للمستندات والشهادات (210×297 مم)"}),e.jsx("li",{children:"A3: مناسب للشهادات الكبيرة والملصقات (297×420 مم)"}),e.jsx("li",{children:"Letter: شائع في أمريكا الشمالية (8.5×11 إنش)"}),e.jsx("li",{children:"يمكنك ضبط الاتجاه (طولي/عرضي) في تبويب إعدادات الصورة"})]})]})]})]})})]})]})})]}),e.jsxs("div",{className:"mt-6 flex justify-between",children:[e.jsx("div",{className:"flex gap-2",children:e.jsxs(N,{type:"submit",size:"lg",className:"min-w-32",disabled:L,children:[L&&e.jsx(re,{className:"ml-2 h-4 w-4 animate-spin"}),e.jsx(ke,{className:"ml-2 h-4 w-4"}),o?"تحديث القالب":"إضافة القالب"]})}),o&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(N,{type:"button",variant:"outline",onClick:()=>f(`/template-editor-with-layers-new/${j}`),children:[e.jsx(b,{className:"ml-2 h-4 w-4"}),"محرر الطبقات المتقدم 2.0"]}),e.jsxs(N,{type:"button",variant:"outline",onClick:()=>f(`/template-editor-with-layers/${j}`),children:[e.jsx(b,{className:"ml-2 h-4 w-4"}),"محرر الطبقات المتقدم 1.0"]}),e.jsxs(N,{type:"button",variant:"outline",onClick:()=>f(`/template-editor-unified/${j}`),children:[e.jsx(b,{className:"ml-2 h-4 w-4"}),"محرر القوالب الموحد"]}),e.jsxs(N,{type:"button",variant:"outline",onClick:()=>f(`/template-editor/${j}`),children:[e.jsx(b,{className:"ml-2 h-4 w-4"}),"محرر القوالب التقليدي"]})]})]})]})]})}export{$e as default};
