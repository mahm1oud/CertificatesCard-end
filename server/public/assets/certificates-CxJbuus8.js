import{h as Oe,r as n,b as B,i as I,j as e,c as A,B as i,L as D,C as ee,s as se,t as te,v as ae,d as ie,A as Ve,U as ze,K as le,N as re,O as ne,P as ce,Q as $,V as p,Y as de,Z as Q,_ as U}from"./index-DoMHCGG2.js";import{I as K}from"./input-COMsjQRu.js";import{D as oe,b as xe,c as me,d as he,e as ue,f as je}from"./dialog-fsPDLJiu.js";import{S as O,a as V,b as z,c as H,d as c}from"./select-CRu623qS.js";import{T as He,a as Re,b as pe,c as ge}from"./tabs-CKJmMpcu.js";import{T as fe,a as ve,b as F,c as t,d as Ne,e as a}from"./table-I-YXpiuN.js";import{P as _e}from"./plus-B2are30l.js";import{U as Ge}from"./upload-EyRwM4Gj.js";import{S as Ye}from"./search-CdLD-xpV.js";import{F as Ze}from"./filter-7iR-QHWX.js";import{Q as ye}from"./qr-code-BYf2XRjA.js";import{E as we}from"./ellipsis-vertical-CjI7CaMN.js";import{E as be}from"./eye-Co1cENxs.js";import{T as Ce}from"./trash-2-Dn6YYs7e.js";import"./index-BdQq_4o_.js";import"./chevron-up-DgjV3eGa.js";function us(){const{toast:o}=Oe(),[E,Te]=n.useState(""),[g,Se]=n.useState("all"),[f,De]=n.useState("all"),[x,Fe]=n.useState("certificates"),[Ee,v]=n.useState(!1),[N,R]=n.useState(null),[Me,y]=n.useState(!1),[w,_]=n.useState(""),[G,Y]=n.useState(""),[l,b]=n.useState(1),r=20,{data:h,isLoading:ke,isFetching:Le}=B({queryKey:["/api/admin/certificates",l,r,g,f,E],queryFn:()=>U({})({queryKey:["/api/admin/certificates"],meta:{params:{page:l,limit:r,status:g!=="all"?g:void 0,type:f!=="all"?f:void 0,search:E||void 0}}}),enabled:x==="certificates"}),{data:u,isLoading:qe,isFetching:Pe}=B({queryKey:["/api/admin/certificate-batches",l,r],queryFn:()=>U({})({queryKey:["/api/admin/certificate-batches"],meta:{params:{page:l,limit:r}}}),enabled:x==="batches"}),{data:M,isLoading:Je}=B({queryKey:["/api/templates"],queryFn:U({})}),k=I({mutationFn:async s=>{await de("DELETE",`/api/admin/certificates/${s}`)},onSuccess:()=>{Q.invalidateQueries({queryKey:["/api/admin/certificates"]}),v(!1),R(null),o({title:"تم حذف الشهادة بنجاح"})},onError:s=>{o({title:"فشل حذف الشهادة",description:s.message,variant:"destructive"})}}),Z=I({mutationFn:async s=>{await de("DELETE",`/api/admin/certificate-batches/${s}`)},onSuccess:()=>{Q.invalidateQueries({queryKey:["/api/admin/certificate-batches"]}),o({title:"تم حذف المجموعة بنجاح"})},onError:s=>{o({title:"فشل حذف المجموعة",description:s.message,variant:"destructive"})}}),L=I({mutationFn:async s=>{const m=await fetch("/api/certificate-batches",{method:"POST",body:s,credentials:"include"});if(!m.ok){const d=await m.json();throw new Error(d.message||"فشل رفع الملف")}return m.json()},onSuccess:()=>{Q.invalidateQueries({queryKey:["/api/admin/certificate-batches"]}),y(!1),_(""),Y(""),o({title:"تم رفع الملف بنجاح",description:"جاري معالجة الشهادات"})},onError:s=>{o({title:"فشل رفع الملف",description:s.message,variant:"destructive"})}}),Be=s=>{R(s),v(!0)},Ie=s=>{var X;s.preventDefault();const d=s.currentTarget.querySelector('input[type="file"]');if(!((X=d==null?void 0:d.files)!=null&&X.length)){o({title:"يرجى اختيار ملف",variant:"destructive"});return}if(!w){o({title:"يرجى اختيار قالب",variant:"destructive"});return}const S=new FormData;S.append("file",d.files[0]),S.append("templateId",w),S.append("title",G||`مجموعة شهادات ${new Date().toLocaleDateString("ar-SA")}`),L.mutate(S)},J=(h==null?void 0:h.certificates)||[],q=(h==null?void 0:h.total)||0,Ae=Math.ceil(q/r),W=(u==null?void 0:u.batches)||[],P=(u==null?void 0:u.total)||0,$e=Math.ceil(P/r),Qe=x==="certificates"?ke:qe,C=x==="certificates"?Le:Pe,j=x==="certificates"?Ae:$e,T=x==="certificates"?q:P,Ue=s=>{switch(s){case"appreciation":return"شهادة تقدير";case"training":return"شهادة تدريب";case"education":return"شهادة تعليم";case"teacher":return"شهادة معلم";default:return s}},Ke=s=>{switch(s){case"pending":return"قيد الانتظار";case"processing":return"جاري المعالجة";case"completed":return"مكتملة";case"failed":return"فشلت";default:return s}};return Qe?e.jsx("div",{className:"container mx-auto py-10 flex justify-center",children:e.jsx(A,{className:"h-8 w-8 animate-spin text-primary"})}):e.jsxs("div",{className:"container mx-auto py-6 space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"الشهادات"}),e.jsx("p",{className:"text-muted-foreground",children:"إدارة الشهادات ومجموعات الشهادات"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(i,{asChild:!0,children:e.jsxs(D,{href:"/certificates/new",children:[e.jsx(_e,{className:"h-4 w-4 ml-2"}),"إنشاء شهادة"]})}),e.jsxs(i,{variant:"outline",onClick:()=>y(!0),children:[e.jsx(Ge,{className:"h-4 w-4 ml-2"}),"رفع ملف إكسل"]})]})]}),e.jsxs(He,{value:x,onValueChange:Fe,children:[e.jsxs(Re,{children:[e.jsx(pe,{value:"certificates",children:"الشهادات"}),e.jsx(pe,{value:"batches",children:"مجموعات الشهادات"})]}),e.jsxs(ge,{value:"certificates",className:"mt-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 md:items-center md:justify-between",children:[e.jsxs("div",{className:"relative flex-1 max-w-sm",children:[e.jsx(Ye,{className:"absolute right-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(K,{placeholder:"البحث في الشهادات...",className:"pr-9",value:E,onChange:s=>Te(s.target.value)})]}),e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(Ze,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs(O,{value:f,onValueChange:De,children:[e.jsx(V,{className:"w-[160px]",children:e.jsx(z,{placeholder:"نوع الشهادة"})}),e.jsxs(H,{children:[e.jsx(c,{value:"all",children:"جميع الأنواع"}),e.jsx(c,{value:"appreciation",children:"شهادة تقدير"}),e.jsx(c,{value:"training",children:"شهادة تدريب"}),e.jsx(c,{value:"education",children:"شهادة تعليم"}),e.jsx(c,{value:"teacher",children:"شهادة معلم"})]})]})]}),e.jsx("div",{className:"flex items-center space-x-2 space-x-reverse",children:e.jsxs(O,{value:g,onValueChange:Se,children:[e.jsx(V,{className:"w-[160px]",children:e.jsx(z,{placeholder:"حالة الشهادة"})}),e.jsxs(H,{children:[e.jsx(c,{value:"all",children:"جميع الحالات"}),e.jsx(c,{value:"active",children:"نشطة"}),e.jsx(c,{value:"expired",children:"منتهية"}),e.jsx(c,{value:"revoked",children:"ملغاة"})]})]})})]})]}),e.jsxs(ee,{className:"mt-6",children:[e.jsxs(se,{className:"pb-3",children:[e.jsx(te,{children:"الشهادات"}),e.jsxs(ae,{children:["عدد الشهادات: ",q]})]}),e.jsx(ie,{children:J.length?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border rounded-md overflow-hidden",children:e.jsxs(fe,{children:[e.jsx(ve,{children:e.jsxs(F,{children:[e.jsx(t,{className:"w-16",children:"الصورة"}),e.jsx(t,{children:"العنوان"}),e.jsx(t,{children:"الممنوحة إلى"}),e.jsx(t,{children:"نوع الشهادة"}),e.jsx(t,{children:"تاريخ الإصدار"}),e.jsx(t,{children:"رمز التحقق"}),e.jsx(t,{className:"text-center",children:"الحالة"}),e.jsx(t,{className:"w-12"})]})}),e.jsx(Ne,{children:J.map(s=>e.jsxs(F,{children:[e.jsx(a,{children:e.jsx("div",{className:"w-12 h-12 rounded-md overflow-hidden bg-muted",children:s.imageUrl?e.jsx("img",{src:s.imageUrl,alt:"الشهادة",className:"w-full h-full object-cover"}):e.jsx("div",{className:"flex items-center justify-center w-full h-full text-muted-foreground",children:e.jsx(Ve,{className:"h-5 w-5"})})})}),e.jsxs(a,{children:[e.jsx("div",{className:"font-medium",children:s.title}),s.titleAr&&e.jsx("div",{className:"text-xs text-muted-foreground",children:s.titleAr})]}),e.jsx(a,{children:s.issuedTo?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ze,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("div",{children:s.issuedTo}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.issuedToGender==="male"?"ذكر":"أنثى"})]})]}):e.jsx("span",{className:"text-muted-foreground",children:"-"})}),e.jsx(a,{children:Ue(s.certificateType)}),e.jsx(a,{children:new Date(s.createdAt).toLocaleDateString("ar-SA")}),e.jsx(a,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("code",{className:"bg-muted text-xs px-1 py-0.5 rounded",children:s.verificationCode}),e.jsx(D,{href:`/certificates/verify/${s.verificationCode}`,children:e.jsx(i,{variant:"ghost",size:"icon",children:e.jsx(ye,{className:"h-4 w-4"})})})]})}),e.jsx(a,{className:"text-center",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${s.status==="active"?"bg-green-100 text-green-800":s.status==="expired"?"bg-yellow-100 text-yellow-800":s.status==="revoked"?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800"}`,children:s.status==="active"?"نشطة":s.status==="expired"?"منتهية":s.status==="revoked"?"ملغاة":s.status})}),e.jsx(a,{children:e.jsxs(le,{children:[e.jsx(re,{asChild:!0,children:e.jsx(i,{variant:"ghost",size:"icon",children:e.jsx(we,{className:"h-4 w-4"})})}),e.jsxs(ne,{align:"end",children:[e.jsx(ce,{children:"خيارات"}),e.jsx($,{}),e.jsx(p,{asChild:!0,children:e.jsxs(D,{href:`/certificates/public/${s.publicId}`,children:[e.jsx(be,{className:"h-4 w-4 ml-2"}),"عرض الشهادة"]})}),e.jsxs(p,{onClick:()=>window.open(`/certificates/verify/${s.verificationCode}`,"_blank"),children:[e.jsx(ye,{className:"h-4 w-4 ml-2"}),"صفحة التحقق"]}),e.jsx($,{}),e.jsxs(p,{onClick:()=>Be(s),className:"text-destructive focus:text-destructive",children:[e.jsx(Ce,{className:"h-4 w-4 ml-2"}),"حذف"]})]})]})})]},s.id))})]})}),j>1&&e.jsxs("div",{className:"flex items-center justify-between mt-6",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["عرض ",(l-1)*r+1," - ",Math.min(l*r,T)," من ",T]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(i,{variant:"outline",size:"sm",onClick:()=>b(s=>Math.max(s-1,1)),disabled:l===1||C,children:"السابق"}),e.jsx(i,{variant:"outline",size:"sm",onClick:()=>b(s=>Math.min(s+1,j)),disabled:l===j||C,children:"التالي"})]})]})]}):e.jsx("div",{className:"text-center py-10 text-muted-foreground",children:"لا توجد شهادات متطابقة مع معايير البحث"})})]})]}),e.jsx(ge,{value:"batches",className:"mt-4",children:e.jsxs(ee,{children:[e.jsxs(se,{className:"pb-3",children:[e.jsx(te,{children:"مجموعات الشهادات"}),e.jsxs(ae,{children:["عدد المجموعات: ",P]})]}),e.jsx(ie,{children:W.length?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border rounded-md overflow-hidden",children:e.jsxs(fe,{children:[e.jsx(ve,{children:e.jsxs(F,{children:[e.jsx(t,{children:"العنوان"}),e.jsx(t,{children:"المستخدم"}),e.jsx(t,{children:"القالب"}),e.jsx(t,{children:"نوع المصدر"}),e.jsx(t,{className:"text-center",children:"البنود"}),e.jsx(t,{className:"text-center",children:"تاريخ الإنشاء"}),e.jsx(t,{className:"text-center",children:"الحالة"}),e.jsx(t,{className:"w-12"})]})}),e.jsx(Ne,{children:W.map(s=>{var m,d;return e.jsxs(F,{children:[e.jsx(a,{children:e.jsx("div",{className:"font-medium",children:s.title})}),e.jsx(a,{children:((m=s.user)==null?void 0:m.username)||`مستخدم ${s.userId}`}),e.jsx(a,{children:((d=s.template)==null?void 0:d.title)||`قالب ${s.templateId}`}),e.jsx(a,{children:s.sourceType==="excel"?"ملف إكسل":s.sourceType==="csv"?"ملف CSV":s.sourceType==="manual"?"إدخال يدوي":s.sourceType}),e.jsxs(a,{className:"text-center",children:[s.processedItems,"/",s.totalItems]}),e.jsx(a,{className:"text-center",children:new Date(s.createdAt).toLocaleDateString("ar-SA")}),e.jsx(a,{className:"text-center",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${s.status==="completed"?"bg-green-100 text-green-800":s.status==="processing"?"bg-blue-100 text-blue-800":s.status==="pending"?"bg-yellow-100 text-yellow-800":s.status==="failed"?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800"}`,children:Ke(s.status)})}),e.jsx(a,{children:e.jsxs(le,{children:[e.jsx(re,{asChild:!0,children:e.jsx(i,{variant:"ghost",size:"icon",children:e.jsx(we,{className:"h-4 w-4"})})}),e.jsxs(ne,{align:"end",children:[e.jsx(ce,{children:"خيارات"}),e.jsx($,{}),e.jsx(p,{asChild:!0,children:e.jsxs(D,{href:`/admin/certificate-batches/${s.id}`,children:[e.jsx(be,{className:"h-4 w-4 ml-2"}),"عرض التفاصيل"]})}),e.jsxs(p,{onClick:()=>Z.mutate(s.id),className:"text-destructive focus:text-destructive",disabled:Z.isPending,children:[e.jsx(Ce,{className:"h-4 w-4 ml-2"}),"حذف"]})]})]})})]},s.id)})})]})}),j>1&&e.jsxs("div",{className:"flex items-center justify-between mt-6",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["عرض ",(l-1)*r+1," - ",Math.min(l*r,T)," من ",T]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(i,{variant:"outline",size:"sm",onClick:()=>b(s=>Math.max(s-1,1)),disabled:l===1||C,children:"السابق"}),e.jsx(i,{variant:"outline",size:"sm",onClick:()=>b(s=>Math.min(s+1,j)),disabled:l===j||C,children:"التالي"})]})]})]}):e.jsx("div",{className:"text-center py-10 text-muted-foreground",children:"لا توجد مجموعات شهادات"})})]})})]}),e.jsx(oe,{open:Ee,onOpenChange:v,children:e.jsxs(xe,{children:[e.jsxs(me,{children:[e.jsx(he,{children:"حذف الشهادة"}),e.jsx(ue,{children:"هل أنت متأكد من رغبتك في حذف هذه الشهادة؟ هذا الإجراء لا يمكن التراجع عنه."})]}),e.jsxs("div",{className:"py-4",children:[N&&e.jsx("div",{className:"aspect-video w-[200px] h-[120px] mx-auto overflow-hidden rounded-md border",children:e.jsx("img",{src:N.imageUrl,alt:"الشهادة",className:"w-full h-full object-cover"})}),e.jsx("p",{className:"text-sm text-muted-foreground mt-6 text-center",children:"سيتم حذف الشهادة نهائياً ولن تتمكن من استعادتها."})]}),e.jsxs(je,{children:[e.jsx(i,{variant:"outline",onClick:()=>v(!1),children:"إلغاء"}),e.jsx(i,{variant:"destructive",onClick:()=>N&&k.mutate(N.id),disabled:k.isPending,children:k.isPending?e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"ml-2 h-4 w-4 animate-spin"}),"جاري الحذف..."]}):"تأكيد الحذف"})]})]})}),e.jsx(oe,{open:Me,onOpenChange:y,children:e.jsxs(xe,{children:[e.jsxs(me,{children:[e.jsx(he,{children:"رفع ملف إكسل"}),e.jsx(ue,{children:"قم برفع ملف إكسل يحتوي على بيانات الشهادات المراد إنشاؤها."})]}),e.jsxs("form",{onSubmit:Ie,className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"title",className:"text-sm font-medium",children:"عنوان المجموعة"}),e.jsx(K,{id:"title",value:G,onChange:s=>Y(s.target.value),placeholder:"أدخل عنوان مجموعة الشهادات"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"template",className:"text-sm font-medium",children:"القالب"}),e.jsxs(O,{value:w,onValueChange:_,children:[e.jsx(V,{children:e.jsx(z,{placeholder:"اختر قالب الشهادات"})}),e.jsx(H,{children:((M==null?void 0:M.templates)||[]).map(s=>e.jsx(c,{value:String(s.id),children:s.title},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"file",className:"text-sm font-medium",children:"ملف إكسل"}),e.jsx(K,{id:"file",type:"file",accept:".xlsx,.xls,.csv",required:!0,className:"cursor-pointer"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"يجب أن يحتوي الملف على أعمدة تطابق حقول القالب المختار."})]}),e.jsxs(je,{children:[e.jsx(i,{type:"button",variant:"outline",onClick:()=>y(!1),children:"إلغاء"}),e.jsx(i,{type:"submit",disabled:L.isPending||!w,children:L.isPending?e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"ml-2 h-4 w-4 animate-spin"}),"جاري الرفع..."]}):"رفع الملف"})]})]})]})})]})}export{us as default};
