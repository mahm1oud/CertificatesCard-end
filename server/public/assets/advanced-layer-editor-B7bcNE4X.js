import{n as He,j as e,C as cs,s as hs,t as xs,v as ms,d as us,r,h as ps,R as ye,T as _,y as Z,z as U,B as v,D as q,G as Qe,S as Ws,o as As,a as Ds,l as Te,c as Ve,E as Gs}from"./index-DoMHCGG2.js";import{G as Ee,R as ne,T as je,I as Hs,b as we,S as Bs,L as Re,a as Xs}from"./ReactKonvaCore-0IBzjN_D.js";import{S as ge}from"./scroll-area-BaWF6YIt.js";import{T as Ys,a as _s,b as Me,c as Pe}from"./tabs-CKJmMpcu.js";import{S as re}from"./switch-DKvoDZdm.js";import{L as f}from"./label-DSWK9Bhr.js";import{S as H}from"./slider-ef3OeGSW.js";import{C as Oe,B as Zs}from"./badge-D9F70VlA.js";import{S as es,a as ss,b as ts,c as is,d as D}from"./select-CRu623qS.js";import{R as Us,a as $e}from"./radio-group-CNTqitTj.js";import{I as Ne}from"./input-COMsjQRu.js";import{P as qs,a as Ks,b as Js}from"./popover-Cz0h5r1u.js";import{R as Ae}from"./rotate-ccw-JEJsQ_rj.js";import{R as ke}from"./rotate-cw-CTNsAp4T.js";import{E as De}from"./eye-Co1cENxs.js";import{L as js}from"./layers-D3_CD2xn.js";import{T as Qs}from"./type-DWs-uHqd.js";import{L as as}from"./lock-6HL3vJPU.js";import{a as Vs,Z as Os,E as ns}from"./zoom-out-eiDS2u6d.js";import{U as et,R as st}from"./undo-CkcTi4oW.js";import{M as tt}from"./magnet-CnbLQg6V.js";import{D as it}from"./download-CkzZtpS5.js";import{S as at}from"./square-Bfd32SEn.js";import{A as rs,a as ls,b as os}from"./alert-DFZX5DlC.js";import{A as ds}from"./arrow-left-BN8mgSLP.js";import{S as nt}from"./save-CRRscGsZ.js";import"./index-BdQq_4o_.js";import"./chevron-up-DgjV3eGa.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rt=He("MoveHorizontal",[["path",{d:"m18 8 4 4-4 4",key:"1ak13k"}],["path",{d:"M2 12h20",key:"9i4pu4"}],["path",{d:"m6 8-4 4 4 4",key:"15zrgr"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=He("MoveVertical",[["path",{d:"M12 2v20",key:"t6zp3m"}],["path",{d:"m8 18 4 4 4-4",key:"bh5tu3"}],["path",{d:"m8 6 4-4 4 4",key:"ybng9g"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lt=He("PanelTop",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}]]),xe=({propertyType:E,currentValue:i,onChange:l,hint:O,showPreview:N=!0,previewText:x="نص معاينة"})=>{const d=(R,L)=>typeof i=="object"&&i!==null&&i[R]!==void 0?i[R]:L,le=()=>{if(!N)return null;switch(E){case"font":const R=d("fontFamily","Arial"),L=d("fontSize",16),c=d("fontWeight","normal"),J=d("color","#000000"),F=d("align","center");return e.jsx("div",{className:"border rounded-lg p-4 h-28 flex items-center justify-center bg-gray-50 mb-4 overflow-hidden",children:e.jsx("div",{style:{fontFamily:R,fontSize:`${L}px`,fontWeight:c,color:J,textAlign:F,maxWidth:"100%",wordBreak:"break-word"},children:x})});case"layer":const M=d("zIndex",1),P=Array.from({length:5},(G,fe)=>fe+1);return e.jsx("div",{className:"border rounded-lg p-4 h-28 relative bg-gray-50 mb-4 overflow-hidden",children:P.map(G=>e.jsx("div",{className:`absolute rounded-md flex items-center justify-center ${G===M?"bg-primary text-white":"bg-gray-300 text-gray-700"}`,style:{width:"50px",height:"50px",left:`${30+(G-1)*15}%`,top:`${30+(G-1)*5}%`,zIndex:G,transition:"all 0.3s ease",transform:G===M?"scale(1.2)":"scale(1)",opacity:Math.max(.3,G===M?1:.7)},children:G},G))});case"rotation":const B=d("rotation",0);return e.jsx("div",{className:"border rounded-lg p-4 h-28 flex items-center justify-center bg-gray-50 mb-4 overflow-hidden",children:e.jsx("div",{className:"bg-primary text-white p-4 rounded",style:{transform:`rotate(${B}deg)`,transition:"transform 0.3s ease"},children:x})});case"position":const g=d("x",50),m=d("y",50);return e.jsx("div",{className:"border rounded-lg p-4 h-28 relative bg-gray-50 mb-4 overflow-hidden",children:e.jsx("div",{className:"absolute bg-primary text-white p-2 rounded text-xs",style:{left:`${g}%`,top:`${m}%`,transform:"translate(-50%, -50%)",transition:"all 0.3s ease"},children:`X: ${g}%, Y: ${m}%`})});case"shadow":const p=d("textShadow",{enabled:!1}),C=p.enabled||!1,z=p.color||"rgba(0,0,0,0.5)",k=p.blur||4,I=p.offsetX||2,W=p.offsetY||2;return e.jsx("div",{className:"border rounded-lg p-4 h-28 flex items-center justify-center bg-gray-50 mb-4 overflow-hidden",children:e.jsx("div",{className:"bg-white p-4 rounded text-black font-semibold",style:{textShadow:C?`${I}px ${W}px ${k}px ${z}`:"none",transition:"text-shadow 0.3s ease"},children:x})});case"size":const te=d("width",50),o=d("height",50);return e.jsx("div",{className:"border rounded-lg p-4 h-28 flex items-center justify-center bg-gray-50 mb-4 overflow-hidden",children:e.jsx("div",{className:"bg-primary flex items-center justify-center text-white text-xs",style:{width:`${te}%`,height:`${o}%`,transition:"all 0.3s ease"},children:`${te}% × ${o}%`})});default:return null}},K=()=>{switch(E){case"font":const R=d("fontFamily","Arial"),L=d("fontSize",16),c=d("fontWeight","normal"),J=d("color","#000000"),F=d("align","center");return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(f,{htmlFor:"fontFamily",children:"نوع الخط"}),e.jsxs(es,{value:R,onValueChange:o=>l({...i,fontFamily:o}),children:[e.jsx(ss,{id:"fontFamily",children:e.jsx(ts,{placeholder:"اختر نوع الخط"})}),e.jsxs(is,{children:[e.jsx(D,{value:"Arial",children:"Arial"}),e.jsx(D,{value:"Helvetica",children:"Helvetica"}),e.jsx(D,{value:"Times New Roman",children:"Times New Roman"}),e.jsx(D,{value:"Cairo",children:"Cairo"}),e.jsx(D,{value:"Almarai",children:"Almarai"}),e.jsx(D,{value:"Tajawal",children:"Tajawal"})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(f,{htmlFor:"fontSize",children:"حجم الخط"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[L,"px"]})]}),e.jsx(H,{id:"fontSize",min:8,max:72,step:1,value:[L],onValueChange:o=>l({...i,fontSize:o[0]})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(f,{htmlFor:"fontWeight",children:"سمك الخط"}),e.jsxs(es,{value:c,onValueChange:o=>l({...i,fontWeight:o}),children:[e.jsx(ss,{id:"fontWeight",children:e.jsx(ts,{placeholder:"اختر سمك الخط"})}),e.jsxs(is,{children:[e.jsx(D,{value:"normal",children:"عادي"}),e.jsx(D,{value:"bold",children:"عريض"}),e.jsx(D,{value:"300",children:"رفيع (300)"}),e.jsx(D,{value:"500",children:"متوسط (500)"}),e.jsx(D,{value:"700",children:"عريض (700)"}),e.jsx(D,{value:"900",children:"عريض جداً (900)"})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(f,{htmlFor:"color",children:"لون الخط"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ne,{id:"color",type:"color",value:J,onChange:o=>l({...i,color:o.target.value}),className:"w-12 h-8 p-0"}),e.jsx(Ne,{type:"text",value:J,onChange:o=>l({...i,color:o.target.value}),className:"flex-1"})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(f,{htmlFor:"align",children:"محاذاة النص"}),e.jsxs(Us,{id:"align",value:F,onValueChange:o=>l({...i,align:o}),className:"flex justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx($e,{value:"right",id:"align-right"}),e.jsx(f,{htmlFor:"align-right",children:"يمين"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx($e,{value:"center",id:"align-center"}),e.jsx(f,{htmlFor:"align-center",children:"وسط"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx($e,{value:"left",id:"align-left"}),e.jsx(f,{htmlFor:"align-left",children:"يسار"})]})]})]})]});case"layer":const M=d("zIndex",1);return e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(f,{htmlFor:"zIndex",children:"ترتيب الطبقة"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:M})]}),e.jsx(H,{id:"zIndex",min:0,max:10,step:1,value:[M],onValueChange:o=>l({...i,zIndex:o[0]})}),e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground",children:[e.jsx("span",{children:"خلف (0)"}),e.jsx("span",{children:"أمام (10)"})]})]})});case"rotation":const P=d("rotation",0);return e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(f,{htmlFor:"rotation",children:"زاوية الدوران"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[P,"°"]})]}),e.jsx(H,{id:"rotation",min:-180,max:180,step:5,value:[P],onValueChange:o=>l({...i,rotation:o[0]})}),e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground",children:[e.jsx("span",{children:"-180°"}),e.jsx("span",{children:"0°"}),e.jsx("span",{children:"180°"})]}),e.jsxs("div",{className:"flex justify-center gap-2 mt-2",children:[e.jsx("button",{type:"button",onClick:()=>l({...i,rotation:(P-45)%360}),className:"p-2 border rounded hover:bg-gray-100",title:"تدوير عكس عقارب الساعة",children:e.jsx(Ae,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:()=>l({...i,rotation:0}),className:"p-2 border rounded hover:bg-gray-100",title:"إعادة الضبط",children:"0°"}),e.jsx("button",{type:"button",onClick:()=>l({...i,rotation:(P+45)%360}),className:"p-2 border rounded hover:bg-gray-100",title:"تدوير مع عقارب الساعة",children:e.jsx(ke,{className:"h-4 w-4"})})]})]})});case"position":const B=d("x",50),g=d("y",50);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(f,{htmlFor:"x-position",children:"الموضع الأفقي (X)"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[B,"%"]})]}),e.jsx(H,{id:"x-position",min:0,max:100,step:1,value:[B],onValueChange:o=>l({...i,x:o[0]})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(f,{htmlFor:"y-position",children:"الموضع الرأسي (Y)"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[g,"%"]})]}),e.jsx(H,{id:"y-position",min:0,max:100,step:1,value:[g],onValueChange:o=>l({...i,y:o[0]})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 mt-2",children:[e.jsx("button",{type:"button",onClick:()=>l({...i,x:50,y:0}),className:"p-2 border rounded hover:bg-gray-100 text-xs",title:"أعلى",children:"أعلى"}),e.jsx("button",{type:"button",onClick:()=>l({...i,x:50,y:50}),className:"p-2 border rounded hover:bg-gray-100 text-xs",title:"وسط",children:"وسط"}),e.jsx("button",{type:"button",onClick:()=>l({...i,x:50,y:100}),className:"p-2 border rounded hover:bg-gray-100 text-xs",title:"أسفل",children:"أسفل"})]})]});case"shadow":const m=d("textShadow",{enabled:!1}),p=m.enabled||!1,C=m.color||"rgba(0,0,0,0.5)",z=m.blur||4,k=m.offsetX||2,I=m.offsetY||2;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(re,{id:"shadow-enabled",checked:p,onCheckedChange:o=>l({...i,textShadow:{...i.textShadow,enabled:o}})}),e.jsx(f,{htmlFor:"shadow-enabled",children:"تفعيل الظل"})]}),p&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(f,{htmlFor:"shadow-color",children:"لون الظل"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ne,{id:"shadow-color",type:"color",value:C.startsWith("rgba")?"#000000":C,onChange:o=>l({...i,textShadow:{...i.textShadow,color:o.target.value}}),className:"w-12 h-8 p-0"}),e.jsx(Ne,{type:"text",value:C,onChange:o=>l({...i,textShadow:{...i.textShadow,color:o.target.value}}),className:"flex-1"})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(f,{htmlFor:"shadow-blur",children:"تمويه الظل"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[z,"px"]})]}),e.jsx(H,{id:"shadow-blur",min:0,max:20,step:1,value:[z],onValueChange:o=>l({...i,textShadow:{...i.textShadow,blur:o[0]}})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(f,{htmlFor:"shadow-offset-x",children:"إزاحة X"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[k,"px"]})]}),e.jsx(H,{id:"shadow-offset-x",min:-20,max:20,step:1,value:[k],onValueChange:o=>l({...i,textShadow:{...i.textShadow,offsetX:o[0]}})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(f,{htmlFor:"shadow-offset-y",children:"إزاحة Y"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[I,"px"]})]}),e.jsx(H,{id:"shadow-offset-y",min:-20,max:20,step:1,value:[I],onValueChange:o=>l({...i,textShadow:{...i.textShadow,offsetY:o[0]}})})]})]})]})]});case"size":const W=d("width",50),te=d("height",50);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(f,{htmlFor:"width",children:"العرض"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[W,"%"]})]}),e.jsx(H,{id:"width",min:10,max:100,step:1,value:[W],onValueChange:o=>l({...i,width:o[0]})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(f,{htmlFor:"height",children:"الارتفاع"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[te,"%"]})]}),e.jsx(H,{id:"height",min:10,max:100,step:1,value:[te],onValueChange:o=>l({...i,height:o[0]})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 mt-2",children:[e.jsx("button",{type:"button",onClick:()=>l({...i,width:25,height:25}),className:"p-2 border rounded hover:bg-gray-100 text-xs",title:"صغير",children:"صغير"}),e.jsx("button",{type:"button",onClick:()=>l({...i,width:50,height:50}),className:"p-2 border rounded hover:bg-gray-100 text-xs",title:"متوسط",children:"متوسط"}),e.jsx("button",{type:"button",onClick:()=>l({...i,width:100,height:100}),className:"p-2 border rounded hover:bg-gray-100 text-xs",title:"كبير",children:"كبير"})]})]});default:return e.jsx("div",{children:"نوع الخاصية غير معروف"})}},me=()=>{switch(E){case"font":return"خصائص الخط";case"layer":return"ترتيب الطبقات";case"position":return"موضع العنصر";case"rotation":return"تدوير العنصر";case"shadow":return"خصائص الظل";case"size":return"حجم العنصر";default:return"خصائص متقدمة"}},ee=()=>{switch(E){case"font":return e.jsx(Qs,{className:"h-5 w-5"});case"layer":return e.jsx(js,{className:"h-5 w-5"});case"position":return e.jsx(rt,{className:"h-5 w-5"});case"rotation":return e.jsx(ke,{className:"h-5 w-5"});case"shadow":return e.jsx(De,{className:"h-5 w-5"});case"size":return e.jsx(Ge,{className:"h-5 w-5"});default:return e.jsx(Oe,{className:"h-5 w-5"})}};return e.jsxs(cs,{className:"mb-6",children:[e.jsxs(hs,{className:"pb-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[ee(),e.jsx(xs,{className:"text-md",children:me()})]}),O&&e.jsxs(qs,{children:[e.jsx(Ks,{asChild:!0,children:e.jsx("button",{className:"p-1 rounded-full text-muted-foreground hover:bg-gray-100",children:e.jsx(Oe,{className:"h-4 w-4"})})}),e.jsx(Js,{className:"w-80 text-sm",children:e.jsx("p",{children:O})})]})]}),e.jsx(ms,{children:"قم بضبط الخصائص لرؤية التأثير مباشرةً"})]}),e.jsxs(us,{className:"pt-2",children:[le(),K()]})]})},ot=1e3,Le=.2,We=5,dt=20,ct=30;function ht(E,i){const l=document.createElement("a");l.download=i,l.href=E,document.body.appendChild(l),l.click(),document.body.removeChild(l)}const xt=({templateImage:E,fields:i,onFieldsChange:l,editorSettings:O,onSave:N,readOnly:x=!1})=>{var Ze,Ue,qe,Ke,Je;const d=r.useRef(null),le=r.useRef(null),K=r.useRef(null),me=r.useRef(null),ee=r.useRef(null),R=r.useRef(null),L={gridEnabled:!0,snapToGrid:!0,gridSize:dt,templateImagePosition:"middle",showRulers:!0},[c,J]=r.useState({...L,...O}),[F,M]=r.useState(1),[P,B]=r.useState({x:0,y:0}),[g,m]=r.useState({width:1e3,height:600}),[p,C]=r.useState([]),[z,k]=r.useState(!0),[I,W]=r.useState(0),[te,o]=r.useState(!1),[G,fe]=r.useState(!1),[X,Be]=r.useState([]),[Y,be]=r.useState(-1),{toast:Xe}=ps(),[ue,Se]=r.useState(null),[ve,Ce]=r.useState(!1),[ie,gs]=r.useState({width:0,height:0}),[Ye,fs]=r.useState({x:0,y:0});r.useEffect(()=>{i.length>0&&X.length===0&&(Be([[...i]]),be(0))},[i,X.length]),r.useEffect(()=>{if(!E){Ce(!1),Se(null);return}const s=new Image;return s.crossOrigin="Anonymous",s.src=E,s.onload=()=>{Se(s),Ce(!0);const n=s.width/s.height,a=ot,t=a/n;gs({width:a,height:t}),fs({x:0,y:0}),m({width:a,height:t});const u=c.templateImagePosition,j=i.map(y=>y.zIndex||0);if(u==="back")W(Math.min(...j,0)-1);else if(u==="front")W(Math.max(...j,0)+1);else{const y=Math.min(...j,0),b=Math.max(...j,0);W(Math.floor((y+b)/2))}},s.onerror=()=>{console.error("Error loading template image"),Ce(!1),Se(null)},()=>{s.onload=null,s.onerror=null}},[E,i,c.templateImagePosition]),r.useEffect(()=>{var n;if(!ee.current||!d.current)return;const s=p.map(a=>{var t;return(t=d.current)==null?void 0:t.findOne(`#field-${a}`)}).filter(Boolean);ee.current.nodes(s),(n=ee.current.getLayer())==null||n.batchDraw()},[p]);const _e=ye.useMemo(()=>({id:-1,name:"template_image",label:"صورة القالب",type:"template",position:Ye,zIndex:I,visible:z,size:ie,rotation:0,locked:!0}),[Ye,I,ie,z]),ze=ye.useMemo(()=>ve&&ue?[_e,...i]:i,[_e,i,ve,ue]),bs=ye.useMemo(()=>[...ze].sort((s,n)=>(s.zIndex||0)-(n.zIndex||0)),[ze]),pe=r.useCallback(s=>{const n=s==="up"?I+1:Math.max(I-1,-10);W(n)},[I]),Fe=r.useCallback(()=>{k(s=>!s)},[]),S=r.useCallback(s=>{const n=X.slice(0,Y+1),a=[...s],t=[...n,a].slice(-ct);Be(t),be(t.length-1),l(s)},[X,Y,l]),vs=r.useCallback(()=>{if(Y>0){const s=Y-1,n=X[s];be(s),l(n)}},[X,Y,l]),ys=r.useCallback(()=>{if(Y<X.length-1){const s=Y+1,n=X[s];be(s),l(n)}},[X,Y,l]),Q=r.useCallback(s=>{J(n=>({...n,...s}))},[]),oe=r.useCallback(s=>{if(!c.snapToGrid)return s;const n=c.gridSize;return{x:Math.round(s.x/n)*n,y:Math.round(s.y/n)*n}},[c.snapToGrid,c.gridSize]),ws=r.useCallback(s=>{s.target===s.currentTarget&&C([])},[]),de=r.useCallback(s=>{console.log("Field double clicked:",s)},[]),ae=r.useCallback((s,n)=>{C(n?a=>a.includes(s)?a.filter(t=>t!==s):[...a,s]:[s])},[]),Ns=r.useCallback((s,n)=>{const a=i.find(y=>y.id===s);if(!a)return;const t=a.zIndex||0,u=n==="up"?t+1:t-1,j=i.map(y=>y.id===s?{...y,zIndex:u}:y);S(j)},[i,S]),ks=r.useCallback(s=>{if(!i.find(t=>t.id===s))return;const a=i.map(t=>t.id===s?{...t,visible:t.visible===!1}:t);S(a)},[i,S]);r.useCallback(s=>{if(!i.find(t=>t.id===s))return;const a=i.map(t=>t.id===s?{...t,locked:!t.locked}:t);S(a)},[i,S]),r.useCallback(s=>{if(window.confirm("هل أنت متأكد من حذف هذا الحقل؟")){const n=i.filter(a=>a.id!==s);C(a=>a.filter(t=>t!==s)),S(n)}},[i,S]),r.useCallback(s=>{const n=i.find(j=>j.id===s);if(!n)return;const a=Math.max(0,...i.map(j=>j.id))+1,t={...n,id:a,position:{x:n.position.x+20,y:n.position.y+20,snapToGrid:n.position.snapToGrid},name:`${n.name}_copy`},u=[...i,t];S(u),C([a])},[i,S]);const Ss=r.useCallback(()=>{var a;if(!d.current)return;const s=[...p];C([]);const n=(a=K.current)==null?void 0:a.visible();K.current&&K.current.visible(!1),setTimeout(()=>{if(d.current){const t=d.current.toDataURL({pixelRatio:2,mimeType:"image/png"});K.current&&K.current.visible(n),C(s);const j=`template-export-${new Date().toISOString().replace(/[:.]/g,"-").split("T")[0]}.png`;ht(t,j),Xe({title:"تم تصدير الصورة بنجاح",duration:3e3})}},100)},[p,Xe]),Cs=r.useCallback((s,n)=>{if(s.visible===!1)return null;const a=s.style||{},t=s.defaultValue||s.label||s.placeholder||s.name,u=a.fontSize||24,j=a.fontFamily||"Cairo",y=a.fontWeight||"normal",b=a.color||"#000",se=a.maxWidth||300,ce=a.align||"center",w=a.textShadow,he=(w==null?void 0:w.enabled)===!0,h=(w==null?void 0:w.color)||"rgba(0,0,0,0.5)",$=(w==null?void 0:w.blur)||4,T=(w==null?void 0:w.offsetX)||2,A=(w==null?void 0:w.offsetY)||2;return e.jsxs(Ee,{id:`field-${s.id}`,x:s.position.x,y:s.position.y,rotation:s.rotation||0,draggable:!s.locked&&!x,onDragStart:()=>{o(!0)},onDragEnd:V=>{o(!1);const $s=oe({x:V.target.x(),y:V.target.y()}),Ls=i.map(Ie=>Ie.id===s.id?{...Ie,position:$s}:Ie);S(Ls)},onClick:V=>{V.cancelBubble=!0,ae(s.id,V.evt.shiftKey)},onTap:()=>{ae(s.id,!1)},onDblClick:()=>{de(s.id)},onDblTap:()=>{de(s.id)},children:[e.jsx(ne,{width:se,height:u*1.5,fill:"transparent",strokeEnabled:p.includes(s.id),stroke:"#3498db",strokeWidth:1,dash:[5,5],cornerRadius:4}),e.jsx(je,{text:t,fontSize:u,fontFamily:j,fontStyle:y,fill:b,width:se,align:ce,verticalAlign:"middle",padding:10,wrap:"word",shadowEnabled:he,shadowColor:h,shadowBlur:$,shadowOffset:{x:T,y:A}}),s.locked&&e.jsx(as,{x:se-16,y:-8,width:14,height:14,fill:"#f0f0f0",stroke:"#888"})]},s.id)},[i,p,oe,ae,de,S,x]),zs=r.useCallback((s,n)=>{if(s.visible===!1)return null;const a=s.style||{},t=a.imageMaxWidth||200,u=a.imageMaxHeight||200,j=a.imageRounded===!0,y=a.imageBorder===!0,b=a.imageShadow,se=(b==null?void 0:b.enabled)===!0,ce=(b==null?void 0:b.color)||"rgba(0,0,0,0.3)",w=(b==null?void 0:b.blur)||8,he=(b==null?void 0:b.offsetX)||4,h=(b==null?void 0:b.offsetY)||4;return e.jsxs(Ee,{id:`field-${s.id}`,x:s.position.x,y:s.position.y,rotation:s.rotation||0,draggable:!s.locked&&!x,onDragStart:()=>{o(!0)},onDragEnd:$=>{o(!1);const T=oe({x:$.target.x(),y:$.target.y()}),A=i.map(V=>V.id===s.id?{...V,position:T}:V);S(A)},onClick:$=>{$.cancelBubble=!0,ae(s.id,$.evt.shiftKey)},onTap:()=>{ae(s.id,!1)},onDblClick:()=>{de(s.id)},onDblTap:()=>{de(s.id)},children:[e.jsx(ne,{width:t,height:u,fill:"#f0f0f0",stroke:y?"#ddd":"transparent",strokeWidth:y?1:0,cornerRadius:j?Math.min(t,u)/5:4,shadowEnabled:se,shadowColor:ce,shadowBlur:w,shadowOffset:{x:he,y:h}}),e.jsx(je,{text:"صورة",fontSize:14,fontFamily:"Cairo",fill:"#999",width:t,height:u,align:"center",verticalAlign:"middle"}),s.locked&&e.jsx(as,{x:t-16,y:-8,width:14,height:14,fill:"#f0f0f0",stroke:"#888"})]},s.id)},[i,p,oe,ae,de,S,x]),Fs=r.useCallback(s=>!ve||!ue||s.visible===!1?null:e.jsxs(Ee,{id:`field-${s.id}`,x:s.position.x,y:s.position.y,draggable:!1,children:[e.jsx(ne,{width:ie.width,height:ie.height,fill:"#ffffff",stroke:"#f0f0f0",strokeWidth:1}),e.jsx(Hs,{image:ue,width:ie.width,height:ie.height,listening:!1})]},s.id),[ve,ue,ie]),Is=r.useCallback(()=>{if(!c.gridEnabled)return null;const s=c.gridSize,n=[];for(let a=0;a<=g.height;a+=s)n.push(e.jsx(we,{points:[0,a,g.width,a],stroke:"#ddd",strokeWidth:.5,dash:[2,2],listening:!1},`h-${a}`));for(let a=0;a<=g.width;a+=s)n.push(e.jsx(we,{points:[a,0,a,g.height],stroke:"#ddd",strokeWidth:.5,dash:[2,2],listening:!1},`v-${a}`));return e.jsx(e.Fragment,{children:n})},[c.gridEnabled,c.gridSize,g]),Ts=r.useCallback(()=>{if(!c.showRulers)return null;const s=20,n=c.gridSize,a=[];a.push(e.jsx(ne,{x:0,y:0,width:g.width,height:s,fill:"#f9f9f9",stroke:"#ddd",strokeWidth:.5,listening:!1},"horizontal-ruler")),a.push(e.jsx(ne,{x:0,y:0,width:s,height:g.height,fill:"#f9f9f9",stroke:"#ddd",strokeWidth:.5,listening:!1},"vertical-ruler"));for(let t=n;t<=g.width;t+=n)a.push(e.jsx(we,{points:[t,0,t,t%(n*5)===0?s:s/2],stroke:"#999",strokeWidth:.5,listening:!1},`h-mark-${t}`)),t%(n*5)===0&&a.push(e.jsx(je,{x:t-10,y:3,text:`${t}`,fontSize:8,fontFamily:"sans-serif",fill:"#666",align:"center",width:20,listening:!1},`h-text-${t}`));for(let t=n;t<=g.height;t+=n)a.push(e.jsx(we,{points:[0,t,t%(n*5)===0?s:s/2,t],stroke:"#999",strokeWidth:.5,listening:!1},`v-mark-${t}`)),t%(n*5)===0&&a.push(e.jsx(je,{x:2,y:t-4,text:`${t}`,fontSize:8,fontFamily:"sans-serif",fill:"#666",width:16,listening:!1},`v-text-${t}`));return a.push(e.jsx(ne,{x:0,y:0,width:s,height:s,fill:"#f0f0f0",stroke:"#ddd",strokeWidth:.5,listening:!1},"ruler-corner")),e.jsx(e.Fragment,{children:a})},[c.showRulers,c.gridSize,g]),Es=r.useCallback(s=>{fe(!1);const n=s.target,a=parseInt(n.id().replace("field-",""));if(!i.find(j=>j.id===a))return;const u=i.map(j=>{if(j.id===a){const y={x:n.x(),y:n.y()},b=c.snapToGrid?oe(y):y;return{...j,position:b,rotation:Math.round(n.rotation())}}return j});S(u)},[i,c.snapToGrid,oe,S]),Rs=()=>{const s=[...ze].sort((t,u)=>(u.zIndex||0)-(t.zIndex||0)),[n,a]=r.useState(null);return e.jsx(ge,{className:"h-[calc(100vh-200px)]",children:e.jsx("div",{className:"p-2 space-y-1",children:s.map(t=>e.jsxs("div",{className:`flex items-center p-2 rounded-md transition-all duration-200 ${p.includes(t.id)?"bg-primary/15 border border-primary/30":n===t.id?"bg-secondary/20 border border-secondary/20":"hover:bg-accent border border-transparent"}`,onClick:()=>ae(t.id,!1),onMouseEnter:()=>a(t.id),onMouseLeave:()=>a(null),children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{variant:"ghost",size:"icon",className:`h-6 w-6 p-0 ${t.visible===!1?"text-muted-foreground":"text-foreground"}`,onClick:u=>{u.stopPropagation(),t.id===-1?Fe():ks(t.id)},title:t.visible===!1?"إظهار الطبقة":"إخفاء الطبقة",disabled:x,children:t.visible===!1?e.jsx(De,{size:14}):e.jsx(ns,{size:14})}),t.type==="text"&&e.jsx(je,{as:"div",size:14,className:"text-blue-500"}),t.type==="image"&&e.jsx(at,{size:14,className:"text-green-500"}),t.type==="template"&&e.jsx(lt,{size:14,className:"text-purple-500"}),e.jsx("span",{className:"text-xs font-medium truncate",children:t.type==="template"?"صورة القالب":t.label||t.name})]})}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(Zs,{variant:"outline",className:"text-xs px-2 py-0 bg-secondary/10",children:["z:",t.zIndex||0]}),t.id!==-1&&e.jsx("div",{className:"flex flex-col",children:e.jsx(v,{variant:"ghost",size:"icon",className:"h-5 w-5 p-0",onClick:u=>{u.stopPropagation(),Ns(t.id,"up")},title:"نقل الطبقة للأعلى",disabled:x,children:e.jsx(Ge,{size:12})})}),t.id===-1&&e.jsx("div",{className:"flex flex-col",children:e.jsx(v,{variant:"ghost",size:"icon",className:"h-5 w-5 p-0",onClick:u=>{u.stopPropagation(),pe("up")},title:"رفع طبقة صورة القالب",disabled:x,children:e.jsx(Ge,{size:12})})})]})]},t.id))})})},Ms=()=>{var u,j,y,b,se,ce,w,he;const s=ye.useMemo(()=>p.length!==1?null:i.find(h=>h.id===p[0])||null,[p,i]);if(!s)return e.jsx(ge,{className:"h-[calc(100vh-200px)]",children:e.jsx("div",{className:"p-4 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"قم بتحديد حقل لعرض خصائصه"})})});const n=(h,$)=>{if(!s)return;const T=i.map(A=>A.id===s.id?{...A,[h]:$}:A);S(T)},a=(h,$)=>{if(!s)return;const T=i.map(A=>A.id===s.id?{...A,style:{...A.style,[h]:$}}:A);S(T)},t=h=>{if(!s)return;const $=i.map(T=>T.id===s.id?{...T,position:{...T.position,x:h.x!==void 0?h.x:T.position.x,y:h.y!==void 0?h.y:T.position.y}}:T);S($)};return e.jsx(ge,{className:"h-[calc(100vh-200px)]",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"border rounded-md p-3 bg-muted/10",children:[e.jsx("h3",{className:"text-lg font-semibold mb-1",children:s.label||s.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["النوع: ",s.type==="text"?"نص":s.type==="image"?"صورة":"غير معروف"]})]}),e.jsx(xe,{propertyType:"layer",currentValue:{zIndex:s.zIndex||0},onChange:h=>n("zIndex",h.zIndex),hint:"ضبط طبقة العنصر لتحديد ما إذا كان أمام أو خلف العناصر الأخرى. القيم الأعلى تظهر أمام القيم الأقل."}),e.jsx(xe,{propertyType:"position",currentValue:{x:s.position?s.position.x/10:50,y:s.position?s.position.y/10:50},onChange:h=>t({x:h.x*10,y:h.y*10}),hint:"ضبط موضع العنصر على القالب (النسب مئوية من أبعاد القالب)"}),e.jsx(xe,{propertyType:"rotation",currentValue:{rotation:s.rotation||0},onChange:h=>n("rotation",h.rotation),hint:"ضبط زاوية دوران العنصر. 0 درجة هي الوضع الطبيعي."}),s.type==="text"&&e.jsx(xe,{propertyType:"font",currentValue:{fontFamily:((u=s.style)==null?void 0:u.fontFamily)||"Cairo",fontSize:((j=s.style)==null?void 0:j.fontSize)||24,fontWeight:((y=s.style)==null?void 0:y.fontWeight)||"normal",color:((b=s.style)==null?void 0:b.color)||"#000000",align:((se=s.style)==null?void 0:se.align)||"center"},onChange:h=>{a("fontFamily",h.fontFamily),a("fontSize",h.fontSize),a("fontWeight",h.fontWeight),a("color",h.color),a("align",h.align)},hint:"ضبط خصائص الخط مثل النوع والحجم واللون والمحاذاة",previewText:s.defaultValue||s.label||s.name}),s.type==="text"&&e.jsx(xe,{propertyType:"shadow",currentValue:{textShadow:((ce=s.style)==null?void 0:ce.textShadow)||{enabled:!1}},onChange:h=>{a("textShadow",h.textShadow)},hint:"ضبط خصائص ظل النص، مثل اللون والتمويه والإزاحة",previewText:s.defaultValue||s.label||s.name}),s.type==="image"&&e.jsx(xe,{propertyType:"size",currentValue:{width:((w=s.style)==null?void 0:w.imageMaxWidth)||50,height:((he=s.style)==null?void 0:he.imageMaxHeight)||50},onChange:h=>{a("imageMaxWidth",h.width),a("imageMaxHeight",h.height)},hint:"ضبط أبعاد الصورة كنسبة مئوية من أبعاد القالب"}),e.jsx("div",{className:"border rounded-md p-3 bg-muted/10",children:e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(f,{htmlFor:"field-visible",children:"إظهار الحقل"}),e.jsx(re,{id:"field-visible",checked:s.visible!==!1,onCheckedChange:h=>n("visible",h),disabled:x})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(f,{htmlFor:"field-locked",children:"قفل الحقل"}),e.jsx(re,{id:"field-locked",checked:s.locked===!0,onCheckedChange:h=>n("locked",h),disabled:x})]})]})})]})})},Ps=()=>e.jsx(ge,{className:"h-[calc(100vh-200px)]",children:e.jsx("div",{className:"p-4 space-y-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"إعدادات المحرر"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(f,{htmlFor:"grid-enabled",children:"إظهار الشبكة"}),e.jsx(re,{id:"grid-enabled",checked:c.gridEnabled,onCheckedChange:s=>Q({gridEnabled:s}),disabled:x})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(f,{htmlFor:"snap-to-grid",children:"التصاق بالشبكة"}),e.jsx(re,{id:"snap-to-grid",checked:c.snapToGrid,onCheckedChange:s=>Q({snapToGrid:s}),disabled:x})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(f,{htmlFor:"show-rulers",children:"إظهار المساطر"}),e.jsx(re,{id:"show-rulers",checked:c.showRulers,onCheckedChange:s=>Q({showRulers:s}),disabled:x})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(f,{htmlFor:"grid-size",children:["حجم الشبكة: ",c.gridSize,"px"]}),e.jsx(H,{id:"grid-size",min:5,max:50,step:5,value:[c.gridSize],onValueChange:s=>Q({gridSize:s[0]}),disabled:x})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"template-position",children:"موضع صورة القالب"}),e.jsxs("div",{className:"flex justify-between gap-2",children:[e.jsx(v,{variant:c.templateImagePosition==="back"?"secondary":"outline",size:"sm",onClick:()=>Q({templateImagePosition:"back"}),className:"flex-1",disabled:x,children:"خلف الحقول"}),e.jsx(v,{variant:c.templateImagePosition==="middle"?"secondary":"outline",size:"sm",onClick:()=>Q({templateImagePosition:"middle"}),className:"flex-1",disabled:x,children:"وسط"}),e.jsx(v,{variant:c.templateImagePosition==="front"?"secondary":"outline",size:"sm",onClick:()=>Q({templateImagePosition:"front"}),className:"flex-1",disabled:x,children:"أمام الحقول"})]})]}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"إعدادات صورة القالب"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(f,{htmlFor:"template-visibility",children:"إظهار صورة القالب"}),e.jsx(re,{id:"template-visibility",checked:z,onCheckedChange:Fe,disabled:x})]}),e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs(f,{htmlFor:"template-layer",children:["طبقة صورة القالب: ",I]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(v,{variant:"outline",size:"icon",onClick:()=>pe("down"),disabled:x,children:e.jsx(Ae,{size:14})}),e.jsx(v,{variant:"outline",size:"icon",onClick:()=>pe("up"),disabled:x,children:e.jsx(ke,{size:14})})]})]})})]})]})]})})});return e.jsxs("div",{className:"flex flex-col h-full bg-background",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 p-2 bg-card border-b",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(_,{children:e.jsxs(Z,{children:[e.jsx(U,{asChild:!0,children:e.jsx(v,{variant:"outline",size:"icon",onClick:()=>M(s=>Math.max(Le,s-.1)),disabled:F<=Le,children:e.jsx(Vs,{size:16})})}),e.jsx(q,{children:e.jsx("p",{children:"تصغير"})})]})}),e.jsxs(v,{variant:"outline",size:"sm",onClick:()=>{M(1),B({x:0,y:0})},children:[Math.round(F*100),"%"]}),e.jsx(_,{children:e.jsxs(Z,{children:[e.jsx(U,{asChild:!0,children:e.jsx(v,{variant:"outline",size:"icon",onClick:()=>M(s=>Math.min(We,s+.1)),disabled:F>=We,children:e.jsx(Os,{size:16})})}),e.jsx(q,{children:e.jsx("p",{children:"تكبير"})})]})})]}),e.jsx("div",{className:"h-6 w-px bg-border mx-1"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(_,{children:e.jsxs(Z,{children:[e.jsx(U,{asChild:!0,children:e.jsx(v,{variant:"outline",size:"icon",onClick:vs,disabled:Y<=0||x,children:e.jsx(et,{size:16})})}),e.jsx(q,{children:e.jsx("p",{children:"تراجع"})})]})}),e.jsx(_,{children:e.jsxs(Z,{children:[e.jsx(U,{asChild:!0,children:e.jsx(v,{variant:"outline",size:"icon",onClick:ys,disabled:Y>=X.length-1||x,children:e.jsx(st,{size:16})})}),e.jsx(q,{children:e.jsx("p",{children:"إعادة"})})]})})]}),e.jsx("div",{className:"h-6 w-px bg-border mx-1"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(_,{children:e.jsxs(Z,{children:[e.jsx(U,{asChild:!0,children:e.jsx(v,{variant:c.gridEnabled?"secondary":"outline",size:"icon",onClick:()=>Q({gridEnabled:!c.gridEnabled}),children:e.jsx(Qe,{size:16})})}),e.jsx(q,{children:e.jsx("p",{children:"إظهار/إخفاء الشبكة"})})]})}),e.jsx(_,{children:e.jsxs(Z,{children:[e.jsx(U,{asChild:!0,children:e.jsx(v,{variant:c.snapToGrid?"secondary":"outline",size:"icon",onClick:()=>Q({snapToGrid:!c.snapToGrid}),disabled:x,children:e.jsx(tt,{size:16})})}),e.jsx(q,{children:e.jsx("p",{children:"التصاق بالشبكة"})})]})})]}),e.jsx("div",{className:"h-6 w-px bg-border mx-1"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(_,{children:e.jsxs(Z,{children:[e.jsx(U,{asChild:!0,children:e.jsx(v,{variant:z?"outline":"secondary",size:"icon",onClick:Fe,disabled:x,children:z?e.jsx(De,{size:16}):e.jsx(ns,{size:16})})}),e.jsx(q,{children:e.jsx("p",{children:z?"إخفاء صورة القالب":"إظهار صورة القالب"})})]})}),e.jsx(_,{children:e.jsxs(Z,{children:[e.jsx(U,{asChild:!0,children:e.jsx(v,{variant:"outline",size:"icon",onClick:()=>pe("down"),disabled:x,children:e.jsx(Ae,{size:16})})}),e.jsx(q,{children:e.jsx("p",{children:"خفض طبقة صورة القالب"})})]})}),e.jsx(_,{children:e.jsxs(Z,{children:[e.jsx(U,{asChild:!0,children:e.jsx(v,{variant:"outline",size:"icon",onClick:()=>pe("up"),disabled:x,children:e.jsx(ke,{size:16})})}),e.jsx(q,{children:e.jsx("p",{children:"رفع طبقة صورة القالب"})})]})})]}),e.jsx("div",{className:"h-6 w-px bg-border mx-1"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(_,{children:e.jsxs(Z,{children:[e.jsx(U,{asChild:!0,children:e.jsx(v,{variant:"outline",size:"icon",onClick:Ss,children:e.jsx(it,{size:16})})}),e.jsx(q,{children:e.jsx("p",{children:"تصدير كصورة"})})]})}),N&&e.jsx(v,{onClick:N,disabled:x,children:"حفظ التغييرات"})]})]}),e.jsxs("div",{className:"flex flex-1 overflow-hidden",children:[e.jsxs("div",{className:"flex-1 overflow-hidden bg-slate-100",ref:R,children:[e.jsxs(Bs,{ref:d,width:g.width,height:g.height,scale:{x:F,y:F},position:P,draggable:!te&&!G,onDragStart:s=>{s.target===s.currentTarget&&(document.body.style.cursor="grabbing")},onDragEnd:()=>{document.body.style.cursor="default"},onClick:ws,onWheel:s=>{var b;s.evt.preventDefault();const n=1.1,a=F,t=(b=d.current)==null?void 0:b.getPointerPosition();if(!t)return;const u={x:(t.x-P.x)/a,y:(t.y-P.y)/a},j=s.evt.deltaY<0?Math.min(a*n,We):Math.max(a/n,Le),y={x:t.x-u.x*j,y:t.y-u.y*j};B(y),M(j)},children:[e.jsx(Re,{ref:le,children:e.jsx(ne,{x:0,y:0,width:g.width,height:g.height,fill:"#ffffff"})}),e.jsxs(Re,{ref:K,children:[Is(),Ts()]}),e.jsxs(Re,{ref:me,children:[bs.map((s,n)=>s.type==="template"?Fs(s):s.type==="text"?Cs(s,n):s.type==="image"?zs(s,n):null),e.jsx(Xs,{ref:ee,rotateEnabled:!x,enabledAnchors:["middle-left","middle-right","top-center","bottom-center"],rotationSnaps:[0,45,90,135,180,225,270,315],boundBoxFunc:(s,n)=>n.width<5||n.height<5?s:n,onTransformStart:()=>{fe(!0)},onTransformEnd:Es})]})]}),p.length>0&&e.jsx("div",{className:"absolute bottom-2 right-2 bg-white/80 backdrop-blur-sm p-2 rounded shadow-sm text-xs border",children:p.length===1?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"font-semibold",children:(Ze=i.find(s=>s.id===p[0]))==null?void 0:Ze.name}),e.jsx("span",{className:"mx-1",children:"·"}),e.jsxs("span",{children:["الموضع: ",Math.round(((Ue=i.find(s=>s.id===p[0]))==null?void 0:Ue.position.x)||0),", ",Math.round(((qe=i.find(s=>s.id===p[0]))==null?void 0:qe.position.y)||0)]}),(Ke=i.find(s=>s.id===p[0]))!=null&&Ke.rotation?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"mx-1",children:"·"}),e.jsxs("span",{children:["الدوران: ",Math.round(((Je=i.find(s=>s.id===p[0]))==null?void 0:Je.rotation)||0),"°"]})]}):null]}):e.jsxs("span",{children:[p.length," عناصر محددة"]})})]}),e.jsx("div",{className:"w-72 border-r bg-card flex flex-col",children:e.jsxs(Ys,{defaultValue:"layers",className:"flex-1 flex flex-col",children:[e.jsxs(_s,{className:"w-full",children:[e.jsxs(Me,{value:"layers",className:"flex-1",children:[e.jsx(js,{className:"h-4 w-4 mr-2"}),"الطبقات"]}),e.jsxs(Me,{value:"properties",className:"flex-1",children:[e.jsx(Ws,{className:"h-4 w-4 mr-2"}),"الخصائص"]}),e.jsxs(Me,{value:"settings",className:"flex-1",children:[e.jsx(Qe,{className:"h-4 w-4 mr-2"}),"الإعدادات"]})]}),e.jsx(Pe,{value:"layers",className:"flex-1 overflow-hidden p-0",children:e.jsx(Rs,{})}),e.jsx(Pe,{value:"properties",className:"flex-1 overflow-hidden p-0",children:e.jsx(Ms,{})}),e.jsx(Pe,{value:"settings",className:"flex-1 overflow-hidden p-0",children:e.jsx(Ps,{})})]})})]})]})},Ht=()=>{const E=As(),i=parseInt(E.templateId||E.id||"0"),[,l]=Ds(),{toast:O}=ps(),[N,x]=r.useState(null),[d,le]=r.useState([]),[K,me]=r.useState({}),[ee,R]=r.useState(!0),[L,c]=r.useState(!1),[J,F]=r.useState(null);r.useEffect(()=>{async function g(){if(!i){F("معرف القالب غير صالح"),R(!1);return}try{R(!0),F(null);const m=await Te("GET",`/api/templates/${i}`);x(m);const C=(await Te("GET",`/api/admin/template-fields/${i}`)).map((k,I)=>{var W;return{...k,zIndex:((W=k.style)==null?void 0:W.layer)||I,visible:k.visible!==!1,position:k.position||{x:50,y:50+I*50,snapToGrid:!1}}});le(C);const z={};C.forEach(k=>{k.type==="text"?z[k.name]=k.defaultValue||k.label||k.name:k.type==="image"&&(z[k.name]=null)}),me(z),R(!1)}catch(m){console.error("Error loading template data:",m),F("حدث خطأ أثناء تحميل بيانات القالب. يرجى المحاولة مرة أخرى."),R(!1)}}g()},[i]);const M=r.useCallback(g=>{le(g)},[]),P=r.useCallback(async()=>{if(!(!i||d.length===0))try{c(!0);const g=d.filter(m=>m.id!==-1).map(m=>({id:m.id,templateId:m.templateId,name:m.name,label:m.label,labelAr:m.labelAr,type:m.type,position:m.position,style:{...m.style,layer:m.zIndex||0},visible:m.visible,required:m.required,defaultValue:m.defaultValue,placeholder:m.placeholder,placeholderAr:m.placeholderAr,options:m.options,displayOrder:m.displayOrder}));await Te("PUT",`/api/admin/template-fields/${i}/batch-update`,g),O({title:"تم الحفظ",description:"تم حفظ تغييرات الطبقات بنجاح",duration:3e3}),c(!1)}catch(g){console.error("Error saving fields:",g),O({title:"خطأ في الحفظ",description:"حدث خطأ أثناء حفظ التغييرات. يرجى المحاولة مرة أخرى.",variant:"destructive",duration:5e3}),c(!1)}},[i,d,O]),B=r.useCallback(()=>{l(`/admin/templates/${i}/fields`)},[l,i]);return ee?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Ve,{className:"h-10 w-10 animate-spin mx-auto mb-4 text-primary"}),e.jsx("p",{className:"text-muted-foreground",children:"جاري تحميل بيانات القالب..."})]})}):J?e.jsxs("div",{className:"container max-w-4xl mx-auto px-4 py-8",children:[e.jsxs(rs,{variant:"destructive",className:"mb-4",children:[e.jsx(ls,{children:"خطأ"}),e.jsx(os,{children:J})]}),e.jsxs(v,{onClick:B,variant:"outline",className:"mt-4",children:[e.jsx(ds,{className:"h-4 w-4 mr-2"}),"العودة"]})]}):e.jsxs("div",{className:"container-fluid py-4",children:[e.jsxs("div",{className:"mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"محرر الطبقات المتقدم"}),e.jsxs("p",{className:"text-muted-foreground",children:[(N==null?void 0:N.title)||(N==null?void 0:N.name)||"قالب جديد"," - إدارة الطبقات والمواضع"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(v,{onClick:B,variant:"outline",children:[e.jsx(ds,{className:"h-4 w-4 mr-2"}),"العودة"]}),e.jsx(v,{onClick:P,disabled:L,children:L?e.jsxs(e.Fragment,{children:[e.jsx(Ve,{className:"h-4 w-4 mr-2 animate-spin"}),"جاري الحفظ..."]}):e.jsxs(e.Fragment,{children:[e.jsx(nt,{className:"h-4 w-4 mr-2"}),"حفظ التغييرات"]})})]})]}),e.jsxs(rs,{className:"mb-4",children:[e.jsx(ls,{children:"نظام طبقات متقدم"}),e.jsx(os,{children:"يمكنك وضع بعض الحقول أمام صورة القالب والبعض الآخر خلفها من خلال إدارة الطبقات في اللوحة الجانبية. استخدم زر المغناطيس للالتصاق بالشبكة لوضع أكثر دقة للحقول."})]}),e.jsxs(cs,{className:"mb-4",children:[e.jsxs(hs,{className:"pb-2",children:[e.jsxs(xs,{children:["قالب: ",(N==null?void 0:N.title)||(N==null?void 0:N.name)||"قالب جديد"]}),e.jsxs(ms,{children:[d.length," حقل متاح للتحرير"]})]}),e.jsx(Gs,{}),e.jsx(us,{className:"pt-4 px-0",children:e.jsx(ge,{className:"h-[calc(100vh-280px)]",children:e.jsx("div",{className:"overflow-hidden",children:N&&d.length>0&&e.jsx(xt,{templateImage:N.imageUrl,fields:d,onFieldsChange:M,onSave:P,editorSettings:{gridEnabled:!0,snapToGrid:!0,gridSize:20,templateImagePosition:"middle",showRulers:!0}})})})})]})]})};export{Ht as default};
