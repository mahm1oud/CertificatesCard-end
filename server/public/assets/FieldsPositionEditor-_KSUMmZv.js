import{n as he,r as g,h as cs,j as e,G as Ns,B as b,C as Ye,s as Xe,t as Oe,T as ue,y as oe,z as de,D as xe,d as _e,S as bs,x as ws,c as Be,E as fs,k as Cs}from"./index-DoMHCGG2.js";import{D as ks,b as Ss,c as zs,d as Is,e as Ms,f as Ts}from"./dialog-fsPDLJiu.js";import{I as H}from"./input-COMsjQRu.js";import{L as w}from"./label-DSWK9Bhr.js";import{S as ye}from"./switch-DKvoDZdm.js";import{S as be}from"./slider-ef3OeGSW.js";import{T as re,a as ce,b as K,c as Z}from"./tabs-CKJmMpcu.js";import{S as we,a as fe,b as Ce,c as ke,d as Y}from"./select-CRu623qS.js";import{S as Me}from"./scroll-area-BaWF6YIt.js";import{A as Ke,a as Ze,b as Je}from"./alert-DFZX5DlC.js";import{S as Fs,L as Ds,I as Ps,b as ie,G as qe,T as Qe,R as $s,a as As}from"./ReactKonvaCore-0IBzjN_D.js";import{R as Se}from"./rotate-ccw-JEJsQ_rj.js";import{R as ze}from"./rotate-cw-CTNsAp4T.js";import{Z as Vs,a as Es,E as Te}from"./zoom-out-eiDS2u6d.js";import{M as Ls}from"./maximize-ghBMrwjq.js";import{M as Ws}from"./magnet-CnbLQg6V.js";import{E as ve}from"./eye-Co1cENxs.js";import{C as os}from"./copy-DCUs-YoJ.js";import{T as ds}from"./trash-2-Dn6YYs7e.js";import{D as Ie}from"./download-CkzZtpS5.js";import"./form-DyTRWEbF.js";import{B as Ue,C as Gs}from"./badge-D9F70VlA.js";import{L as es}from"./layers-D3_CD2xn.js";import{I as xs}from"./image-CRCqvbIG.js";import{C as Rs}from"./chevron-up-DgjV3eGa.js";import{T as Hs}from"./type-DWs-uHqd.js";import{F as hs}from"./file-image-CUREGKCZ.js";import{A as Ys,a as Xs,b as Os}from"./align-right-D7bOis_1.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=he("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=he("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ss=he("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _s=he("Minimize",[["path",{d:"M8 3v3a2 2 0 0 1-2 2H3",key:"hohbtr"}],["path",{d:"M21 8h-3a2 2 0 0 1-2-2V3",key:"5jw1f3"}],["path",{d:"M3 16h3a2 2 0 0 1 2 2v3",key:"198tvr"}],["path",{d:"M16 21v-3a2 2 0 0 1 2-2h3",key:"ph8mxp"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bs=he("Share",[["path",{d:"M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8",key:"1b2hhj"}],["polyline",{points:"16 6 12 2 8 6",key:"m901s6"}],["line",{x1:"12",x2:"12",y1:"2",y2:"15",key:"1p0rca"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ts=he("SquareCheckBig",[["path",{d:"M21 10.5V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h12.5",key:"1uzm8b"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),Ks=1e3,as=({templateImage:s,fields:n,onFieldsChange:h,editorSettings:m,width:C,height:I,className:k="",showControls:L=!0,allowMultipleSelection:W=!0,allowResize:J=!0,onImageExport:G})=>{const P=g.useRef(null),u=g.useRef(null),M=g.useRef(null),{toast:y}=cs(),[T,$]=g.useState(null),[j,F]=g.useState({width:800,height:600}),[f,A]=g.useState(1),[se,d]=g.useState({x:0,y:0}),[c,S]=g.useState({}),[r,V]=g.useState([]),[X,O]=g.useState([]),[q,ee]=g.useState([]),[te,ae]=g.useState((m==null?void 0:m.gridEnabled)!==void 0?m.gridEnabled:!0),[le,ge]=g.useState((m==null?void 0:m.snapToGrid)!==void 0?m.snapToGrid:!0),o=(m==null?void 0:m.gridSize)||50,p=(m==null?void 0:m.snapThreshold)||10,D=le&&((m==null?void 0:m.snapToGrid)!==void 0?m.snapToGrid:!0);g.useEffect(()=>{const t=a=>{const l=new window.Image;l.crossOrigin="anonymous",l.onload=()=>{if(console.log(`تم تحميل الصورة بأبعاد: ${l.width}x${l.height}`),$(l),F({width:l.naturalWidth,height:l.naturalHeight}),P.current){const i=P.current.clientWidth,x=P.current.clientHeight||600,N=i/l.naturalWidth,v=x/l.naturalHeight,z=Math.min(N,v,1);console.log(`مقياس العرض: ${N.toFixed(2)}, مقياس الارتفاع: ${v.toFixed(2)}, المقياس المختار: ${z.toFixed(2)}`),A(z)}},l.onerror=i=>{console.error(`فشل تحميل الصورة: ${a}`,i),a!=="/logo.svg"&&(console.log("⚠️ جاري تحميل الصورة الافتراضية (شعار الموقع)..."),t("/logo.svg"))},l.src=a};t(s)},[s]),g.useEffect(()=>{const t=a=>{if(a.ctrlKey&&a.key==="z"){a.preventDefault(),Pe();return}if(a.ctrlKey&&a.key==="y"){a.preventDefault(),$e();return}const l=a.shiftKey?10:1;let i=0,x=0;a.key==="ArrowLeft"&&(i=-l),a.key==="ArrowRight"&&(i=l),a.key==="ArrowUp"&&(x=-l),a.key==="ArrowDown"&&(x=l),a.ctrlKey?d(N=>({x:N.x+i,y:N.y+x})):r.length>0&&(i!==0||x!==0)&&(a.preventDefault(),ms(i,x)),a.key==="+"&&A(N=>Math.min(N+.1,4)),a.key==="-"&&A(N=>Math.max(N-.1,.2)),(a.key==="Delete"||a.key==="Backspace")&&r.length>0&&(a.preventDefault(),Le()),a.ctrlKey&&a.key==="c"&&r.length>0&&(a.preventDefault(),We())};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[r,n]);const R=t=>{const a=t.position.x/100*j.width,l=t.position.y/100*j.height;return{x:a,y:l}},Q=(t,a)=>{const l=t/j.width*100,i=a/j.height*100;return{x:l,y:i}},E=()=>{O(t=>[...t,JSON.parse(JSON.stringify(n))]),ee([])},Pe=()=>{if(X.length===0)return;const t=X[X.length-1];O(a=>a.slice(0,-1)),ee(a=>[n,...a]),h(t)},$e=()=>{if(q.length===0)return;const t=q[0];ee(a=>a.slice(1)),O(a=>[...a,JSON.parse(JSON.stringify(n))]),h(t)},ms=(t,a)=>{E();const l=n.map(i=>{if(r.includes(i.id)){const x=R(i),N=x.x+t,v=x.y+a,z=Q(N,v);return{...i,position:{...i.position,x:z.x,y:z.y}}}return i});h(l)},je=(t,a)=>{E(),W&&t.evt.shiftKey?r.includes(a)?V(l=>l.filter(i=>i!==a)):V(l=>[...l,a]):r.includes(a)||V([a])},us=t=>{t.target===t.target.getStage()&&V([])},Ae=(t,a)=>{if(!D)return t;if(a==="x"){const l=Math.round(t/o)*o;if(Math.abs(t-l)<p)return l}else{const l=Math.round(t/o)*o;if(Math.abs(t-l)<p)return l}return t},Ve=(t,a)=>{if(!n.find(v=>v.id===a))return;const i={x:t.target.x(),y:t.target.y()},x=Ae(i.x,"x"),N=Ae(i.y,"y");x!==i.x||N!==i.y?(S({x:x!==i.x?x:void 0,y:N!==i.y?N:void 0,xType:"grid",yType:"grid"}),t.target.position({x,y:N})):S({})},Ee=(t,a)=>{const l=n.find(v=>v.id===a);if(!l)return;const i={x:t.target.x(),y:t.target.y()},x=Q(i.x,i.y),N=n.map(v=>{if(r.includes(v.id)){if(v.id===a)return{...v,position:{x:x.x,y:x.y,snapToGrid:l.position.snapToGrid}};{const z=R(l),U=R(v),me=i.x-z.x,_=i.y-z.y,pe={x:U.x+me,y:U.y+_},ne=Q(pe.x,pe.y);return{...v,position:{x:ne.x,y:ne.y,snapToGrid:v.position.snapToGrid}}}}return v});h(N),S({})},Le=()=>{if(r.length===0)return;E();const t=n.filter(a=>!r.includes(a.id));h(t),V([]),y==null||y({title:"تم الحذف",description:`تم حذف ${r.length} عنصر`,duration:2e3})},We=()=>{if(r.length===0)return;E();const t=n.reduce((i,x)=>Math.max(i,x.id),0),a=r.map(i=>{const x=n.find(U=>U.id===i);if(!x)return null;const N=R(x),v={x:N.x+20,y:N.y+20},z=Q(v.x,v.y);return{...x,id:t+1+r.indexOf(i),position:z,name:`${x.name}_copy`}}).filter(Boolean),l=[...n,...a];h(l),V(a.map(i=>i.id)),y==null||y({title:"تم النسخ",description:`تم نسخ ${a.length} عنصر`,duration:2e3})},Ge=t=>{if(r.length===0)return;E();const a=n.map(l=>{if(r.includes(l.id)){const i=l.zIndex||1;return{...l,zIndex:Math.max(1,i+t)}}return l});h(a),y==null||y({title:t>0?"تم رفع الطبقة":"تم خفض الطبقة",description:`تم تغيير طبقة ${r.length} عنصر`,duration:2e3})},gs=()=>{if(r.length===0)return;E();const t=r.every(l=>{const i=n.find(x=>x.id===l);return i&&i.visible!==!1}),a=n.map(l=>r.includes(l.id)?{...l,visible:!t}:l);h(a)},Re=t=>{if(r.length===0)return;E();const a=n.map(l=>{if(r.includes(l.id)){const x=((l.rotation||0)+t)%360;return{...l,rotation:x}}return l});h(a)},He=t=>{if(r.length===0)return;E();const a=n.map(l=>{if(r.includes(l.id)){if(l.type==="text"||l.type==="dropdown"||l.type==="radio"){const i=l.style||{},x=i.fontSize||24,N=i.maxWidth||200;return{...l,style:{...i,fontSize:Math.max(8,Math.round(x*t)),maxWidth:Math.max(50,Math.round(N*t))}}}else if(l.type==="image"){const i=l.style||{},x=i.imageMaxWidth||Math.round(j.width/4),N=i.imageMaxHeight||Math.round(j.height/4);return{...l,style:{...i,imageMaxWidth:Math.max(20,Math.round(x*t)),imageMaxHeight:Math.max(20,Math.round(N*t))}}}}return l});h(a)},js=()=>{if(!u.current)return;const t=[...r];V([]),setTimeout(()=>{const a=u.current.toDataURL({pixelRatio:2,mimeType:"image/png"});if(V(t),G)G(a);else{const l=document.createElement("a");l.download="template-preview.png",l.href=a,document.body.appendChild(l),l.click(),document.body.removeChild(l)}y==null||y({title:"تم تصدير الصورة",description:"تم تصدير الصورة بنجاح",duration:2e3})},50)},ps=t=>{if(t.ctrlKey){t.preventDefault();const l=t.deltaY>0?.9:1.1;A(i=>{const x=i*l;return Math.min(Math.max(.2,x),4)})}else d(a=>({x:a.x,y:a.y-t.deltaY}))};return e.jsxs("div",{className:`draggable-fields-preview-enhanced ${k}`,style:{position:"relative",width:"100%",height:I||"500px"},ref:P,onWheel:ps,children:[L&&e.jsxs("div",{className:"editor-toolbar bg-neutral-100 p-2 mb-2 rounded-md flex gap-2 justify-between flex-wrap",children:[e.jsxs("div",{className:"toolbar-left flex gap-2",children:[e.jsxs("div",{className:"tool-group flex items-center gap-1",children:[e.jsx("button",{className:`p-1 rounded ${X.length>0?"bg-blue-100 hover:bg-blue-200":"bg-gray-100 text-gray-400"}`,onClick:Pe,disabled:X.length===0,title:"التراجع عن آخر تغيير (Ctrl+Z)",children:e.jsx(Se,{className:"w-4 h-4"})}),e.jsx("button",{className:`p-1 rounded ${q.length>0?"bg-blue-100 hover:bg-blue-200":"bg-gray-100 text-gray-400"}`,onClick:$e,disabled:q.length===0,title:"إعادة التغيير (Ctrl+Y)",children:e.jsx(ze,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"h-4 w-px bg-gray-300 mx-1"}),e.jsxs("div",{className:"tool-group flex items-center gap-1",children:[e.jsx("button",{className:"p-1 rounded bg-blue-100 hover:bg-blue-200",onClick:()=>A(t=>Math.min(t+.1,4)),title:"تكبير (+)",children:e.jsx(Vs,{className:"w-4 h-4"})}),e.jsxs("span",{className:"text-xs bg-white px-1 rounded border",children:[Math.round(f*100),"%"]}),e.jsx("button",{className:"p-1 rounded bg-blue-100 hover:bg-blue-200",onClick:()=>A(t=>Math.max(t-.1,.2)),title:"تصغير (-)",children:e.jsx(Es,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"h-4 w-px bg-gray-300 mx-1"}),e.jsxs("div",{className:"tool-group flex items-center gap-1",children:[e.jsx("button",{className:`p-1 rounded ${r.length>0?"bg-blue-100 hover:bg-blue-200":"bg-gray-100 text-gray-400"}`,onClick:()=>Re(-15),disabled:r.length===0,title:"تدوير 15 درجة لليسار",children:e.jsx(Se,{className:"w-4 h-4"})}),e.jsx("button",{className:`p-1 rounded ${r.length>0?"bg-blue-100 hover:bg-blue-200":"bg-gray-100 text-gray-400"}`,onClick:()=>Re(15),disabled:r.length===0,title:"تدوير 15 درجة لليمين",children:e.jsx(ze,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"h-4 w-px bg-gray-300 mx-1"}),e.jsxs("div",{className:"tool-group flex items-center gap-1",children:[e.jsx("button",{className:`p-1 rounded ${r.length>0?"bg-blue-100 hover:bg-blue-200":"bg-gray-100 text-gray-400"}`,onClick:()=>He(1.1),disabled:r.length===0,title:"تكبير العناصر بنسبة 10%",children:e.jsx(Ls,{className:"w-4 h-4"})}),e.jsx("button",{className:`p-1 rounded ${r.length>0?"bg-blue-100 hover:bg-blue-200":"bg-gray-100 text-gray-400"}`,onClick:()=>He(.9),disabled:r.length===0,title:"تصغير العناصر بنسبة 10%",children:e.jsx(_s,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"toolbar-right flex gap-2",children:[e.jsxs("div",{className:"tool-group flex items-center gap-1",children:[e.jsx("button",{className:`p-1 rounded ${r.length>0?"bg-purple-100 hover:bg-purple-200":"bg-gray-100 text-gray-400"}`,onClick:()=>Ge(1),disabled:r.length===0,title:"رفع طبقة",children:e.jsx(De,{className:"w-4 h-4"})}),e.jsx("button",{className:`p-1 rounded ${r.length>0?"bg-purple-100 hover:bg-purple-200":"bg-gray-100 text-gray-400"}`,onClick:()=>Ge(-1),disabled:r.length===0,title:"خفض طبقة",children:e.jsx(Fe,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"h-4 w-px bg-gray-300 mx-1"}),e.jsxs("div",{className:"tool-group flex items-center gap-1",children:[e.jsx("button",{className:`p-1 rounded ${te?"bg-green-100 hover:bg-green-200":"bg-gray-100 hover:bg-gray-200"}`,onClick:()=>ae(!te),title:"إظهار/إخفاء الشبكة",children:e.jsx(Ns,{className:"w-4 h-4"})}),e.jsx("button",{className:`p-1 rounded ${le?"bg-green-100 hover:bg-green-200":"bg-gray-100 hover:bg-gray-200"}`,onClick:()=>ge(!le),title:"تفعيل/تعطيل التجاذب للشبكة",children:e.jsx(Ws,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"h-4 w-px bg-gray-300 mx-1"}),e.jsx("div",{className:"tool-group flex items-center gap-1",children:e.jsx("button",{className:`p-1 rounded ${r.length>0?"bg-amber-100 hover:bg-amber-200":"bg-gray-100 text-gray-400"}`,onClick:gs,disabled:r.length===0,title:"إظهار/إخفاء العناصر المحددة",children:r.length>0&&r.every(t=>{const a=n.find(l=>l.id===t);return a&&a.visible!==!1})?e.jsx(Te,{className:"w-4 h-4"}):e.jsx(ve,{className:"w-4 h-4"})})}),e.jsx("div",{className:"h-4 w-px bg-gray-300 mx-1"}),e.jsxs("div",{className:"tool-group flex items-center gap-1",children:[e.jsx("button",{className:`p-1 rounded ${r.length>0?"bg-amber-100 hover:bg-amber-200":"bg-gray-100 text-gray-400"}`,onClick:We,disabled:r.length===0,title:"نسخ العناصر المحددة",children:e.jsx(os,{className:"w-4 h-4"})}),e.jsx("button",{className:`p-1 rounded ${r.length>0?"bg-red-100 hover:bg-red-200":"bg-gray-100 text-gray-400"}`,onClick:Le,disabled:r.length===0,title:"حذف العناصر المحددة",children:e.jsx(ds,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"h-4 w-px bg-gray-300 mx-1"}),e.jsx("div",{className:"tool-group",children:e.jsxs("button",{className:"p-1 px-2 rounded bg-primary text-white hover:bg-primary/90 flex gap-1 items-center",onClick:js,title:"تصدير الصورة",children:[e.jsx(Ie,{className:"w-4 h-4"}),e.jsx("span",{className:"text-xs font-medium",children:"تصدير"})]})})]})]}),e.jsx("div",{className:"stage-container",style:{width:"100%",height:"calc(100% - 50px)",overflow:"hidden",background:"#f0f0f0",border:"1px solid #ddd",borderRadius:"8px"},children:e.jsx(Fs,{ref:u,width:j.width,height:j.height,scaleX:f,scaleY:f,x:se.x,y:se.y,onClick:us,style:{background:"#fff"},children:e.jsxs(Ds,{children:[T&&e.jsx(Ps,{image:T,width:j.width,height:j.height}),te&&e.jsxs(e.Fragment,{children:[Array.from({length:Math.ceil(j.width/o)+1}).map((t,a)=>e.jsx(ie,{x:a*o,y:0,points:[0,0,0,j.height],stroke:"#aaa",strokeWidth:.5,opacity:.5},`grid-v-${a}`)),Array.from({length:Math.ceil(j.height/o)+1}).map((t,a)=>e.jsx(ie,{x:0,y:a*o,points:[0,0,j.width,0],stroke:"#aaa",strokeWidth:.5,opacity:.5},`grid-h-${a}`)),e.jsx(ie,{x:j.width/2,y:0,points:[0,0,0,j.height],stroke:"#f55",strokeWidth:1,opacity:.5,dash:[5,5]}),e.jsx(ie,{x:0,y:j.height/2,points:[0,0,j.width,0],stroke:"#f55",strokeWidth:1,opacity:.5,dash:[5,5]})]}),c.x!==void 0&&e.jsx(ie,{x:c.x,y:0,points:[0,0,0,j.height],stroke:"#0a0",strokeWidth:1,dash:[5,5]}),c.y!==void 0&&e.jsx(ie,{x:0,y:c.y,points:[0,0,j.width,0],stroke:"#0a0",strokeWidth:1,dash:[5,5]}),n.sort((t,a)=>(t.zIndex||0)-(a.zIndex||0)).map(t=>{var l,i,x,N;if(t.visible===!1)return null;const a=R(t);if(t.type==="text"||t.type==="dropdown"||t.type==="radio"){const v=t.style||{},z=j.width/Ks,U=(v.fontSize||24)*z,me=v.fontFamily||"Cairo",_=v.fontWeight||"normal",pe=v.color||"black",ne=v.align||"center",Ne=(v.maxWidth||300)*z,ys=t.rotation||0,vs=t.type==="text"?t.defaultValue||t.placeholder||t.name:t.type==="dropdown"?`[قائمة: ${((i=(l=t.options)==null?void 0:l.find(B=>B.value===t.defaultValue))==null?void 0:i.label)||"اختيار من القائمة"}]`:`[اختيار: ${((N=(x=t.options)==null?void 0:x.find(B=>B.value===t.defaultValue))==null?void 0:N.label)||"خيار من المتاح"}]`;return e.jsx(qe,{x:a.x,y:a.y,draggable:!0,onDragStart:B=>je(B,t.id),onDragMove:B=>Ve(B,t.id),onDragEnd:B=>Ee(B,t.id),onClick:B=>je(B,t.id),rotation:ys,children:e.jsx(Qe,{text:vs,fontSize:U,fontFamily:me,fontStyle:_==="bold"?"bold":"normal",fill:pe,align:ne,width:Ne,offsetX:ne==="center"?Ne/2:ne==="right"?Ne:0,offsetY:U/2})},t.id)}else if(t.type==="image"){const v=t.style||{},z=v.imageMaxWidth||Math.round(j.width/4),U=v.imageMaxHeight||Math.round(j.height/4),me=t.rotation||0;return e.jsxs(qe,{x:a.x,y:a.y,draggable:!0,onDragStart:_=>je(_,t.id),onDragMove:_=>Ve(_,t.id),onDragEnd:_=>Ee(_,t.id),onClick:_=>je(_,t.id),rotation:me,children:[e.jsx($s,{width:z,height:U,offsetX:z/2,offsetY:U/2,fill:"#f5f5f5",stroke:"#ddd",strokeWidth:1,dash:[5,5]}),e.jsx(Qe,{text:`صورة: ${t.name}`,fontSize:14,fontFamily:"Cairo",fill:"#999",align:"center",width:z,offsetX:z/2,offsetY:8})]},t.id)}return null}),J&&r.length>0&&e.jsx(As,{ref:M,boundBoxFunc:(t,a)=>a.width<5||a.height<5?t:a})]})})})]})},Zs=1e3;function ls(s,n){const h=document.createElement("a");h.href=s,h.download=n,document.body.appendChild(h),h.click(),document.body.removeChild(h)}const ns=({fields:s,selectedFieldId:n,onSelectField:h,onMoveLayer:m,onToggleVisibility:C})=>{const I=[...s].sort((u,M)=>(M.zIndex||0)-(u.zIndex||0)),[k,L]=g.useState(null),[W,J]=g.useState(!1),G=u=>{L(u)},P=()=>{L(null)};return e.jsx(Me,{className:"h-[calc(100vh-100px)]",children:e.jsxs("div",{className:"p-2 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{variant:"ghost",size:"icon",onClick:()=>J(!W),className:"h-6 w-6 p-0",children:W?e.jsx(ws,{size:16}):e.jsx(Rs,{size:16})}),e.jsx("h3",{className:"text-sm font-semibold",children:"الطبقات"}),e.jsx(Ue,{variant:"secondary",className:"text-xs px-2",children:s.length})]}),e.jsxs(oe,{children:[e.jsx(de,{asChild:!0,children:e.jsx(b,{variant:"ghost",size:"icon",className:"h-6 w-6 p-0",children:e.jsx(Gs,{size:16})})}),e.jsx(xe,{side:"left",className:"max-w-[250px]",children:e.jsx("p",{className:"text-xs",children:"يمكنك تغيير ترتيب الطبقات هنا لوضع الحقول أمام أو خلف صورة القالب. الطبقات الأعلى في القائمة تظهر أمام الطبقات الأدنى."})})]})]}),!W&&e.jsxs("div",{className:"space-y-1",children:[I.map(u=>e.jsxs("div",{className:`flex items-center p-2 rounded-md transition-all duration-200 ${n===u.id?"bg-primary/15 border border-primary/30":k===u.id?"bg-secondary/20 border border-secondary/20":"hover:bg-accent border border-transparent"}`,onClick:()=>h(u.id),onMouseEnter:()=>G(u.id),onMouseLeave:P,children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{variant:"ghost",size:"icon",className:`h-6 w-6 p-0 ${u.visible===!1?"text-muted-foreground":"text-foreground"}`,onClick:M=>{M.stopPropagation(),C(u.id)},title:u.visible===!1?"إظهار الطبقة":"إخفاء الطبقة",children:u.visible===!1?e.jsx(ve,{size:14}):e.jsx(Te,{size:14})}),u.type==="text"&&e.jsx(Hs,{size:14,className:"text-blue-500"}),u.type==="image"&&e.jsx(xs,{size:14,className:"text-green-500"}),u.type==="template"&&e.jsx(hs,{size:14,className:"text-purple-500"}),e.jsx("span",{className:"text-xs font-medium truncate",children:u.type==="template"?"صورة القالب":u.label||u.name})]})}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(Ue,{variant:"outline",className:"text-xs px-2 py-0 bg-secondary/10",children:["z:",u.zIndex||0]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx(b,{variant:"ghost",size:"icon",className:"h-5 w-5 p-0",onClick:M=>{M.stopPropagation(),m(u.id,"up")},title:"نقل للأعلى",children:e.jsx(De,{size:12})}),e.jsx(b,{variant:"ghost",size:"icon",className:"h-5 w-5 p-0",onClick:M=>{M.stopPropagation(),m(u.id,"down")},title:"نقل للأسفل",children:e.jsx(Fe,{size:12})})]})]})]},u.id)),s.length===0&&e.jsxs("div",{className:"text-center p-4 text-muted-foreground border rounded-md border-dashed",children:[e.jsx("p",{className:"text-xs",children:"لا توجد طبقات متاحة"}),e.jsx("p",{className:"text-xs mt-1",children:"سيتم إضافة الطبقات عند تعيين الحقول"})]})]})]})})},is=({field:s,onUpdate:n,onDelete:h,onDuplicate:m,onToggleVisibility:C})=>{var I,k,L,W,J,G,P,u,M,y,T,$,j,F,f,A,se;return e.jsx(Me,{className:"max-h-[calc(100vh-100px)]",children:e.jsxs("div",{className:"p-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-sm font-medium",children:s.label||s.name}),e.jsxs("div",{className:"flex space-x-2 rtl:space-x-reverse",children:[e.jsx(ue,{children:e.jsxs(oe,{children:[e.jsx(de,{asChild:!0,children:e.jsx(b,{variant:"ghost",size:"icon",onClick:()=>C(s.id),children:s.visible===!1?e.jsx(ve,{size:16}):e.jsx(Te,{size:16})})}),e.jsx(xe,{children:e.jsx("p",{children:s.visible===!1?"إظهار":"إخفاء"})})]})}),e.jsx(ue,{children:e.jsxs(oe,{children:[e.jsx(de,{asChild:!0,children:e.jsx(b,{variant:"ghost",size:"icon",onClick:()=>m(s.id),children:e.jsx(os,{size:16})})}),e.jsx(xe,{children:e.jsx("p",{children:"نسخ الحقل"})})]})}),e.jsx(ue,{children:e.jsxs(oe,{children:[e.jsx(de,{asChild:!0,children:e.jsx(b,{variant:"ghost",size:"icon",className:"text-red-500 hover:text-red-700 hover:bg-red-50",onClick:()=>h(s.id),children:e.jsx(ds,{size:16})})}),e.jsx(xe,{children:e.jsx("p",{children:"حذف الحقل"})})]})})]})]}),e.jsxs(re,{defaultValue:"position",className:"w-full",children:[e.jsxs(ce,{className:"w-full grid grid-cols-3 mb-2",children:[e.jsx(K,{value:"position",children:"الموضع"}),e.jsx(K,{value:"appearance",children:"المظهر"}),e.jsx(K,{value:"format",children:"التنسيق"})]}),e.jsxs(Z,{value:"position",className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{children:"الموضع"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(w,{className:"text-xs",children:"X"}),e.jsx(H,{type:"number",value:s.position.x,onChange:d=>{const c=parseInt(d.target.value);isNaN(c)||n({...s,position:{...s.position,x:c}})}})]}),e.jsxs("div",{children:[e.jsx(w,{className:"text-xs",children:"Y"}),e.jsx(H,{type:"number",value:s.position.y,onChange:d=>{const c=parseInt(d.target.value);isNaN(c)||n({...s,position:{...s.position,y:c}})}})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{children:"الحجم"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(w,{className:"text-xs",children:"العرض"}),e.jsx(H,{type:"number",value:((I=s.size)==null?void 0:I.width)||(s.type==="template"?Zs:"auto"),disabled:s.type==="template",onChange:d=>{var S;if(s.type==="template")return;const c=d.target.value!==""?parseInt(d.target.value):0;n({...s,size:{width:isNaN(c)?0:c,height:((S=s.size)==null?void 0:S.height)||0}})}})]}),e.jsxs("div",{children:[e.jsx(w,{className:"text-xs",children:"الارتفاع"}),e.jsx(H,{type:"number",value:((k=s.size)==null?void 0:k.height)||"auto",disabled:s.type==="template",onChange:d=>{var S;if(s.type==="template")return;const c=d.target.value!==""?parseInt(d.target.value):0;n({...s,size:{width:((S=s.size)==null?void 0:S.width)||0,height:isNaN(c)?0:c}})}})]})]}),s.type==="template"&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"لا يمكن تغيير حجم صورة القالب"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(w,{children:"ترتيب الطبقة"}),e.jsxs("div",{className:"flex items-center space-x-2 rtl:space-x-reverse",children:[e.jsx(b,{variant:"outline",size:"icon",className:"h-7 w-7",onClick:()=>{n({...s,zIndex:(s.zIndex||0)+1})},children:e.jsx(De,{size:14})}),e.jsx(b,{variant:"outline",size:"icon",className:"h-7 w-7",onClick:()=>{n({...s,zIndex:Math.max(0,(s.zIndex||0)-1)})},children:e.jsx(Fe,{size:14})})]})]}),e.jsx(H,{type:"number",min:"0",value:s.zIndex||0,onChange:d=>{const c=parseInt(d.target.value);!isNaN(c)&&c>=0&&n({...s,zIndex:c})}})]})]}),e.jsxs(Z,{value:"appearance",className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(w,{children:"الدوران"}),e.jsxs("div",{className:"flex items-center space-x-2 rtl:space-x-reverse",children:[e.jsx(b,{variant:"outline",size:"icon",className:"h-7 w-7",onClick:()=>{n({...s,rotation:((s.rotation||0)-5)%360})},children:e.jsx(Se,{size:14})}),e.jsx(b,{variant:"outline",size:"icon",className:"h-7 w-7",onClick:()=>{n({...s,rotation:((s.rotation||0)+5)%360})},children:e.jsx(ze,{size:14})})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 rtl:space-x-reverse",children:[e.jsx(H,{type:"number",value:s.rotation||0,onChange:d=>{const c=parseInt(d.target.value);isNaN(c)||n({...s,rotation:c%360})}}),e.jsx("span",{className:"text-sm",children:"درجة"})]})]}),s.type==="text"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{children:"الخط"}),e.jsxs(we,{value:((L=s.style)==null?void 0:L.fontFamily)||"Cairo",onValueChange:d=>{n({...s,style:{...s.style,fontFamily:d}})},children:[e.jsx(fe,{children:e.jsx(Ce,{placeholder:"اختر الخط"})}),e.jsxs(ke,{children:[e.jsx(Y,{value:"Cairo",children:"Cairo"}),e.jsx(Y,{value:"Almarai",children:"Almarai"}),e.jsx(Y,{value:"Tajawal",children:"Tajawal"}),e.jsx(Y,{value:"Amiri",children:"Amiri"}),e.jsx(Y,{value:"Arial",children:"Arial"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{children:"حجم الخط"}),e.jsxs("div",{className:"flex items-center space-x-2 rtl:space-x-reverse",children:[e.jsx(H,{type:"number",value:((W=s.style)==null?void 0:W.fontSize)||24,onChange:d=>{const c=parseInt(d.target.value);!isNaN(c)&&c>0&&n({...s,style:{...s.style,fontSize:c}})}}),e.jsx("span",{className:"text-sm",children:"بكسل"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{children:"اللون"}),e.jsxs("div",{className:"flex items-center space-x-2 rtl:space-x-reverse",children:[e.jsx("input",{type:"color",value:((J=s.style)==null?void 0:J.color)||"#000000",onChange:d=>{n({...s,style:{...s.style,color:d.target.value}})},className:"w-10 h-10 rounded overflow-hidden"}),e.jsx(H,{value:((G=s.style)==null?void 0:G.color)||"#000000",onChange:d=>{n({...s,style:{...s.style,color:d.target.value}})}})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{children:"المحاذاة"}),e.jsxs("div",{className:"flex space-x-1 rtl:space-x-reverse",children:[e.jsxs(b,{variant:((P=s.style)==null?void 0:P.align)==="right"||!((u=s.style)!=null&&u.align)?"default":"outline",size:"sm",className:"flex-1",onClick:()=>{n({...s,style:{...s.style,align:"right"}})},children:[e.jsx(Ys,{size:16}),e.jsx("span",{className:"ms-2",children:"يمين"})]}),e.jsxs(b,{variant:((M=s.style)==null?void 0:M.align)==="center"?"default":"outline",size:"sm",className:"flex-1",onClick:()=>{n({...s,style:{...s.style,align:"center"}})},children:[e.jsx(Xs,{size:16}),e.jsx("span",{className:"ms-2",children:"وسط"})]}),e.jsxs(b,{variant:((y=s.style)==null?void 0:y.align)==="left"?"default":"outline",size:"sm",className:"flex-1",onClick:()=>{n({...s,style:{...s.style,align:"left"}})},children:[e.jsx(Os,{size:16}),e.jsx("span",{className:"ms-2",children:"يسار"})]})]})]})]})]}),e.jsx(Z,{value:"format",className:"space-y-4",children:s.type==="text"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(w,{children:"خط عريض"}),e.jsx(ye,{checked:((T=s.style)==null?void 0:T.fontWeight)==="bold",onCheckedChange:d=>{n({...s,style:{...s.style,fontWeight:d?"bold":"normal"}})}})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{children:"تباعد السطور"}),e.jsx(be,{value:[(($=s.style)==null?void 0:$.lineHeight)||1.2],min:.5,max:3,step:.1,onValueChange:d=>{n({...s,style:{...s.style,lineHeight:d[0]}})}}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-500 mt-1",children:[e.jsx("span",{children:"0.5"}),e.jsx("span",{children:((j=s.style)==null?void 0:j.lineHeight)||1.2}),e.jsx("span",{children:"3.0"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(w,{children:"الظل"}),e.jsx(ye,{checked:((f=(F=s.style)==null?void 0:F.textShadow)==null?void 0:f.enabled)||!1,onCheckedChange:d=>{var c,S,r,V,X,O,q,ee,te;n({...s,style:{...s.style,textShadow:{...((c=s.style)==null?void 0:c.textShadow)||{},enabled:d,color:((r=(S=s.style)==null?void 0:S.textShadow)==null?void 0:r.color)||"rgba(0,0,0,0.5)",blur:((X=(V=s.style)==null?void 0:V.textShadow)==null?void 0:X.blur)||3,offsetX:((q=(O=s.style)==null?void 0:O.textShadow)==null?void 0:q.offsetX)||2,offsetY:((te=(ee=s.style)==null?void 0:ee.textShadow)==null?void 0:te.offsetY)||2}}})}})]}),((se=(A=s.style)==null?void 0:A.textShadow)==null?void 0:se.enabled)&&e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(w,{className:"text-xs",children:"لون الظل"}),e.jsxs("div",{className:"flex items-center space-x-2 rtl:space-x-reverse",children:[e.jsx("input",{type:"color",value:s.style.textShadow.color||"#000000",onChange:d=>{n({...s,style:{...s.style,textShadow:{...s.style.textShadow,color:d.target.value}}})},className:"w-8 h-8 rounded overflow-hidden"}),e.jsx(H,{value:s.style.textShadow.color||"#000000",onChange:d=>{n({...s,style:{...s.style,textShadow:{...s.style.textShadow,color:d.target.value}}})},className:"flex-1"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(w,{className:"text-xs",children:"إزاحة X"}),e.jsx(H,{type:"number",value:s.style.textShadow.offsetX||0,onChange:d=>{const c=parseInt(d.target.value);isNaN(c)||n({...s,style:{...s.style,textShadow:{...s.style.textShadow,offsetX:c}}})}})]}),e.jsxs("div",{children:[e.jsx(w,{className:"text-xs",children:"إزاحة Y"}),e.jsx(H,{type:"number",value:s.style.textShadow.offsetY||0,onChange:d=>{const c=parseInt(d.target.value);isNaN(c)||n({...s,style:{...s.style,textShadow:{...s.style.textShadow,offsetY:c}}})}})]})]}),e.jsxs("div",{children:[e.jsx(w,{className:"text-xs",children:"ضبابية"}),e.jsx(H,{type:"number",min:"0",value:s.style.textShadow.blur||0,onChange:d=>{const c=parseInt(d.target.value);!isNaN(c)&&c>=0&&n({...s,style:{...s.style,textShadow:{...s.style.textShadow,blur:c}}})}})]})]})]})]})})]})]})})},rs=({template:s,fields:n,formData:h,onDownload:m})=>{const[C,I]=g.useState("medium"),[k,L]=g.useState(!1),[W,J]=g.useState(!1),[G,P]=g.useState(null),[u,M]=g.useState("png"),[y,T]=g.useState(!1);g.useEffect(()=>{const f=setTimeout(()=>{$()},500);return()=>clearTimeout(f)},[C,n]);const $=async()=>{J(!0);try{await new Promise(f=>setTimeout(f,800)),s.imageUrl&&P(s.imageUrl)}finally{J(!1)}},j=()=>{L(!0);try{m(C)}finally{L(!1)}},F=()=>{T(!0),setTimeout(()=>T(!1),2e3)};return e.jsx(Me,{className:"h-[calc(100vh-100px)]",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsx("div",{className:"flex flex-col items-center",children:e.jsxs(re,{defaultValue:"preview",className:"w-full",children:[e.jsxs(ce,{className:"w-full grid grid-cols-2",children:[e.jsxs(K,{value:"preview",children:[e.jsx(ve,{className:"w-4 h-4 mr-2"}),"معاينة"]}),e.jsxs(K,{value:"download",children:[e.jsx(Ie,{className:"w-4 h-4 mr-2"}),"تنزيل"]})]}),e.jsxs(Z,{value:"preview",className:"mt-4 space-y-4",children:[e.jsx("div",{className:"flex justify-center items-center mb-4 relative border rounded-lg bg-background/50 p-2 h-[300px] overflow-hidden",children:W?e.jsxs("div",{className:"flex flex-col items-center justify-center",children:[e.jsx(Be,{className:"h-10 w-10 animate-spin text-primary mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"جاري توليد المعاينة..."})]}):G?e.jsxs("div",{className:"relative max-h-full",children:[e.jsx("img",{src:G,alt:"معاينة البطاقة",className:"max-h-[280px] object-contain rounded shadow-md"}),e.jsx("div",{className:"absolute bottom-2 left-2 bg-primary/80 text-white text-xs px-2 py-1 rounded-sm",children:"معاينة"})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center text-muted-foreground",children:[e.jsx(hs,{className:"h-12 w-12 mb-2"}),e.jsx("p",{className:"text-sm",children:"لا توجد معاينة متاحة"}),e.jsx(b,{variant:"ghost",size:"sm",className:"mt-2",onClick:$,children:"توليد المعاينة"})]})}),e.jsxs(Ke,{children:[e.jsx(ss,{className:"h-4 w-4"}),e.jsx(Ze,{children:"معاينة مباشرة"}),e.jsx(Je,{className:"text-xs",children:'هذه معاينة للشكل النهائي للبطاقة. يمكنك تعديل الحقول في علامة التبويب "الخصائص" ورؤية التغييرات مباشرة هنا.'})]})]}),e.jsx(Z,{value:"download",className:"mt-4 space-y-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{children:"جودة التنزيل"}),e.jsxs(we,{value:C,onValueChange:f=>I(f),children:[e.jsx(fe,{children:e.jsx(Ce,{placeholder:"اختر جودة التنزيل"})}),e.jsxs(ke,{children:[e.jsx(Y,{value:"low",children:"منخفضة (سريعة)"}),e.jsx(Y,{value:"medium",children:"متوسطة"}),e.jsx(Y,{value:"high",children:"عالية"}),e.jsx(Y,{value:"download",children:"ممتازة (حجم كبير)"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{children:"صيغة الملف"}),e.jsxs(we,{value:u,onValueChange:M,children:[e.jsx(fe,{children:e.jsx(Ce,{placeholder:"اختر صيغة الملف"})}),e.jsxs(ke,{children:[e.jsx(Y,{value:"png",children:"PNG (شفاف)"}),e.jsx(Y,{value:"jpg",children:"JPG (جودة عالية)"}),e.jsx(Y,{value:"webp",children:"WebP (حجم صغير)"})]})]})]})]}),e.jsx(b,{className:"w-full",size:"lg",onClick:j,disabled:k,children:k?e.jsxs(e.Fragment,{children:[e.jsx(Be,{className:"mr-2 h-4 w-4 animate-spin"}),"جاري التنزيل..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ie,{className:"mr-2 h-4 w-4"}),"تنزيل الصورة"]})}),e.jsxs(Ke,{variant:"outline",className:"bg-secondary/10",children:[e.jsxs(Ze,{className:"flex items-center text-sm",children:[e.jsx(ss,{className:"h-4 w-4 mr-2"}),"ميزات الصيغ المختلفة"]}),e.jsx(Je,{children:e.jsxs("ul",{className:"list-disc list-inside text-xs space-y-1 mt-2",children:[e.jsxs("li",{children:[e.jsx("span",{className:"font-bold",children:"PNG:"})," يدعم الشفافية، مناسب للصور ذات التفاصيل الدقيقة"]}),e.jsxs("li",{children:[e.jsx("span",{className:"font-bold",children:"JPG:"})," حجم ملف أصغر، مناسب للصور الفوتوغرافية"]}),e.jsxs("li",{children:[e.jsx("span",{className:"font-bold",children:"WebP:"})," أفضل ضغط، يدعم الشفافية، مثالي للويب"]})]})})]})]})})]})}),e.jsx(fs,{className:"my-2"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"مشاركة"}),e.jsx("div",{className:"flex space-x-2 rtl:space-x-reverse",children:e.jsx(b,{variant:"outline",size:"sm",className:"flex-1",onClick:F,children:y?e.jsxs(e.Fragment,{children:[e.jsx(Cs,{className:"mr-2 h-4 w-4 text-green-500"}),"تم النسخ"]}):e.jsxs(e.Fragment,{children:[e.jsx(Bs,{className:"mr-2 h-4 w-4"}),"نسخ الرابط"]})})})]})]})})},Ct=s=>{var le,ge;const{toast:n}=cs(),[h,m]=g.useState([]),[C,I]=g.useState(null),[k,L]=g.useState(!0),[W,J]=g.useState(!0),[G,P]=g.useState("layers"),[u,M]=g.useState(null),[y,T]=g.useState(0),[$,j]=g.useState(!0),F="isOpen"in s,f=!F&&"onChange"in s,{formData:A={},readOnly:se=!1,embedded:d=!1}=F?{formData:{},...s}:s,c=F?(le=s.template)==null?void 0:le.id:s.templateId,S=F?(ge=s.template)==null?void 0:ge.imageUrl:s.templateImage;g.useEffect(()=>{if(F)s.fields&&(console.log("FieldsPositionEditor - استلام حقول في وضع الحوار:",s.fields),m(s.fields),s.fields.length>0&&!C&&I(s.fields[0].id));else if(s.initialFields){console.log("FieldsPositionEditor - استلام حقول في وضع المضمن:",s.initialFields);const o=s.initialFields.map(p=>({...p,visible:!0}));m(o),s.initialFields.length>0&&!C&&I(s.initialFields[0].id)}},[F?s.fields:s.initialFields,F]);const r=o=>{const p=h.map(D=>D.id===o.id?o:D);m(p),f&&s.onChange(p)},V=o=>{if(o===-1){n({title:"لا يمكن الحذف",description:"لا يمكن حذف صورة القالب",variant:"destructive"});return}const p=h.filter(D=>D.id!==o);m(p),C===o&&I(p.length>0?p[0].id:null),f&&s.onChange(p)},X=o=>{if(o===-1){n({title:"لا يمكن النسخ",description:"لا يمكن نسخ صورة القالب",variant:"destructive"});return}const p=h.find(E=>E.id===o);if(!p)return;const D=Math.max(...h.map(E=>E.id)),R={...p,id:D+1,name:`${p.name}_copy`,label:p.label?`${p.label} (نسخة)`:void 0,position:{...p.position,x:p.position.x+20,y:p.position.y+20}},Q=[...h,R];m(Q),I(R.id),f&&s.onChange(Q)},O=o=>{const p=h.map(D=>D.id===o?{...D,visible:D.visible===!1?void 0:!1}:D);m(p),f&&s.onChange(p)},q=(o,p)=>{const D=h.map(R=>{if(R.id===o){const Q=R.zIndex||0,E=p==="up"?Q+1:Math.max(0,Q-1);return{...R,zIndex:E}}return R});m(D),f&&s.onChange(D)},ee=async o=>{try{n({title:"جاري التوليد",description:`جاري توليد البطاقة بجودة ${o==="low"?"منخفضة":o==="medium"?"متوسطة":"عالية"}`});const p=`بطاقة-${c}-${new Date().getTime()}.png`;ls(u||S,p),n({title:"تم التوليد",description:"تم توليد البطاقة بنجاح وجاري التنزيل"})}catch(p){console.error("حدث خطأ أثناء توليد الصورة:",p),n({title:"خطأ في التوليد",description:"حدث خطأ أثناء توليد الصورة",variant:"destructive"})}},te=()=>{F&&s.onSave(h)},ae=C!==null?h.find(o=>o.id===C):void 0;return e.jsx("div",{children:F?e.jsx(ks,{open:s.isOpen,onOpenChange:s.onClose,children:e.jsxs(Ss,{className:"max-w-[95vw] w-[95vw] max-h-[95vh] overflow-hidden flex flex-col",children:[e.jsxs(zs,{children:[e.jsx(Is,{children:"تعديل تصميم البطاقة"}),e.jsx(Ms,{children:"قم بتخصيص موضع وشكل الحقول على البطاقة"})]}),e.jsx("div",{className:"flex-1 overflow-hidden mt-4 px-3 pb-3",children:e.jsxs("div",{className:"grid grid-cols-[20%_60%_20%] gap-4 h-full max-h-[85vh] overflow-hidden",children:[e.jsx("div",{className:"border rounded-lg p-2 bg-gray-50 flex flex-col w-full",children:e.jsxs(re,{value:G,onValueChange:P,className:"w-full",children:[e.jsx(ce,{className:"grid grid-cols-1 w-full mb-2",children:e.jsxs(K,{value:"layers",className:"text-xs",children:[e.jsx(es,{className:"w-4 h-4 mr-2"}),e.jsx("span",{children:"الطبقات"})]})}),e.jsx(Z,{value:"layers",className:"flex-1",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-2 border border-gray-200 rounded-md bg-gray-50",children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"إعدادات صورة القالب"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2 rtl:space-x-reverse",children:[e.jsx(w,{htmlFor:"dialogTemplateImageAsLayer",className:"flex-grow text-xs cursor-pointer",children:"معالجة صورة القالب كطبقة مستقلة"}),e.jsx(ye,{id:"dialogTemplateImageAsLayer",checked:$,onCheckedChange:j})]}),$&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{className:"text-xs",children:"موضع طبقة صورة القالب"}),e.jsxs("div",{className:"grid grid-cols-3 gap-1",children:[e.jsx(b,{variant:"outline",size:"sm",className:`text-xs ${y<0?"bg-blue-100":""}`,onClick:()=>T(-10),children:"خلف جميع الحقول"}),e.jsx(b,{variant:"outline",size:"sm",className:`text-xs ${y===0?"bg-blue-100":""}`,onClick:()=>T(0),children:"وسط"}),e.jsx(b,{variant:"outline",size:"sm",className:`text-xs ${y>0?"bg-blue-100":""}`,onClick:()=>T(10),children:"أمام جميع الحقول"})]}),e.jsxs("div",{className:"pt-2",children:[e.jsx(w,{className:"text-xs mb-1 block",children:"تعديل دقيق لمستوى الطبقة"}),e.jsx(be,{value:[y],onValueChange:o=>T(o[0]),min:-20,max:20,step:1,className:"my-2"}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-500",children:[e.jsx("span",{children:"خلف (-20)"}),e.jsx("span",{children:y}),e.jsx("span",{children:"أمام (20)"})]})]})]})]})]}),e.jsx(ns,{fields:h,selectedFieldId:C,onSelectField:I,onMoveLayer:q,onToggleVisibility:O})]})})]})}),e.jsxs(Ye,{className:"flex flex-col h-full max-h-[75vh] overflow-hidden",children:[e.jsx(Xe,{className:"py-2 px-4",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(Oe,{className:"text-lg",children:"محرر الحقول"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(ue,{children:e.jsxs(oe,{children:[e.jsx(de,{asChild:!0,children:e.jsx(b,{variant:"ghost",size:"icon",onClick:()=>L(!k),children:e.jsx(ts,{className:k?"text-blue-600":"text-gray-400",size:18})})}),e.jsx(xe,{children:k?"إخفاء الشبكة":"إظهار الشبكة"})]})})})]})}),e.jsx(_e,{className:"flex-grow relative p-0",children:e.jsx(as,{fields:h,templateImage:S,formData:A,editorSettings:{gridEnabled:k,snapToGrid:W,templateImageLayer:y,templateImageAsLayer:$},onFieldsChange:o=>{m(o),f&&s.onChange(o)},onFieldSelect:I,selectedFieldId:C,readOnly:se,onGeneratePreview:o=>M(o)})})]}),e.jsx("div",{className:"border rounded-lg p-2 bg-gray-50 flex flex-col w-full",children:e.jsxs(re,{defaultValue:"properties",className:"w-full h-full flex flex-col",children:[e.jsxs(ce,{className:"grid grid-cols-1 w-full mb-2",children:[e.jsxs(K,{value:"properties",className:"text-xs",children:[e.jsx(bs,{className:"w-4 h-4 mr-2"}),e.jsx("span",{children:"الخصائص"})]}),e.jsxs(K,{value:"preview",className:"text-xs",children:[e.jsx(xs,{className:"w-4 h-4 mr-2"}),e.jsx("span",{children:"المعاينة"})]})]}),e.jsx(Z,{value:"properties",className:"flex-1 overflow-hidden",children:ae?e.jsx(is,{field:ae,onUpdate:r,onDelete:V,onDuplicate:X,onToggleVisibility:O}):e.jsx("div",{className:"flex items-center justify-center h-full text-sm text-gray-500",children:"اختر حقلاً لعرض خصائصه"})}),e.jsx(Z,{value:"preview",className:"flex-1 overflow-hidden",children:e.jsx(rs,{template:{id:c,imageUrl:S},fields:h,formData:A,onDownload:ee})})]})})]})}),e.jsxs(Ts,{children:[e.jsx(b,{variant:"outline",onClick:s.onClose,className:"mr-2",children:"إلغاء"}),e.jsx(b,{onClick:te,children:"حفظ التغييرات"})]})]})}):e.jsxs("div",{className:"grid grid-cols-[15%_70%_15%] gap-2 h-full min-h-[calc(100vh-50px)] w-full overflow-hidden",children:[e.jsx("div",{className:"border rounded-lg p-2 bg-gray-50 flex flex-col",children:e.jsxs(re,{value:G,onValueChange:P,className:"w-full",children:[e.jsx(ce,{className:"grid grid-cols-1 w-full mb-2",children:e.jsxs(K,{value:"layers",className:"text-xs",children:[e.jsx(es,{className:"w-4 h-4 mr-2"}),e.jsx("span",{children:"الطبقات"})]})}),e.jsx(Z,{value:"layers",className:"flex-1",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-2 border border-gray-200 rounded-md bg-gray-50",children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"إعدادات صورة القالب"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2 rtl:space-x-reverse",children:[e.jsx(w,{htmlFor:"templateImageAsLayer",className:"flex-grow text-xs cursor-pointer",children:"معالجة صورة القالب كطبقة مستقلة"}),e.jsx(ye,{id:"templateImageAsLayer",checked:$,onCheckedChange:j})]}),$&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{className:"text-xs",children:"موضع طبقة صورة القالب"}),e.jsxs("div",{className:"grid grid-cols-3 gap-1",children:[e.jsx(b,{variant:"outline",size:"sm",className:`text-xs ${y<0?"bg-blue-100":""}`,onClick:()=>T(-10),children:"خلف جميع الحقول"}),e.jsx(b,{variant:"outline",size:"sm",className:`text-xs ${y===0?"bg-blue-100":""}`,onClick:()=>T(0),children:"وسط"}),e.jsx(b,{variant:"outline",size:"sm",className:`text-xs ${y>0?"bg-blue-100":""}`,onClick:()=>T(10),children:"أمام جميع الحقول"})]}),e.jsxs("div",{className:"pt-2",children:[e.jsx(w,{className:"text-xs mb-1 block",children:"تعديل دقيق لمستوى الطبقة"}),e.jsx(be,{value:[y],onValueChange:o=>T(o[0]),min:-20,max:20,step:1,className:"my-2"}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-500",children:[e.jsx("span",{children:"خلف (-20)"}),e.jsx("span",{children:y}),e.jsx("span",{children:"أمام (20)"})]})]})]})]})]}),e.jsx(ns,{fields:h,selectedFieldId:C,onSelectField:I,onMoveLayer:q,onToggleVisibility:O})]})})]})}),e.jsxs(Ye,{className:"flex flex-col h-full min-h-[calc(100vh-50px)] overflow-hidden",children:[e.jsx(Xe,{className:"py-2 px-4",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(Oe,{className:"text-lg",children:"محرر الحقول"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(ue,{children:e.jsxs(oe,{children:[e.jsx(de,{asChild:!0,children:e.jsx(b,{variant:"ghost",size:"icon",onClick:()=>L(!k),children:e.jsx(ts,{className:k?"text-blue-600":"text-gray-400",size:18})})}),e.jsx(xe,{children:k?"إخفاء الشبكة":"إظهار الشبكة"})]})})})]})}),e.jsx(_e,{className:"flex-grow relative p-0",children:e.jsx(as,{fields:h,templateImage:S,formData:A,editorSettings:{gridEnabled:k,snapToGrid:W,templateImageLayer:y,templateImageAsLayer:$},onFieldsChange:o=>{m(o),f&&s.onChange(o)},onFieldSelect:I,selectedFieldId:C,readOnly:se,onGeneratePreview:o=>M(o)})})]}),e.jsx("div",{className:"border rounded-lg p-2 bg-gray-50 flex flex-col min-w-[320px] max-w-[350px] w-full",children:e.jsxs(re,{defaultValue:"properties",className:"w-full h-full flex flex-col",children:[e.jsxs(ce,{className:"grid grid-cols-2 w-full mb-2",children:[e.jsx(K,{value:"properties",className:"text-xs",children:e.jsx("span",{children:"الخصائص"})}),e.jsx(K,{value:"preview",className:"text-xs",children:e.jsx("span",{children:"المعاينة"})})]}),e.jsx(Z,{value:"properties",className:"flex-1 overflow-auto max-h-[calc(100vh-200px)]",children:ae?e.jsx(is,{field:ae,onUpdate:r,onDelete:V,onDuplicate:X,onToggleVisibility:O}):e.jsx("div",{className:"flex items-center justify-center h-full text-sm text-gray-500",children:"اختر حقلاً لعرض خصائصه"})}),e.jsx(Z,{value:"preview",className:"flex-1 overflow-hidden",children:e.jsx(rs,{template:{id:c,imageUrl:S},fields:h,formData:A,onDownload:ee})})]})})]})})};export{De as A,Ct as F,Fe as a};
