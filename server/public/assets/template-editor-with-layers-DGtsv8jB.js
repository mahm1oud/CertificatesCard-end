import{n as ls,r as h,j as e,B as N,G as is,C as ke,s as Te,t as We,v as Ee,d as Re,o as ns,a as rs,b as Oe,h as os,R as Ye,i as ds,c as Pe,S as cs,e as ms,l as Le}from"./index-DoMHCGG2.js";import{S as xs,L as hs,R as Me,G as Se,I as us,a as gs,T as _e,b as He}from"./ReactKonvaCore-0IBzjN_D.js";import{Z as ps,a as js,E as Je}from"./zoom-out-eiDS2u6d.js";import{M as fs}from"./magnet-CnbLQg6V.js";import{D as ys}from"./download-CkzZtpS5.js";import{M as vs,a as ws}from"./move-up-DPWnyieo.js";import{E as bs}from"./eye-Co1cENxs.js";import{L as Ns}from"./LayersPanelSimple--Odr3nqg.js";import{I as p}from"./input-COMsjQRu.js";import{L as d}from"./label-DSWK9Bhr.js";import{S as U}from"./slider-ef3OeGSW.js";import{S as O}from"./switch-DKvoDZdm.js";import{S as Ue,a as qe,b as Ze,c as Ke,d as Ce}from"./select-CRu623qS.js";import{T as es,a as ss,b as de,c as ce}from"./tabs-CKJmMpcu.js";import{A as Qe,a as Ie,b as Fe,c as ze}from"./accordion-Chl2UIcD.js";import{S as Ge}from"./scroll-area-BaWF6YIt.js";import{T as as}from"./type-DWs-uHqd.js";import{I as ts}from"./image-CRCqvbIG.js";import{A as Ss,a as Cs,b as Is}from"./align-right-D7bOis_1.js";import{C as Fs}from"./circle-x-Chn3MoxU.js";import{S as zs}from"./save-CRRscGsZ.js";import{L as ks}from"./layers-D3_CD2xn.js";import"./lock-6HL3vJPU.js";import"./chevron-up-DgjV3eGa.js";import"./index-BdQq_4o_.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ts=ls("LayoutTemplate",[["rect",{width:"18",height:"7",x:"3",y:"3",rx:"1",key:"f1a2em"}],["rect",{width:"9",height:"7",x:"3",y:"14",rx:"1",key:"jqznyg"}],["rect",{width:"5",height:"7",x:"16",y:"14",rx:"1",key:"q5h2i8"}]]),Ws=1e3,Es=({templateImage:f,fields:o,onFieldsChange:k,editorSettings:s={gridEnabled:!0,snapToGrid:!0,gridSize:50,snapThreshold:10},showControls:u=!0,allowMultipleSelection:w=!0,allowResize:Y=!0,onImageExport:l,selectedFieldId:L,onSelectedFieldChange:S,templateImageLayer:T=0,isTemplateImageVisible:W=!0,onTemplateImageLayerChange:P,onTemplateImageVisibilityChange:C})=>{const I=h.useRef(null),$=h.useRef(null),F=h.useRef(null),R=h.useRef(null),[y,g]=h.useState([]),[b,q]=h.useState({width:1e3,height:600}),[G,c]=h.useState(1),[m,M]=h.useState({x:0,y:0}),[E,Z]=h.useState(null),[_,K]=h.useState(!1),[V,me]=h.useState({width:0,height:0}),[X,xe]=h.useState({x:0,y:0});h.useEffect(()=>{if(!f){K(!1),Z(null);return}const t=new Image;t.crossOrigin="Anonymous",t.src=f,t.onload=()=>{Z(t),K(!0);const r=t.width/t.height,i=Ws,j=i/r;me({width:i,height:j}),xe({x:0,y:0}),q({width:i,height:j})},t.onerror=()=>{K(!1),Z(null)}},[f]);const ee=h.useMemo(()=>({id:-1,name:"template_image",label:"صورة القالب",type:"template",position:X,zIndex:T,visible:W,rotation:0,size:V}),[X,T,V,W]),he=h.useMemo(()=>_&&E?[ee,...o]:o,[ee,o,_,E]);h.useEffect(()=>{L!==void 0&&g(L===null?[]:[L])},[L]),h.useEffect(()=>{var r;if(!F.current||!I.current)return;const t=y.map(i=>{var j;return(j=I.current)==null?void 0:j.findOne(`#field-${i}`)}).filter(Boolean);if(F.current.nodes(t),(r=F.current.getLayer())==null||r.batchDraw(),S)if(y.length===0)S(null);else{const i=y[0];i!==-1&&S(i)}},[y,S]);const se=t=>{if(!(s!=null&&s.snapToGrid))return t;const r=(s==null?void 0:s.gridSize)||50;return{x:Math.round(t.x/r)*r,y:Math.round(t.y/r)*r}},ue=(t,r)=>{if(t.visible===!1)return null;const i=t.style||{},j=t.defaultValue||t.label||t.placeholder||t.name,z=i.fontSize||24,v=i.fontFamily||"Cairo",B=i.fontWeight||"normal",Q=i.color||"#000",ve=i.maxWidth||300,we=i.align||"center";return e.jsx(Se,{id:`field-${t.id}`,x:t.position.x,y:t.position.y,rotation:t.rotation||0,draggable:!t.locked&&u,onDragStart:()=>{w||g([t.id])},onDragEnd:H=>{const be=se({x:H.target.x(),y:H.target.y()}),Ne=o.map(J=>J.id===t.id?{...J,position:be}:J);k(Ne)},onClick:()=>{w?y.includes(t.id)?g(y.filter(H=>H!==t.id)):g([...y,t.id]):g([t.id])},onTap:()=>{g([t.id])},children:e.jsx(_e,{text:j,fontSize:z,fontFamily:v,fontStyle:B,fill:Q,width:ve,align:we,verticalAlign:"middle",padding:10,wrap:"word"})},t.id)},ge=(t,r)=>t.visible===!1?null:t.defaultValue?(t.style,null):e.jsxs(Se,{id:`field-${t.id}`,x:t.position.x,y:t.position.y,rotation:t.rotation||0,draggable:!t.locked&&u,onDragStart:()=>{w||g([t.id])},onDragEnd:i=>{const j=se({x:i.target.x(),y:i.target.y()}),z=o.map(v=>v.id===t.id?{...v,position:j}:v);k(z)},onClick:()=>{w?y.includes(t.id)?g(y.filter(i=>i!==t.id)):g([...y,t.id]):g([t.id])},onTap:()=>{g([t.id])},children:[e.jsx(Me,{width:100,height:100,fill:"#f0f0f0",stroke:"#ddd",strokeWidth:1,cornerRadius:4,dash:[5,5]}),e.jsx(_e,{text:"صورة",fontSize:14,fontFamily:"Cairo",fill:"#999",width:100,align:"center",verticalAlign:"middle",y:40})]},t.id),pe=()=>{if(!(s!=null&&s.gridEnabled))return null;const t=(s==null?void 0:s.gridSize)||50,r=[];for(let i=0;i<b.width;i+=t)r.push(e.jsx(He,{points:[i,0,i,b.height],stroke:"#ddd",strokeWidth:1},`v-${i}`));for(let i=0;i<b.height;i+=t)r.push(e.jsx(He,{points:[0,i,b.width,i],stroke:"#ddd",strokeWidth:1},`h-${i}`));return e.jsx(e.Fragment,{children:r})},je=t=>{const r=t.target,i=parseInt(r.id().replace("field-",""));if(!o.find(v=>v.id===i))return;const z=o.map(v=>v.id===i?{...v,position:{x:r.x(),y:r.y()},rotation:r.rotation()}:v);k(z)},fe=()=>{var t;!I.current||!l||(g([]),F.current&&(F.current.nodes([]),(t=F.current.getLayer())==null||t.batchDraw()),setTimeout(()=>{var i;const r=(i=I.current)==null?void 0:i.toDataURL({pixelRatio:2,mimeType:"image/png"});r&&l&&l(r)},10))},ae=t=>{const r=t==="up"?T+1:T-1;P&&P(r)},ye=()=>{C&&C(!W)};return e.jsxs("div",{className:"draggable-fields-preview-with-layers",ref:R,children:[u&&e.jsxs("div",{className:"controls bg-muted/80 p-2 rounded-md mb-2 flex flex-wrap gap-2",children:[e.jsx(N,{variant:"outline",size:"sm",onClick:()=>c(G+.1),title:"تكبير",children:e.jsx(ps,{className:"w-4 h-4"})}),e.jsx(N,{variant:"outline",size:"sm",onClick:()=>c(Math.max(.2,G-.1)),title:"تصغير",children:e.jsx(js,{className:"w-4 h-4"})}),e.jsx("div",{className:"h-6 w-px bg-border mx-1"}),e.jsx(N,{variant:"outline",size:"sm",onClick:()=>k([...o]),title:s!=null&&s.gridEnabled?"إخفاء الشبكة":"إظهار الشبكة",className:s!=null&&s.gridEnabled?"bg-muted/50":void 0,children:e.jsx(is,{className:"w-4 h-4"})}),e.jsx(N,{variant:"outline",size:"sm",onClick:()=>k([...o]),title:s!=null&&s.snapToGrid?"إلغاء الالتصاق بالشبكة":"تفعيل الالتصاق بالشبكة",className:s!=null&&s.snapToGrid?"bg-muted/50":void 0,children:e.jsx(fs,{className:"w-4 h-4"})}),e.jsx("div",{className:"h-6 w-px bg-border mx-1"}),e.jsx(N,{variant:"outline",size:"sm",onClick:fe,title:"تصدير صورة",children:e.jsx(ys,{className:"w-4 h-4"})}),e.jsx("div",{className:"h-6 w-px bg-border mx-1"}),e.jsx(N,{variant:"outline",size:"sm",onClick:()=>ae("up"),title:"رفع صورة القالب للأمام",children:e.jsx(vs,{className:"w-4 h-4"})}),e.jsx(N,{variant:"outline",size:"sm",onClick:()=>ae("down"),title:"إرجاع صورة القالب للخلف",children:e.jsx(ws,{className:"w-4 h-4"})}),e.jsx(N,{variant:"outline",size:"sm",onClick:ye,title:W?"إخفاء صورة القالب":"إظهار صورة القالب",children:W?e.jsx(bs,{className:"w-4 h-4"}):e.jsx(Je,{className:"w-4 h-4"})})]}),u&&e.jsxs("div",{className:"layer-info text-xs mb-1 text-muted-foreground",children:["طبقة القالب: ",T," | الحالة: ",W?"مرئية":"مخفية"]}),e.jsx("div",{className:"stage-container bg-white border rounded-md overflow-hidden",style:{width:"100%",height:"600px",position:"relative"},children:e.jsx(xs,{ref:I,width:b.width,height:b.height,scale:{x:G,y:G},position:m,draggable:u,onDragEnd:t=>{M({x:t.target.x(),y:t.target.y()})},onClick:t=>{t.target===t.currentTarget&&g([])},onWheel:t=>{t.evt.preventDefault();const r=1.05,i=I.current;if(!i)return;const j=i.scaleX(),z=i.getPointerPosition();if(!z)return;const v={x:(z.x-i.x())/j,y:(z.y-i.y())/j},B=t.evt.deltaY<0?j*r:j/r;c(B);const Q={x:z.x-v.x*B,y:z.y-v.y*B};M(Q)},children:e.jsxs(hs,{ref:$,children:[e.jsx(Me,{x:0,y:0,width:b.width,height:b.height,fill:"white"}),_&&E&&e.jsx(Me,{x:X.x,y:X.y,width:V.width,height:V.height,fill:"#f8f8f8",stroke:"#e0e0e0",strokeWidth:1,dash:[5,5],cornerRadius:4}),pe(),e.jsxs(Se,{children:[he.sort((t,r)=>(t.zIndex||0)-(r.zIndex||0)).map((t,r)=>t.type==="text"?ue(t):t.type==="image"?ge(t):t.type==="template"&&_&&E&&W?e.jsx(Se,{id:"field--1",children:e.jsx(us,{image:E,width:V.width,height:V.height,x:X.x,y:X.y,listening:!1})},"template-image-group"):null),u&&Y&&e.jsx(gs,{ref:F,rotateEnabled:!0,resizeEnabled:!1,boundBoxFunc:(t,r)=>r,onTransformEnd:je})]})]})})})]})},Ls=({field:f,onFieldUpdate:o,availableFonts:k=["Cairo","Tajawal","Arial","sans-serif"]})=>{var L,S,T,W,P,C,I,$,F,R,y,g,b,q,G,c,m,M,E,Z,_,K,V,me,X,xe,ee,he,se,ue,ge,pe,je,fe,ae,ye,t,r,i,j,z,v,B,Q,ve,we,H,be,Ne,J,Ve,Xe,$e,Be,De;const[s,u]=h.useState(null),[w,Y]=h.useState("general");h.useEffect(()=>{u(f?{...f}:null)},[f]);const l=(a,x,n)=>{if(s)if(n&&a==="style"){const A={...s.style,[n]:x},D={...s,style:A};u(D),o(D)}else{const A={...s,[a]:x};u(A),o(A)}};return s?s.type==="template"?e.jsxs(ke,{className:"h-full",children:[e.jsxs(Te,{children:[e.jsx(We,{children:"صورة القالب"}),e.jsx(Ee,{children:"خصائص صورة القالب الأساسية"})]}),e.jsx(Re,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{htmlFor:"zIndex",children:"ترتيب الطبقة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(p,{id:"zIndex",type:"number",value:s.zIndex||0,onChange:a=>l("zIndex",parseInt(a.target.value)),min:-100,max:100}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.zIndex===0?"وسط الطبقات":s.zIndex&&s.zIndex>0?"فوق":"تحت"})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"ضع قيمة موجبة لوضع صورة القالب فوق الحقول، أو قيمة سالبة لوضعها تحت الحقول"})]}),e.jsx("div",{className:"grid gap-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(d,{htmlFor:"visible",className:"flex-1",children:"إظهار صورة القالب"}),e.jsx(O,{id:"visible",checked:s.visible!==!1,onCheckedChange:a=>l("visible",a)})]})})]})})]}):e.jsxs(ke,{className:"h-full flex flex-col",children:[e.jsxs(Te,{className:"pb-3",children:[e.jsxs("div",{className:"flex items-center",children:[s.type==="text"?e.jsx(as,{className:"h-5 w-5 mr-2 text-primary"}):e.jsx(ts,{className:"h-5 w-5 mr-2 text-primary"}),e.jsx(We,{children:"خصائص الحقل"})]}),e.jsxs(Ee,{children:[s.label||s.name,!s.visible&&e.jsxs("span",{className:"inline-flex items-center ml-2 text-xs text-amber-500",children:[e.jsx(Je,{className:"h-3 w-3 mr-1"})," مخفي"]})]})]}),e.jsxs(es,{value:w,onValueChange:Y,className:"flex-1 flex flex-col",children:[e.jsxs(ss,{className:"mx-4 mb-2",children:[e.jsx(de,{value:"general",children:"عام"}),e.jsx(de,{value:"style",children:"المظهر"}),e.jsx(de,{value:"position",children:"الموقع"})]}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsx(Ge,{className:"h-[calc(100vh-400px)] min-h-[280px]",children:e.jsxs("div",{className:"px-6 pb-6",children:[e.jsxs(ce,{value:"general",className:"m-0 space-y-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{htmlFor:"name",children:"الاسم التقني (البرمجي)"}),e.jsx(p,{id:"name",value:s.name,onChange:a=>l("name",a.target.value)})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{htmlFor:"label",children:"التسمية (بالعربية)"}),e.jsx(p,{id:"label",value:s.label||"",onChange:a=>l("label",a.target.value),dir:"rtl"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{htmlFor:"defaultValue",children:"القيمة الافتراضية"}),e.jsx(p,{id:"defaultValue",value:s.defaultValue||"",onChange:a=>l("defaultValue",a.target.value),dir:"auto"})]}),e.jsx("div",{className:"grid gap-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(d,{htmlFor:"visible",className:"flex-1",children:"مرئي"}),e.jsx(O,{id:"visible",checked:s.visible!==!1,onCheckedChange:a=>l("visible",a)})]})}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{htmlFor:"zIndex",children:"ترتيب الطبقة"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(p,{id:"zIndex",type:"number",value:s.zIndex||0,onChange:a=>l("zIndex",parseInt(a.target.value)),min:-100,max:100})})]})]}),e.jsxs(ce,{value:"style",className:"m-0 space-y-4",children:[s.type==="text"&&e.jsx(e.Fragment,{children:e.jsxs(Qe,{type:"single",collapsible:!0,defaultValue:"font",children:[e.jsxs(Ie,{value:"font",children:[e.jsx(Fe,{children:"الخط والنص"}),e.jsxs(ze,{className:"space-y-4 pt-2",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{htmlFor:"fontFamily",children:"نوع الخط"}),e.jsxs(Ue,{value:((L=s.style)==null?void 0:L.fontFamily)||"Cairo",onValueChange:a=>l("style",a,"fontFamily"),children:[e.jsx(qe,{id:"fontFamily",children:e.jsx(Ze,{placeholder:"اختر نوع الخط"})}),e.jsx(Ke,{children:k.map(a=>e.jsx(Ce,{value:a,style:{fontFamily:a},children:a},a))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs(d,{htmlFor:"fontSize",children:["حجم الخط (",((S=s.style)==null?void 0:S.fontSize)||24,"px)"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{id:"fontSize",min:8,max:72,step:1,value:[((T=s.style)==null?void 0:T.fontSize)||24],onValueChange:([a])=>l("style",a,"fontSize")}),e.jsx(p,{type:"number",value:((W=s.style)==null?void 0:W.fontSize)||24,onChange:a=>l("style",parseInt(a.target.value),"fontSize"),className:"w-16",min:8,max:72})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{htmlFor:"fontWeight",children:"وزن الخط"}),e.jsxs(Ue,{value:((P=s.style)==null?void 0:P.fontWeight)||"normal",onValueChange:a=>l("style",a,"fontWeight"),children:[e.jsx(qe,{id:"fontWeight",children:e.jsx(Ze,{placeholder:"اختر وزن الخط"})}),e.jsxs(Ke,{children:[e.jsx(Ce,{value:"normal",children:"عادي"}),e.jsx(Ce,{value:"bold",children:"غامق"}),e.jsx(Ce,{value:"lighter",children:"خفيف"})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{htmlFor:"color",children:"لون النص"}),e.jsx(Ae,{color:((C=s.style)==null?void 0:C.color)||"#000000",onChange:a=>l("style",a,"color")})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{htmlFor:"align",children:"محاذاة النص"}),e.jsxs("div",{className:"flex items-center rounded-md border p-1",children:[e.jsx(N,{type:"button",variant:((I=s.style)==null?void 0:I.align)==="right"?"default":"ghost",size:"sm",className:"flex-1",onClick:()=>l("style","right","align"),children:e.jsx(Ss,{className:"h-4 w-4"})}),e.jsx(N,{type:"button",variant:(($=s.style)==null?void 0:$.align)==="center"?"default":"ghost",size:"sm",className:"flex-1",onClick:()=>l("style","center","align"),children:e.jsx(Cs,{className:"h-4 w-4"})}),e.jsx(N,{type:"button",variant:((F=s.style)==null?void 0:F.align)==="left"?"default":"ghost",size:"sm",className:"flex-1",onClick:()=>l("style","left","align"),children:e.jsx(Is,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs(d,{htmlFor:"maxWidth",children:["الحد الأقصى للعرض (",((R=s.style)==null?void 0:R.maxWidth)||300,"px)"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{id:"maxWidth",min:50,max:800,step:10,value:[((y=s.style)==null?void 0:y.maxWidth)||300],onValueChange:([a])=>l("style",a,"maxWidth")}),e.jsx(p,{type:"number",value:((g=s.style)==null?void 0:g.maxWidth)||300,onChange:a=>l("style",parseInt(a.target.value),"maxWidth"),className:"w-16",min:50,max:800})]})]})]})]}),e.jsxs(Ie,{value:"textShadow",children:[e.jsx(Fe,{children:"ظل النص"}),e.jsxs(ze,{className:"space-y-4 pt-2",children:[e.jsx("div",{className:"grid gap-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(d,{htmlFor:"textShadowEnabled",className:"flex-1",children:"تفعيل ظل النص"}),e.jsx(O,{id:"textShadowEnabled",checked:((q=(b=s.style)==null?void 0:b.textShadow)==null?void 0:q.enabled)===!0,onCheckedChange:a=>{var n,A,D,te,le,ie,ne,re,oe;const x={...((n=s.style)==null?void 0:n.textShadow)||{},enabled:a,color:((D=(A=s.style)==null?void 0:A.textShadow)==null?void 0:D.color)||"rgba(0,0,0,0.5)",offsetX:((le=(te=s.style)==null?void 0:te.textShadow)==null?void 0:le.offsetX)||2,offsetY:((ne=(ie=s.style)==null?void 0:ie.textShadow)==null?void 0:ne.offsetY)||2,blur:((oe=(re=s.style)==null?void 0:re.textShadow)==null?void 0:oe.blur)||4};l("style",x,"textShadow")}})]})}),((c=(G=s.style)==null?void 0:G.textShadow)==null?void 0:c.enabled)&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{htmlFor:"textShadowColor",children:"لون الظل"}),e.jsx(Ae,{color:((M=(m=s.style)==null?void 0:m.textShadow)==null?void 0:M.color)||"rgba(0,0,0,0.5)",onChange:a=>{var n;const x={...((n=s.style)==null?void 0:n.textShadow)||{},color:a};l("style",x,"textShadow")},showAlpha:!0})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs(d,{htmlFor:"textShadowBlur",children:["تمويه الظل (",((Z=(E=s.style)==null?void 0:E.textShadow)==null?void 0:Z.blur)||4,"px)"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{id:"textShadowBlur",min:0,max:20,step:1,value:[((K=(_=s.style)==null?void 0:_.textShadow)==null?void 0:K.blur)||4],onValueChange:([a])=>{var n;const x={...((n=s.style)==null?void 0:n.textShadow)||{},blur:a};l("style",x,"textShadow")}}),e.jsx(p,{type:"number",value:((me=(V=s.style)==null?void 0:V.textShadow)==null?void 0:me.blur)||4,onChange:a=>{var n;const x={...((n=s.style)==null?void 0:n.textShadow)||{},blur:parseInt(a.target.value)};l("style",x,"textShadow")},className:"w-16",min:0,max:20})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{htmlFor:"textShadowOffset",children:"إزاحة الظل (بكسل)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(d,{htmlFor:"textShadowOffsetX",className:"text-xs",children:"أفقي"}),e.jsx(p,{id:"textShadowOffsetX",type:"number",value:((xe=(X=s.style)==null?void 0:X.textShadow)==null?void 0:xe.offsetX)||2,onChange:a=>{var n;const x={...((n=s.style)==null?void 0:n.textShadow)||{},offsetX:parseInt(a.target.value)};l("style",x,"textShadow")},min:-20,max:20})]}),e.jsxs("div",{children:[e.jsx(d,{htmlFor:"textShadowOffsetY",className:"text-xs",children:"عمودي"}),e.jsx(p,{id:"textShadowOffsetY",type:"number",value:((he=(ee=s.style)==null?void 0:ee.textShadow)==null?void 0:he.offsetY)||2,onChange:a=>{var n;const x={...((n=s.style)==null?void 0:n.textShadow)||{},offsetY:parseInt(a.target.value)};l("style",x,"textShadow")},min:-20,max:20})]})]})]})]})]})]})]})}),s.type==="image"&&e.jsx(e.Fragment,{children:e.jsxs(Qe,{type:"single",collapsible:!0,defaultValue:"image",children:[e.jsxs(Ie,{value:"image",children:[e.jsx(Fe,{children:"خصائص الصورة"}),e.jsxs(ze,{className:"space-y-4 pt-2",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsxs(d,{htmlFor:"imageMaxWidth",children:["الحد الأقصى للعرض (",((se=s.style)==null?void 0:se.imageMaxWidth)||200,"px)"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{id:"imageMaxWidth",min:50,max:800,step:10,value:[((ue=s.style)==null?void 0:ue.imageMaxWidth)||200],onValueChange:([a])=>l("style",a,"imageMaxWidth")}),e.jsx(p,{type:"number",value:((ge=s.style)==null?void 0:ge.imageMaxWidth)||200,onChange:a=>l("style",parseInt(a.target.value),"imageMaxWidth"),className:"w-16",min:50,max:800})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs(d,{htmlFor:"imageMaxHeight",children:["الحد الأقصى للارتفاع (",((pe=s.style)==null?void 0:pe.imageMaxHeight)||200,"px)"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{id:"imageMaxHeight",min:50,max:800,step:10,value:[((je=s.style)==null?void 0:je.imageMaxHeight)||200],onValueChange:([a])=>l("style",a,"imageMaxHeight")}),e.jsx(p,{type:"number",value:((fe=s.style)==null?void 0:fe.imageMaxHeight)||200,onChange:a=>l("style",parseInt(a.target.value),"imageMaxHeight"),className:"w-16",min:50,max:800})]})]}),e.jsx("div",{className:"grid gap-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(d,{htmlFor:"imageRounded",className:"flex-1",children:"حواف دائرية"}),e.jsx(O,{id:"imageRounded",checked:((ae=s.style)==null?void 0:ae.imageRounded)===!0,onCheckedChange:a=>l("style",a,"imageRounded")})]})}),e.jsx("div",{className:"grid gap-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(d,{htmlFor:"imageBorder",className:"flex-1",children:"إظهار الإطار"}),e.jsx(O,{id:"imageBorder",checked:((ye=s.style)==null?void 0:ye.imageBorder)===!0,onCheckedChange:a=>l("style",a,"imageBorder")})]})})]})]}),e.jsxs(Ie,{value:"imageShadow",children:[e.jsx(Fe,{children:"ظل الصورة"}),e.jsxs(ze,{className:"space-y-4 pt-2",children:[e.jsx("div",{className:"grid gap-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(d,{htmlFor:"imageShadowEnabled",className:"flex-1",children:"تفعيل ظل الصورة"}),e.jsx(O,{id:"imageShadowEnabled",checked:((r=(t=s.style)==null?void 0:t.imageShadow)==null?void 0:r.enabled)===!0,onCheckedChange:a=>{var n,A,D,te,le,ie,ne,re,oe;const x={...((n=s.style)==null?void 0:n.imageShadow)||{},enabled:a,color:((D=(A=s.style)==null?void 0:A.imageShadow)==null?void 0:D.color)||"rgba(0,0,0,0.3)",offsetX:((le=(te=s.style)==null?void 0:te.imageShadow)==null?void 0:le.offsetX)||4,offsetY:((ne=(ie=s.style)==null?void 0:ie.imageShadow)==null?void 0:ne.offsetY)||4,blur:((oe=(re=s.style)==null?void 0:re.imageShadow)==null?void 0:oe.blur)||8};l("style",x,"imageShadow")}})]})}),((j=(i=s.style)==null?void 0:i.imageShadow)==null?void 0:j.enabled)&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{htmlFor:"imageShadowColor",children:"لون الظل"}),e.jsx(Ae,{color:((v=(z=s.style)==null?void 0:z.imageShadow)==null?void 0:v.color)||"rgba(0,0,0,0.3)",onChange:a=>{var n;const x={...((n=s.style)==null?void 0:n.imageShadow)||{},color:a};l("style",x,"imageShadow")},showAlpha:!0})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs(d,{htmlFor:"imageShadowBlur",children:["تمويه الظل (",((Q=(B=s.style)==null?void 0:B.imageShadow)==null?void 0:Q.blur)||8,"px)"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{id:"imageShadowBlur",min:0,max:30,step:1,value:[((we=(ve=s.style)==null?void 0:ve.imageShadow)==null?void 0:we.blur)||8],onValueChange:([a])=>{var n;const x={...((n=s.style)==null?void 0:n.imageShadow)||{},blur:a};l("style",x,"imageShadow")}}),e.jsx(p,{type:"number",value:((be=(H=s.style)==null?void 0:H.imageShadow)==null?void 0:be.blur)||8,onChange:a=>{var n;const x={...((n=s.style)==null?void 0:n.imageShadow)||{},blur:parseInt(a.target.value)};l("style",x,"imageShadow")},className:"w-16",min:0,max:30})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{htmlFor:"imageShadowOffset",children:"إزاحة الظل (بكسل)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(d,{htmlFor:"imageShadowOffsetX",className:"text-xs",children:"أفقي"}),e.jsx(p,{id:"imageShadowOffsetX",type:"number",value:((J=(Ne=s.style)==null?void 0:Ne.imageShadow)==null?void 0:J.offsetX)||4,onChange:a=>{var n;const x={...((n=s.style)==null?void 0:n.imageShadow)||{},offsetX:parseInt(a.target.value)};l("style",x,"imageShadow")},min:-20,max:20})]}),e.jsxs("div",{children:[e.jsx(d,{htmlFor:"imageShadowOffsetY",className:"text-xs",children:"عمودي"}),e.jsx(p,{id:"imageShadowOffsetY",type:"number",value:((Xe=(Ve=s.style)==null?void 0:Ve.imageShadow)==null?void 0:Xe.offsetY)||4,onChange:a=>{var n;const x={...((n=s.style)==null?void 0:n.imageShadow)||{},offsetY:parseInt(a.target.value)};l("style",x,"imageShadow")},min:-20,max:20})]})]})]})]})]})]})]})})]}),e.jsxs(ce,{value:"position",className:"m-0 space-y-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{children:"الموضع (بكسل)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(d,{htmlFor:"positionX",className:"text-xs",children:"X (أفقي)"}),e.jsx(p,{id:"positionX",type:"number",value:Math.round((($e=s.position)==null?void 0:$e.x)||0),onChange:a=>{const x={...s.position,x:parseInt(a.target.value)};l("position",x)}})]}),e.jsxs("div",{children:[e.jsx(d,{htmlFor:"positionY",className:"text-xs",children:"Y (عمودي)"}),e.jsx(p,{id:"positionY",type:"number",value:Math.round(((Be=s.position)==null?void 0:Be.y)||0),onChange:a=>{const x={...s.position,y:parseInt(a.target.value)};l("position",x)}})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs(d,{htmlFor:"rotation",children:["الدوران (",s.rotation||0,"°)"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{id:"rotation",min:-180,max:180,step:1,value:[s.rotation||0],onValueChange:([a])=>l("rotation",a)}),e.jsx(p,{type:"number",value:s.rotation||0,onChange:a=>l("rotation",parseInt(a.target.value)),className:"w-16",min:-180,max:180})]})]}),e.jsx("div",{className:"grid gap-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(d,{htmlFor:"snapToGrid",className:"flex-1",children:"الالتصاق بالشبكة"}),e.jsx(O,{id:"snapToGrid",checked:((De=s.position)==null?void 0:De.snapToGrid)!==!1,onCheckedChange:a=>{const x={...s.position,snapToGrid:a};l("position",x)}})]})}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(d,{htmlFor:"locked",className:"flex-1",children:"قفل الموضع"}),e.jsx(O,{id:"locked",checked:s.locked===!0,onCheckedChange:a=>l("locked",a)})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"عند تفعيل هذا الخيار، لن يكون من الممكن سحب الحقل وتغيير موضعه في المحرر"})]})]})]})})})]})]}):e.jsxs(ke,{className:"h-full",children:[e.jsxs(Te,{children:[e.jsx(We,{children:"خصائص الحقل"}),e.jsx(Ee,{children:"اختر حقلاً لعرض وتعديل خصائصه"})]}),e.jsxs(Re,{className:"text-center text-muted-foreground py-12",children:[e.jsx(Ts,{className:"h-16 w-16 mx-auto mb-3 opacity-25"}),e.jsx("p",{children:"قم بالنقر على حقل في المحرر"}),e.jsx("p",{className:"text-sm mt-2",children:"أو"}),e.jsx("p",{className:"mt-2",children:"اختر حقلاً من قائمة الطبقات"})]})]})},Ae=({color:f,onChange:o,showAlpha:k=!1})=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-10 h-10 rounded-md border cursor-pointer flex-shrink-0",style:{backgroundColor:f},onClick:()=>{const s=document.createElement("input");s.type="color",s.value=f.startsWith("rgba")?Ms(f):f,s.addEventListener("input",u=>{const w=u.target;o(w.value)}),s.click()}}),e.jsx(p,{type:"text",value:f,onChange:s=>o(s.target.value),placeholder:"#000000 أو rgb(0,0,0)"})]});function Ms(f){const o=f.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([0-9.]+))?\)/);if(!o)return"#000000";const k=parseInt(o[1],10),s=parseInt(o[2],10),u=parseInt(o[3],10);return`#${k.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}${u.toString(16).padStart(2,"0")}`}const As=[{id:1,name:"name_field",label:"الاسم",type:"text",position:{x:400,y:200},style:{fontFamily:"Cairo",fontSize:24,fontWeight:"bold",color:"#000000",align:"center",maxWidth:300},zIndex:2,visible:!0,rotation:0},{id:2,name:"certificate_title",label:"شهادة تقدير",type:"text",position:{x:400,y:100},style:{fontFamily:"Cairo",fontSize:30,fontWeight:"bold",color:"#1e3a8a",align:"center",maxWidth:400},zIndex:3,visible:!0,rotation:0},{id:3,name:"date_field",label:"التاريخ",type:"text",position:{x:400,y:350},style:{fontFamily:"Cairo",fontSize:16,fontWeight:"normal",color:"#666666",align:"center",maxWidth:200},zIndex:1,visible:!0,rotation:0}],Rs="https://images.unsplash.com/photo-1579546929518-9e396f3cc809?w=1080&q=80";function oa(){const f=ns(),{templateId:o}=f,[,k]=rs(),[s,u]=h.useState(o?[]:As),[w,Y]=h.useState(null),[l,L]=h.useState(0),[S,T]=h.useState(!0),[W,P]=h.useState(o?"":Rs),{data:C,isLoading:I}=Oe({queryKey:["template",o],queryFn:async()=>o?await Le("GET",`/api/templates/${o}`):null,enabled:!!o}),{data:$,isLoading:F}=Oe({queryKey:["template-fields",o],queryFn:async()=>o?await Le("GET",`/api/admin/template-fields/${o}`):[],enabled:!!o});h.useEffect(()=>{if(C&&!I&&(C.imageUrl&&P(C.imageUrl),console.log("تم تحميل القالب:",C)),$&&!F){const c=$.map(m=>({id:m.id,name:m.name,label:m.label||m.name||"",type:m.type||"text",position:m.position||{x:200,y:200},style:m.style||{fontFamily:"Cairo",fontSize:24,fontWeight:"normal",color:"#000000",align:"center",maxWidth:300},zIndex:m.zIndex||1,visible:m.visible!==!1,rotation:m.rotation||0}));u(c),console.log("تم تحميل الحقول:",c)}},[C,$,I,F]);const{toast:R}=os();Ye.useMemo(()=>[{id:-1,name:"template_image",label:"صورة القالب",type:"template",zIndex:l,visible:S},...s].sort((m,M)=>(m.zIndex||0)-(M.zIndex||0)),[s,l,S]);const y=c=>{const m=s.length>0?Math.max(...s.map(E=>E.id)):0,M={id:m+1,name:c==="text"?`text_field_${m+1}`:`image_field_${m+1}`,label:c==="text"?"نص جديد":"صورة جديدة",type:c,position:{x:400,y:200},style:c==="text"?{fontFamily:"Cairo",fontSize:24,fontWeight:"normal",color:"#000000",align:"center",maxWidth:300}:{fontFamily:"Arial",fontSize:0,fontWeight:"normal",color:"#000000",align:"center",maxWidth:300,imageMaxWidth:150,imageMaxHeight:150},zIndex:Math.max(...s.map(E=>E.zIndex||0),0)+1,visible:!0,rotation:0};u([...s,M]),Y(M.id),R({title:"تم إضافة حقل جديد",description:`تم إضافة حقل ${c==="text"?"نصي":"صورة"} جديد`})},g=c=>{const m=document.createElement("a");m.download=`template-${Date.now()}.png`,m.href=c,document.body.appendChild(m),m.click(),document.body.removeChild(m),R({title:"تم تصدير الصورة",description:"تم تصدير الصورة بنجاح"})},b=ds({mutationFn:async()=>{if(!o)return null;const c=s.map(m=>({...m,templateId:parseInt(o)}));return await Le("PUT",`/api/admin/template-fields/${o}`,c)},onSuccess:()=>{R({title:"تم الحفظ بنجاح",description:"تم حفظ جميع تغييرات القالب"})},onError:c=>{console.error("خطأ في الحفظ:",c),R({title:"خطأ في الحفظ",description:"حدث خطأ أثناء حفظ بيانات القالب",variant:"destructive"})}}),q=Ye.useMemo(()=>w===null?null:w===-1?{id:-1,name:"template_image",label:"صورة القالب",type:"template",position:{x:0,y:0},zIndex:l,visible:S}:s.find(c=>c.id===w)||null,[w,s,l,S]),G=c=>{c.id===-1?(L(c.zIndex||0),T(c.visible!==!1)):u(s.map(m=>m.id===c.id?c:m))};return e.jsxs("div",{className:"template-editor-page p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(N,{variant:"outline",onClick:()=>k("/admin/templates"),children:[e.jsx(Fs,{className:"mr-2 h-4 w-4"}),"الرجوع للقوالب"]}),e.jsx("h1",{className:"text-2xl font-bold",children:I?"جاري التحميل...":C?C.titleAr||C.title:"محرر القوالب مع دعم الطبقات"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(N,{variant:"outline",onClick:()=>y("text"),children:[e.jsx(as,{className:"mr-2 h-4 w-4"}),"إضافة نص"]}),e.jsxs(N,{variant:"outline",onClick:()=>y("image"),children:[e.jsx(ts,{className:"mr-2 h-4 w-4"}),"إضافة صورة"]}),e.jsx(N,{variant:"default",onClick:()=>b.mutate(),disabled:b.isPending||!o,children:b.isPending?e.jsxs(e.Fragment,{children:[e.jsx(Pe,{className:"mr-2 h-4 w-4 animate-spin"}),"جاري الحفظ..."]}):e.jsxs(e.Fragment,{children:[e.jsx(zs,{className:"mr-2 h-4 w-4"}),"حفظ التغييرات"]})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-4",children:[e.jsx("div",{className:"lg:col-span-3",children:e.jsxs(es,{defaultValue:"layers",className:"h-full",children:[e.jsxs(ss,{className:"grid grid-cols-2 mb-4",children:[e.jsxs(de,{value:"layers",children:[e.jsx(ks,{className:"w-4 h-4 mr-2"}),"الطبقات"]}),e.jsxs(de,{value:"properties",children:[e.jsx(cs,{className:"w-4 h-4 mr-2"}),"الخصائص"]})]}),e.jsx(ce,{value:"layers",className:"h-[calc(100%-50px)]",children:e.jsx(Ge,{className:"h-full",children:e.jsx(Ns,{fields:s,hasTemplateImage:!0,templateImageZIndex:l,isTemplateImageVisible:S,onFieldsUpdate:u,onLayerClick:Y,activeLayerId:w,onTemplateImageUpdate:(c,m)=>{L(c),T(m)},onAddField:y})})}),e.jsx(ce,{value:"properties",className:"h-[calc(100%-50px)]",children:e.jsx(Ge,{className:"h-full",children:e.jsx(Ls,{field:q,onFieldUpdate:G,availableFonts:["Cairo","Tajawal","Arial","sans-serif","Verdana","Tahoma"]})})})]})}),e.jsx("div",{className:"lg:col-span-9",children:e.jsxs(ke,{className:"h-full flex flex-col",children:[e.jsxs(Te,{className:"pb-2",children:[e.jsx(We,{children:"معاينة القالب مع دعم الطبقات"}),e.jsx(Ee,{children:"يمكنك سحب العناصر لتغيير مواضعها، وتحريك طبقات أمام أو خلف صورة القالب"})]}),e.jsx(Re,{className:"flex-1 pb-0",children:I||F?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 space-y-4",children:[e.jsx(Pe,{className:"w-8 h-8 animate-spin text-primary"}),e.jsx("p",{children:"جاري تحميل بيانات القالب..."})]}):e.jsx("div",{className:"h-full",children:e.jsx(Es,{templateImage:W,fields:s,onFieldsChange:c=>u(c),selectedFieldId:w,onSelectedFieldChange:Y,onImageExport:g,templateImageLayer:l,isTemplateImageVisible:S,onTemplateImageLayerChange:L,onTemplateImageVisibilityChange:T,editorSettings:{gridEnabled:!0,snapToGrid:!0,gridSize:20,snapThreshold:10}})})}),e.jsx(ms,{className:"border-t mt-auto",children:e.jsxs("div",{className:"text-sm text-muted-foreground",children:[e.jsx("strong",{children:"طريقة الاستخدام:"})," انقر على حقل لتحديده، ثم يمكنك تعديل خصائصه في لوحة الخصائص. استخدم لوحة الطبقات لتغيير ترتيب العناصر ووضعها أمام أو خلف صورة القالب."]})})]})})]})]})}export{oa as default};
